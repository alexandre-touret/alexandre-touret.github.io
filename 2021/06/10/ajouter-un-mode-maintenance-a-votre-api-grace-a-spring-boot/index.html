<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Ajouter un mode « maintenance » à votre API grâce à Spring boot - Alexandre Touret's Blog</title><meta name=Description content="Alexandre Touret's Blog"><meta property="og:title" content="Ajouter un mode « maintenance » à votre API grâce à Spring boot">
<meta property="og:description" content="Quand vous avez une API, et a fortiori une application, il peut être parfois nécessaire de passer l&rsquo;application en mode « maintenance ».
Pour certaines applications il est parfois inutile de le traiter au niveau applicatif, car ça peut être pris géré par certaines couches de sécurité ou frontaux web par ex. (Apache HTTPD, WAF)
Kubernetes a introduit ( ou popularisé ) les notions de « probes » et plus particulièrement les livenessProbes et readinessProbes."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.touret.info/2021/06/10/ajouter-un-mode-maintenance-a-votre-api-grace-a-spring-boot/"><meta property="og:image" content="https://blog.touret.info/assets/images/2018/03/sc3a9lection_001.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-10T17:01:20+02:00"><meta property="article:modified_time" content="2023-03-02T18:52:03+01:00"><meta property="og:site_name" content="Alexandre Touret's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.touret.info/assets/images/2018/03/sc3a9lection_001.png"><meta name=twitter:title content="Ajouter un mode « maintenance » à votre API grâce à Spring boot"><meta name=twitter:description content="Quand vous avez une API, et a fortiori une application, il peut être parfois nécessaire de passer l&rsquo;application en mode « maintenance ».
Pour certaines applications il est parfois inutile de le traiter au niveau applicatif, car ça peut être pris géré par certaines couches de sécurité ou frontaux web par ex. (Apache HTTPD, WAF)
Kubernetes a introduit ( ou popularisé ) les notions de « probes » et plus particulièrement les livenessProbes et readinessProbes."><meta name=twitter:site content="@touret_alex"><meta name=application-name content="Alexandre Touret's Blog"><meta name=apple-mobile-web-app-title content="Alexandre Touret's Blog"><meta name=theme-color content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><meta name=twitter:creator content="@touret_alex"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://blog.touret.info/2021/06/10/ajouter-un-mode-maintenance-a-votre-api-grace-a-spring-boot/><link rel=prev href=https://blog.touret.info/2021/05/03/utiliser-gpg-dans-wsl2/><link rel=next href=https://blog.touret.info/2021/07/26/observabilite-et-circuit-breaker-avec-spring/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><meta name=google-site-verification content="7UnqNmvO-mjfMkRqKaaWRPTBxSylEVJXvAn8iTfc7SI"><meta name=msvalidate.01 content="F9655A4C8648E42154ECB4B4D6CF60A2"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Ajouter un mode « maintenance » à votre API grâce à Spring boot","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.touret.info/2021/06/10/ajouter-un-mode-maintenance-a-votre-api-grace-a-spring-boot/"},"image":["https://blog.touret.info/images/alexandre.touret.webp"],"genre":"posts","keywords":"actuator, observability, planetlibre, spring, springboot","wordcount":764,"url":"https://blog.touret.info/2021/06/10/ajouter-un-mode-maintenance-a-votre-api-grace-a-spring-boot/","datePublished":"2021-06-10T17:01:20+02:00","dateModified":"2023-03-02T18:52:03+01:00","license":"This work is licensed under a Creative Commons Attribution 4.0 International License.","publisher":{"@type":"Organization","name":"Alexandre Touret","logo":"https://blog.touret.info/images/alexandre.touret.webp"},"author":{"@type":"Person","name":"Alexandre Touret"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"||"auto"==="black"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Alexandre Touret's Blog"><span id=desktop-header-typeit class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/contact/>Contact </a><a class=menu-item href=/talks/>Talks </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i>
</span></span><a href=javascript:void(0); class="menu-item theme-select" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-desktop title="Switch Theme"><option value=light>Light</option><option value=dark>Dark</option><option value=black>Black</option><option value=auto>Auto</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Alexandre Touret's Blog"><span id=mobile-header-typeit class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/contact/ title>Contact</a><a class=menu-item href=/talks/ title>Talks</a><a class=menu-item href=/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-select" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-mobile title="Switch Theme"><option value=light>Light</option><option value=dark>Dark</option><option value=black>Black</option><option value=auto>Auto</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#stack-utilisée>Stack utilisée</a></li><li><a href=#configuration-de-spring-actuator>Configuration de Spring Actuator</a></li><li><a href=#comment-récupérer-le-statut-des-probes>Comment récupérer le statut des probes?</a></li><li><a href=#filtre-les-appels-et-indiquer-que-lapplication-est-en-maintenance>Filtre les appels et indiquer que l&rsquo;application est en maintenance</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Ajouter un mode « maintenance » à votre API grâce à Spring boot</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class="author fas fa-user-circle fa-fw"></span><a href=https://blog.touret.info title=Author target=_blank rel="noopener noreferrer author" class=author>Alexandre Touret</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-06-10>2021-06-10</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2023-03-02>2023-03-02</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;764 words&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;4 minutes&nbsp;</div></div><div class=featured-image><img loading=eager src=/assets/images/2021/06/pexels-photo-257736.jpeg srcset="/assets/images/2021/06/pexels-photo-257736.jpeg, /assets/images/2021/06/pexels-photo-257736.jpeg 1.5x, /assets/images/2021/06/pexels-photo-257736.jpeg 2x" title=/assets/images/2021/06/pexels-photo-257736.jpeg></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#stack-utilisée>Stack utilisée</a></li><li><a href=#configuration-de-spring-actuator>Configuration de Spring Actuator</a></li><li><a href=#comment-récupérer-le-statut-des-probes>Comment récupérer le statut des probes?</a></li><li><a href=#filtre-les-appels-et-indiquer-que-lapplication-est-en-maintenance>Filtre les appels et indiquer que l&rsquo;application est en maintenance</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div><div class=content id=content><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fwnote"></i>Note<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>This article was last updated on <span class=timeago datetime=2023-03-02T18:52:03 title="March 2, 2023">2023-03-02</span>, the content may be out of date.</div></div></div><p>Quand vous avez une API, et a fortiori une application, il peut être parfois nécessaire de passer l&rsquo;application en mode « maintenance ».<br>Pour certaines applications il est parfois inutile de le traiter au niveau applicatif, car ça peut être pris géré par certaines couches de sécurité ou frontaux web par ex. (<a href=https://httpd.apache.org/ target=_blank rel="noopener noreferrer">Apache HTTPD</a>, <a href=https://fr.wikipedia.org/wiki/Web_application_firewall target=_blank rel="noopener noreferrer">WAF</a>)</p><p><a href=https://kubernetes.io/fr/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/ target=_blank rel="noopener noreferrer">Kubernetes a introduit ( ou popularisé ) les notions de « probes »</a> et plus particulièrement les <a href=https://kubernetes.io/fr/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/ target=_blank rel="noopener noreferrer">livenessProbes</a> et <a href=https://kubernetes.io/fr/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/ target=_blank rel="noopener noreferrer">readinessProbes</a>.<br>Le premier nous indique si l&rsquo;application est en état de fonctionnement, le second nous permet de savoir si cette dernière est apte à recevoir des requêtes (ex. lors d&rsquo;un démarrage).</p><p>Je vais exposer dans cet article comment utiliser au mieux ces probes et <a href=https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/ target=_blank rel="noopener noreferrer">les APIs SPRING</a> pour intégrer dans une API un mode « maintenance »</p><h2 id=stack-utilisée class=headerLink><a href=#stack-utilis%c3%a9e class=header-mark></a>1 Stack utilisée</h2><p>Dans l&rsquo;exemple que j&rsquo;ai développé, j&rsquo;ai pu utiliser les briques suivantes:</p><ul><li>OpenJDK 11.0.10</li><li>Spring Boot 2.5.0 (web, actuator)</li><li>Maven 3.8.1</li></ul><p>Bref, rien de neuf à l&rsquo;horizon 🙂</p><h2 id=configuration-de-spring-actuator class=headerLink><a href=#configuration-de-spring-actuator class=header-mark></a>2 Configuration de Spring Actuator</h2><p>Pour activer les différents probes, vous devez activer <a href=https://docs.spring.io/spring-boot/docs/2.4.0/actuator-api/ target=_blank rel="noopener noreferrer">Actuator</a>.</p><p>Dans le fichier pom.xml, vous devez ajouter le starter correspondant:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>Puis vous devez déclarer ces differentes <a href=https://github.com/alexandre-touret/maintenance-mode/blob/main/src/main/resources/application.properties target=_blank rel="noopener noreferrer">propriétés</a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>management.endpoints.enabled-by-default</span><span class=o>=</span><span class=s>true</span>
</span></span><span class=line><span class=cl><span class=na>management.health.livenessstate.enabled</span><span class=o>=</span><span class=s>true</span>
</span></span><span class=line><span class=cl><span class=na>management.health.readinessstate.enabled</span><span class=o>=</span><span class=s>true</span>
</span></span><span class=line><span class=cl><span class=na>management.endpoint.health.show-details</span><span class=o>=</span><span class=s>always</span>
</span></span><span class=line><span class=cl><span class=na>management.endpoint.health.probes.enabled</span><span class=o>=</span><span class=s>true</span>
</span></span><span class=line><span class=cl><span class=na>management.endpoint.health.enabled</span><span class=o>=</span><span class=s>true</span>
</span></span></code></pre></td></tr></table></div></div><p>Après avoir redémarré votre application, vous pourrez connaître son statut grâce à un appel HTTP</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -s http://localhost:8080/actuator/health/readiness 
</span></span></code></pre></td></tr></table></div></div><h2 id=comment-récupérer-le-statut-des-probes class=headerLink><a href=#comment-r%c3%a9cup%c3%a9rer-le-statut-des-probes class=header-mark></a>3 Comment récupérer le statut des probes?</h2><p>Avec Spring, vous pouvez modifier les différents statuts avec les classes <a href=https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/context/ApplicationEventPublisher.html target=_blank rel="noopener noreferrer">ApplicationEventPublisher</a> et <a href=https://docs.spring.io/spring-boot/docs/2.4.4/api/org/springframework/boot/availability/ApplicationAvailability.html target=_blank rel="noopener noreferrer">ApplicationAvailability</a>.</p><p>Par exemple, pour connaître le statut <a href=https://docs.spring.io/spring-boot/docs/2.5.0-SNAPSHOT/api/org/springframework/boot/availability/ReadinessState.html target=_blank rel="noopener noreferrer">Readiness</a> vous pouvez exécuter le code suivant:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ApiResponses</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nd>@ApiResponse</span><span class=p>(</span><span class=n>responseCode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;200&#34;</span><span class=p>,</span><span class=w> </span><span class=n>description</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;Checks if the application in under maitenance&#34;</span><span class=p>)})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nd>@GetMapping</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=n>ResponseEntity</span><span class=o>&lt;</span><span class=n>MaintenanceDTO</span><span class=o>&gt;</span><span class=w> </span><span class=nf>retreiveInMaintenance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>var</span><span class=w> </span><span class=n>lastChangeEvent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>availability</span><span class=p>.</span><span class=na>getLastChangeEvent</span><span class=p>(</span><span class=n>ReadinessState</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ResponseEntity</span><span class=p>.</span><span class=na>ok</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>MaintenanceDTO</span><span class=p>(</span><span class=n>lastChangeEvent</span><span class=p>.</span><span class=na>getState</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>ReadinessState</span><span class=p>.</span><span class=na>REFUSING_TRAFFIC</span><span class=p>),</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>(</span><span class=n>lastChangeEvent</span><span class=p>.</span><span class=na>getTimestamp</span><span class=p>())));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Et la modification ?</p><p>Grâce à la même API, on peut également modifier ce statut dans via du code:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ApiResponses</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ApiResponse</span><span class=p>(</span><span class=n>responseCode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;204&#34;</span><span class=p>,</span><span class=w> </span><span class=n>description</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;Put the app under maitenance&#34;</span><span class=p>)})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@PutMapping</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>ResponseEntity</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span><span class=w> </span><span class=nf>initInMaintenance</span><span class=p>(</span><span class=nd>@NotNull</span><span class=w> </span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>inMaintenance</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AvailabilityChangeEvent</span><span class=p>.</span><span class=na>publish</span><span class=p>(</span><span class=n>eventPublisher</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>Boolean</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>inMaintenance</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>ReadinessState</span><span class=p>.</span><span class=na>REFUSING_TRAFFIC</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>ReadinessState</span><span class=p>.</span><span class=na>ACCEPTING_TRAFFIC</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ResponseEntity</span><span class=p>.</span><span class=na>noContent</span><span class=p>().</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=filtre-les-appels-et-indiquer-que-lapplication-est-en-maintenance class=headerLink><a href=#filtre-les-appels-et-indiquer-que-lapplication-est-en-maintenance class=header-mark></a>4 Filtre les appels et indiquer que l&rsquo;application est en maintenance</h2><p>Maintenant qu&rsquo;on a codé les mécanismes de récupération du statut de l&rsquo;application et de la mise en maintenance, on peut ajouter le mécanisme permettant de traiter ou non les appels entrants.<br>Pour ça on va utiliser un <a href=http://blog.paumard.org/cours/servlet/chap04-filtre-mise-en-place.html target=_blank rel="noopener noreferrer">bon vieux filtre servlet</a>.</p><p>Ce dernier aura la tâche de laisser passer les requêtes entrantes si l&rsquo;application n&rsquo;est pas en maintenance et de déclencher une <a href=https://github.com/alexandre-touret/maintenance-mode/blob/main/src/main/java/info/touret/spring/maintenancemode/exception/MaintenanceException.java target=_blank rel="noopener noreferrer">MaintenanceException</a> le cas échéant qui sera traité par <a href=https://github.com/alexandre-touret/maintenance-mode/blob/main/src/main/java/info/touret/spring/maintenancemode/GlobalExceptionHandler.java target=_blank rel="noopener noreferrer">la gestion d&rsquo;erreur globale de l&rsquo;application</a> ( traité via un <a href=https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/bind/annotation/RestControllerAdvice.html target=_blank rel="noopener noreferrer">@RestControllerAdvice</a>).</p><p>Pour que l&rsquo;exception soit bien traitée par ce mécanisme, il faut le déclencher via le <a href=https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/servlet/HandlerExceptionResolver.html target=_blank rel="noopener noreferrer">HandlerExceptionResolver</a>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CheckMaintenanceFilter</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Filter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Logger</span><span class=w> </span><span class=n>LOGGER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LoggerFactory</span><span class=p>.</span><span class=na>getLogger</span><span class=p>(</span><span class=n>CheckMaintenanceFilter</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ApplicationAvailability</span><span class=w> </span><span class=n>availability</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Qualifier</span><span class=p>(</span><span class=s>&#34;handlerExceptionResolver&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>HandlerExceptionResolver</span><span class=w> </span><span class=n>exceptionHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Checks if the application is under maintenance. If it is and if the requested URI is not &#39;/api/maintenance&#39;, it throws a &lt;code&gt;MaintenanceException&lt;/code&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param request
</span></span></span><span class=line><span class=cl><span class=cm>     * @param response
</span></span></span><span class=line><span class=cl><span class=cm>     * @param chain
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws IOException
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws ServletException
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws info.touret.spring.maintenancemode.exception.MaintenanceException the application is under maintenance
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doFilter</span><span class=p>(</span><span class=n>ServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>ServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>FilterChain</span><span class=w> </span><span class=n>chain</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>ServletException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>availability</span><span class=p>.</span><span class=na>getReadinessState</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>ReadinessState</span><span class=p>.</span><span class=na>REFUSING_TRAFFIC</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>!</span><span class=p>((</span><span class=n>HttpServletRequest</span><span class=p>)</span><span class=w> </span><span class=n>request</span><span class=p>).</span><span class=na>getRequestURI</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>API_MAINTENANCE_URI</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;Message handled during maintenance [{}]&#34;</span><span class=p>,</span><span class=w> </span><span class=p>((</span><span class=n>HttpServletRequest</span><span class=p>)</span><span class=w> </span><span class=n>request</span><span class=p>).</span><span class=na>getRequestURI</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>exceptionHandler</span><span class=p>.</span><span class=na>resolveException</span><span class=p>((</span><span class=n>HttpServletRequest</span><span class=p>)</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>HttpServletResponse</span><span class=p>)</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MaintenanceException</span><span class=p>(</span><span class=s>&#34;Service currently in maintenance&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>chain</span><span class=p>.</span><span class=na>doFilter</span><span class=p>(</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>response</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Enfin, voici la gestion des erreurs de l&rsquo;API:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestControllerAdvice</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>GlobalExceptionHandler</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Indicates that the application is on maintenance
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ResponseStatus</span><span class=p>(</span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>I_AM_A_TEAPOT</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ExceptionHandler</span><span class=p>(</span><span class=n>MaintenanceException</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>APIError</span><span class=w> </span><span class=nf>maintenance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>APIError</span><span class=p>(</span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>I_AM_A_TEAPOT</span><span class=p>.</span><span class=na>value</span><span class=p>(),</span><span class=s>&#34;Service currently in maintenance&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Any other exception
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ResponseStatus</span><span class=p>(</span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>INTERNAL_SERVER_ERROR</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ExceptionHandler</span><span class=p>({</span><span class=n>RuntimeException</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Exception</span><span class=p>.</span><span class=na>class</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>APIError</span><span class=w> </span><span class=nf>anyException</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>APIError</span><span class=p>(</span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>INTERNAL_SERVER_ERROR</span><span class=p>.</span><span class=na>value</span><span class=p>(),</span><span class=s>&#34;An unexpected server error occured&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=conclusion class=headerLink><a href=#conclusion class=header-mark></a>5 Conclusion</h2><p>On a pu voir comment intéragir simplement avec les APIS SPRING pour gérer le statut de l&rsquo;application pour répondre à cette question :Est-elle disponible ou non?<br>Bien évidemment, selon le contexte, il conviendra d&rsquo;ajouter un peu de sécurité pour que cette API ne soit pas disponible à tout le monde 🙂</p><p>Le code exposé ici est disponible sur <a href=https://github.com/alexandre-touret/maintenance-mode/ target=_blank rel="noopener noreferrer">Github</a>. Le <a href=https://github.com/alexandre-touret/maintenance-mode/blob/main/README.md target=_blank rel="noopener noreferrer">Readme</a> est suffisamment détaillé pour que vous puissiez tester et réutiliser le code.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-03-02&nbsp;<a class=git-hash href=https://github.com/alexandre-touret/alexandre-touret.github.io/commit/3ca23e90dd13f01a99e313e69e6880790fa40161 target=_blank title="commit by Alexandre Touret(alexandre-touret@users.noreply.github.com) 3ca23e90dd13f01a99e313e69e6880790fa40161: twitter card images" rel="noopener noreferrer">
<i class="fas fa-hashtag fa-fw"></i>3ca23e9</a></span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-mardown href=/2021/06/10/ajouter-un-mode-maintenance-a-votre-api-grace-a-spring-boot/index.md target=_blank rel="noopener noreferrer">Read markdown</a>
</span><span>|&nbsp;<a class=link-to-source href=https://github.com/alexandre-touret/alexandre-touret.github.io/blob/main/exampleSite/content/posts/ajouter-un-mode-maintenance-a-votre-api-grace-a-spring-boot.md target=_blank rel="noopener noreferrer">View source</a>
</span><span>|&nbsp;<a class=link-to-report href="https://github.com/alexandre-touret/alexandre-touret.github.io/issues/new?title=[bug]%20Ajouter+un+mode+%C2%AB%C2%A0maintenance%C2%A0%C2%BB+%C3%A0+votre+API+gr%C3%A2ce+%C3%A0+Spring+boot&body=|Field|Value|%0A|-|-|%0A|Title|Ajouter+un+mode+%C2%AB%C2%A0maintenance%C2%A0%C2%BB+%C3%A0+votre+API+gr%C3%A2ce+%C3%A0+Spring+boot|%0A|Url|https://blog.touret.info/2021/06/10/ajouter-un-mode-maintenance-a-votre-api-grace-a-spring-boot/|%0A|Filename|https://github.com/HEIGE-PCloud/DoIt/blob/main/exampleSite/content/posts/ajouter-un-mode-maintenance-a-votre-api-grace-a-spring-boot.md|" target=_blank rel="noopener noreferrer">Report issue</a></span></div><div class=post-info-share></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/actuator/>Actuator</a>,&nbsp;<a href=/tags/observability/>Observability</a>,&nbsp;<a href=/tags/planetlibre/>Planetlibre</a>,&nbsp;<a href=/tags/spring/>Spring</a>,&nbsp;<a href=/tags/springboot/>Springboot</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/2021/05/03/utiliser-gpg-dans-wsl2/ class=prev rel=prev title="Utiliser GPG dans WSL2"><i class="fas fa-angle-left fa-fw"></i>Utiliser GPG dans WSL2</a>
<a href=/2021/07/26/observabilite-et-circuit-breaker-avec-spring/ class=next rel=next title="Observabilité et Circuit Breaker avec Spring">Observabilité et Circuit Breaker avec Spring<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.124.1">Hugo</a>&nbsp;|&nbsp;Theme - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.4.0"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://blog.touret.info target=_blank rel="noopener noreferrer">Alexandre Touret</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by/4.0/ target=_blank>CC BY 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"alexandre-touret/alexandre-touret.github.io"}},data:{"desktop-header-typeit":"blog.touret.info","mobile-header-typeit":"blog.touret.info"},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!0,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"No results found",snippetLength:300,threshold:.1,type:"fuse",useExtendedSearch:!1},table:{sort:!0},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},duration:-1,speed:100}}</script><script type=text/javascript src=/lib/tablesort/tablesort.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/typeit/typeit.min.js></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=/js/utterances.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F1EK89MHJD",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-F1EK89MHJD" async></script></div></body></html>