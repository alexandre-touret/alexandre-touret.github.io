<!doctype html><html lang=fr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Ajouter un mode « maintenance » à votre API grâce à Spring boot - Alexandre Touret's Blog</title><meta name=Description content="Architecte logiciel, développeur, bidouilleur (dans le désordre)"><meta property="og:title" content="Ajouter un mode « maintenance » à votre API grâce à Spring boot"><meta property="og:description" content="Quand vous avez une API, et a fortiori une application, il peut être parfois nécessaire de passer l&rsquo;application en mode « maintenance ».
Pour certaines applications il est parfois inutile de le traiter au niveau applicatif, car ça peut être pris géré par certaines couches de sécurité ou frontaux web par ex. (Apache HTTPD, WAF)
Kubernetes a introduit ( ou popularisé ) les notions de « probes » et plus particulièrement les livenessProbes et readinessProbes."><meta property="og:type" content="article"><meta property="og:url" content="/2021/06/10/ajouter-un-mode-maintenance-a-votre-api-grace-a-spring-boot/"><meta property="og:image" content="/assets/images/2018/03/sc3a9lection_001.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-10T17:01:20+02:00"><meta property="article:modified_time" content="2023-03-02T18:52:03+01:00"><meta property="og:site_name" content="blog.touret.info"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/assets/images/2018/03/sc3a9lection_001.png"><meta name=twitter:title content="Ajouter un mode « maintenance » à votre API grâce à Spring boot"><meta name=twitter:description content="Quand vous avez une API, et a fortiori une application, il peut être parfois nécessaire de passer l&rsquo;application en mode « maintenance ».
Pour certaines applications il est parfois inutile de le traiter au niveau applicatif, car ça peut être pris géré par certaines couches de sécurité ou frontaux web par ex. (Apache HTTPD, WAF)
Kubernetes a introduit ( ou popularisé ) les notions de « probes » et plus particulièrement les livenessProbes et readinessProbes."><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=canonical href=/2021/06/10/ajouter-un-mode-maintenance-a-votre-api-grace-a-spring-boot/><link rel=prev href=/2021/05/03/utiliser-gpg-dans-wsl2/><link rel=next href=/2021/07/26/observabilite-et-circuit-breaker-avec-spring/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><meta name=google-site-verification content="7UnqNmvO-mjfMkRqKaaWRPTBxSylEVJXvAn8iTfc7SI"><meta name=msvalidate.01 content="F9655A4C8648E42154ECB4B4D6CF60A2"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Ajouter un mode « maintenance » à votre API grâce à Spring boot","inLanguage":"fr","mainEntityOfPage":{"@type":"WebPage","@id":"\/2021\/06\/10\/ajouter-un-mode-maintenance-a-votre-api-grace-a-spring-boot\/"},"image":["\/images\/alexandre-touret.webp"],"genre":"posts","keywords":"actuator, observability, planetlibre, spring, springboot","wordcount":764,"url":"\/2021\/06\/10\/ajouter-un-mode-maintenance-a-votre-api-grace-a-spring-boot\/","datePublished":"2021-06-10T17:01:20+02:00","dateModified":"2023-03-02T18:52:03+01:00","license":"This work is licensed under a Creative Commons Attribution 4.0 International License.","publisher":{"@type":"Organization","name":"Alexandre Touret","logo":"\/images\/alexandre-touret.webp"},"author":{"@type":"Person","name":"Alexandre Touret"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Alexandre Touret's Blog">blog.touret.info</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/ title=Articles>Articles </a><a class=menu-item href=/contact/>Contact </a><a class=menu-item href=/talks/ title=Talks>Conférences </a><a class=menu-item href=/a-propos/ title="À propos">À propos </a><a class=menu-item href=/https:/blog.touret.info/index.xml><i class='fa fa-rss-square fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Rechercher des titres, des contenus..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Chercher><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clair><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Changer de Thème"><i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="menu-item language" title="Choisir la langue"><i class="fa fa-globe" aria-hidden=true></i>
<select class=language-select id=language-select-desktop onchange="location=this.value"><option value=/2021/06/10/ajouter-un-mode-maintenance-a-votre-api-grace-a-spring-boot/ selected>Français</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Alexandre Touret's Blog">blog.touret.info</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Rechercher des titres, des contenus..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Chercher><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clair><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Annuler</a></div><a class=menu-item href=/posts/ title=Articles>Articles</a><a class=menu-item href=/contact/ title>Contact</a><a class=menu-item href=/talks/ title=Talks>Conférences</a><a class=menu-item href=/a-propos/ title="À propos">À propos</a><a class=menu-item href=/https:/blog.touret.info/index.xml title><i class='fa fa-rss-square fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Changer de Thème">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class=menu-item title="Choisir la langue"><i class="fa fa-globe fa-fw" aria-hidden=true></i>
<select class=language-select onchange="location=this.value"><option value=/2021/06/10/ajouter-un-mode-maintenance-a-votre-api-grace-a-spring-boot/ selected>Français</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contenu</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Ajouter un mode « maintenance » à votre API grâce à Spring boot</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://blog.touret.info title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Alexandre Touret</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2021-06-10>2021-06-10</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;764 mots&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;4 minutes&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/assets/images/2021/06/pexels-photo-257736.jpeg data-srcset="/assets/images/2021/06/pexels-photo-257736.jpeg, /assets/images/2021/06/pexels-photo-257736.jpeg 1.5x, /assets/images/2021/06/pexels-photo-257736.jpeg 2x" data-sizes=auto alt=/assets/images/2021/06/pexels-photo-257736.jpeg title=/assets/images/2021/06/pexels-photo-257736.jpeg></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contenu</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#stack-utilisée>Stack utilisée</a></li><li><a href=#configuration-de-spring-actuator>Configuration de Spring Actuator</a></li><li><a href=#comment-récupérer-le-statut-des-probes>Comment récupérer le statut des probes?</a></li><li><a href=#filtre-les-appels-et-indiquer-que-lapplication-est-en-maintenance>Filtre les appels et indiquer que l&rsquo;application est en maintenance</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div><div class=content id=content><p>Quand vous avez une API, et a fortiori une application, il peut être parfois nécessaire de passer l&rsquo;application en mode « maintenance ».<br>Pour certaines applications il est parfois inutile de le traiter au niveau applicatif, car ça peut être pris géré par certaines couches de sécurité ou frontaux web par ex. (<a href=https://httpd.apache.org/ target=_blank rel="noopener noreffer">Apache HTTPD</a>, <a href=https://fr.wikipedia.org/wiki/Web_application_firewall target=_blank rel="noopener noreffer">WAF</a>)</p><p><a href=https://kubernetes.io/fr/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/ target=_blank rel="noopener noreffer">Kubernetes a introduit ( ou popularisé ) les notions de « probes »</a> et plus particulièrement les <a href=https://kubernetes.io/fr/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/ target=_blank rel="noopener noreffer">livenessProbes</a> et <a href=https://kubernetes.io/fr/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/ target=_blank rel="noopener noreffer">readinessProbes</a>.<br>Le premier nous indique si l&rsquo;application est en état de fonctionnement, le second nous permet de savoir si cette dernière est apte à recevoir des requêtes (ex. lors d&rsquo;un démarrage).</p><p>Je vais exposer dans cet article comment utiliser au mieux ces probes et <a href=https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/ target=_blank rel="noopener noreffer">les APIs SPRING</a> pour intégrer dans une API un mode « maintenance »</p><h2 id=stack-utilisée>Stack utilisée</h2><p>Dans l&rsquo;exemple que j&rsquo;ai développé, j&rsquo;ai pu utiliser les briques suivantes:</p><ul><li>OpenJDK 11.0.10</li><li>Spring Boot 2.5.0 (web, actuator)</li><li>Maven 3.8.1</li></ul><p>Bref, rien de neuf à l&rsquo;horizon 🙂</p><h2 id=configuration-de-spring-actuator>Configuration de Spring Actuator</h2><p>Pour activer les différents probes, vous devez activer <a href=https://docs.spring.io/spring-boot/docs/2.4.0/actuator-api/ target=_blank rel="noopener noreffer">Actuator</a>.</p><p>Dans le fichier pom.xml, vous devez ajouter le starter correspondant:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>Puis vous devez déclarer ces differentes <a href=https://github.com/alexandre-touret/maintenance-mode/blob/main/src/main/resources/application.properties target=_blank rel="noopener noreffer">propriétés</a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>management.endpoints.enabled-by-default</span><span class=o>=</span><span class=s>true</span>
</span></span><span class=line><span class=cl><span class=na>management.health.livenessstate.enabled</span><span class=o>=</span><span class=s>true</span>
</span></span><span class=line><span class=cl><span class=na>management.health.readinessstate.enabled</span><span class=o>=</span><span class=s>true</span>
</span></span><span class=line><span class=cl><span class=na>management.endpoint.health.show-details</span><span class=o>=</span><span class=s>always</span>
</span></span><span class=line><span class=cl><span class=na>management.endpoint.health.probes.enabled</span><span class=o>=</span><span class=s>true</span>
</span></span><span class=line><span class=cl><span class=na>management.endpoint.health.enabled</span><span class=o>=</span><span class=s>true</span>
</span></span></code></pre></td></tr></table></div></div><p>Après avoir redémarré votre application, vous pourrez connaître son statut grâce à un appel HTTP</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -s http://localhost:8080/actuator/health/readiness 
</span></span></code></pre></td></tr></table></div></div><h2 id=comment-récupérer-le-statut-des-probes>Comment récupérer le statut des probes?</h2><p>Avec Spring, vous pouvez modifier les différents statuts avec les classes <a href=https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/context/ApplicationEventPublisher.html target=_blank rel="noopener noreffer">ApplicationEventPublisher</a> et <a href=https://docs.spring.io/spring-boot/docs/2.4.4/api/org/springframework/boot/availability/ApplicationAvailability.html target=_blank rel="noopener noreffer">ApplicationAvailability</a>.</p><p>Par exemple, pour connaître le statut <a href=https://docs.spring.io/spring-boot/docs/2.5.0-SNAPSHOT/api/org/springframework/boot/availability/ReadinessState.html target=_blank rel="noopener noreffer">Readiness</a> vous pouvez exécuter le code suivant:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ApiResponses</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl> <span class=nd>@ApiResponse</span><span class=o>(</span><span class=n>responseCode</span> <span class=o>=</span> <span class=s>&#34;200&#34;</span><span class=o>,</span> <span class=n>description</span> <span class=o>=</span> <span class=s>&#34;Checks if the application in under maitenance&#34;</span><span class=o>)})</span>
</span></span><span class=line><span class=cl> <span class=nd>@GetMapping</span>
</span></span><span class=line><span class=cl> <span class=kd>public</span> <span class=n>ResponseEntity</span><span class=o>&lt;</span><span class=n>MaintenanceDTO</span><span class=o>&gt;</span> <span class=nf>retreiveInMaintenance</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>var</span> <span class=n>lastChangeEvent</span> <span class=o>=</span> <span class=n>availability</span><span class=o>.</span><span class=na>getLastChangeEvent</span><span class=o>(</span><span class=n>ReadinessState</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ResponseEntity</span><span class=o>.</span><span class=na>ok</span><span class=o>(</span><span class=k>new</span> <span class=n>MaintenanceDTO</span><span class=o>(</span><span class=n>lastChangeEvent</span><span class=o>.</span><span class=na>getState</span><span class=o>().</span><span class=na>equals</span><span class=o>(</span><span class=n>ReadinessState</span><span class=o>.</span><span class=na>REFUSING_TRAFFIC</span><span class=o>),</span> <span class=k>new</span> <span class=n>Date</span><span class=o>(</span><span class=n>lastChangeEvent</span><span class=o>.</span><span class=na>getTimestamp</span><span class=o>())));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Et la modification ?</p><p>Grâce à la même API, on peut également modifier ce statut dans via du code:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ApiResponses</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl><span class=nd>@ApiResponse</span><span class=o>(</span><span class=n>responseCode</span> <span class=o>=</span> <span class=s>&#34;204&#34;</span><span class=o>,</span> <span class=n>description</span> <span class=o>=</span> <span class=s>&#34;Put the app under maitenance&#34;</span><span class=o>)})</span>
</span></span><span class=line><span class=cl><span class=nd>@PutMapping</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>ResponseEntity</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span> <span class=nf>initInMaintenance</span><span class=o>(</span><span class=nd>@NotNull</span> <span class=nd>@RequestBody</span> <span class=n>String</span> <span class=n>inMaintenance</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>AvailabilityChangeEvent</span><span class=o>.</span><span class=na>publish</span><span class=o>(</span><span class=n>eventPublisher</span><span class=o>,</span> <span class=k>this</span><span class=o>,</span> <span class=n>Boolean</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>inMaintenance</span><span class=o>)</span> <span class=o>?</span> <span class=n>ReadinessState</span><span class=o>.</span><span class=na>REFUSING_TRAFFIC</span> <span class=o>:</span> <span class=n>ReadinessState</span><span class=o>.</span><span class=na>ACCEPTING_TRAFFIC</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ResponseEntity</span><span class=o>.</span><span class=na>noContent</span><span class=o>().</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=filtre-les-appels-et-indiquer-que-lapplication-est-en-maintenance>Filtre les appels et indiquer que l&rsquo;application est en maintenance</h2><p>Maintenant qu&rsquo;on a codé les mécanismes de récupération du statut de l&rsquo;application et de la mise en maintenance, on peut ajouter le mécanisme permettant de traiter ou non les appels entrants.<br>Pour ça on va utiliser un <a href=http://blog.paumard.org/cours/servlet/chap04-filtre-mise-en-place.html target=_blank rel="noopener noreffer">bon vieux filtre servlet</a>.</p><p>Ce dernier aura la tâche de laisser passer les requêtes entrantes si l&rsquo;application n&rsquo;est pas en maintenance et de déclencher une <a href=https://github.com/alexandre-touret/maintenance-mode/blob/main/src/main/java/info/touret/spring/maintenancemode/exception/MaintenanceException.java target=_blank rel="noopener noreffer">MaintenanceException</a> le cas échéant qui sera traité par <a href=https://github.com/alexandre-touret/maintenance-mode/blob/main/src/main/java/info/touret/spring/maintenancemode/GlobalExceptionHandler.java target=_blank rel="noopener noreffer">la gestion d&rsquo;erreur globale de l&rsquo;application</a> ( traité via un <a href=https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/bind/annotation/RestControllerAdvice.html target=_blank rel="noopener noreffer">@RestControllerAdvice</a>).</p><p>Pour que l&rsquo;exception soit bien traitée par ce mécanisme, il faut le déclencher via le <a href=https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/servlet/HandlerExceptionResolver.html target=_blank rel="noopener noreffer">HandlerExceptionResolver</a>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>CheckMaintenanceFilter</span> <span class=kd>implements</span> <span class=n>Filter</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=kd>static</span> <span class=n>Logger</span> <span class=n>LOGGER</span> <span class=o>=</span> <span class=n>LoggerFactory</span><span class=o>.</span><span class=na>getLogger</span><span class=o>(</span><span class=n>CheckMaintenanceFilter</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>ApplicationAvailability</span> <span class=n>availability</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Qualifier</span><span class=o>(</span><span class=s>&#34;handlerExceptionResolver&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>HandlerExceptionResolver</span> <span class=n>exceptionHandler</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Checks if the application is under maintenance. If it is and if the requested URI is not &#39;/api/maintenance&#39;, it throws a &lt;code&gt;MaintenanceException&lt;/code&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param request
</span></span></span><span class=line><span class=cl><span class=cm>     * @param response
</span></span></span><span class=line><span class=cl><span class=cm>     * @param chain
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws IOException
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws ServletException
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws info.touret.spring.maintenancemode.exception.MaintenanceException the application is under maintenance
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>doFilter</span><span class=o>(</span><span class=n>ServletRequest</span> <span class=n>request</span><span class=o>,</span> <span class=n>ServletResponse</span> <span class=n>response</span><span class=o>,</span> <span class=n>FilterChain</span> <span class=n>chain</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span><span class=o>,</span> <span class=n>ServletException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>availability</span><span class=o>.</span><span class=na>getReadinessState</span><span class=o>().</span><span class=na>equals</span><span class=o>(</span><span class=n>ReadinessState</span><span class=o>.</span><span class=na>REFUSING_TRAFFIC</span><span class=o>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                <span class=o>!((</span><span class=n>HttpServletRequest</span><span class=o>)</span> <span class=n>request</span><span class=o>).</span><span class=na>getRequestURI</span><span class=o>().</span><span class=na>equals</span><span class=o>(</span><span class=n>API_MAINTENANCE_URI</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>LOGGER</span><span class=o>.</span><span class=na>warn</span><span class=o>(</span><span class=s>&#34;Message handled during maintenance [{}]&#34;</span><span class=o>,</span> <span class=o>((</span><span class=n>HttpServletRequest</span><span class=o>)</span> <span class=n>request</span><span class=o>).</span><span class=na>getRequestURI</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>exceptionHandler</span><span class=o>.</span><span class=na>resolveException</span><span class=o>((</span><span class=n>HttpServletRequest</span><span class=o>)</span> <span class=n>request</span><span class=o>,</span> <span class=o>(</span><span class=n>HttpServletResponse</span><span class=o>)</span> <span class=n>response</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=k>new</span> <span class=n>MaintenanceException</span><span class=o>(</span><span class=s>&#34;Service currently in maintenance&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>chain</span><span class=o>.</span><span class=na>doFilter</span><span class=o>(</span><span class=n>request</span><span class=o>,</span> <span class=n>response</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Enfin, voici la gestion des erreurs de l&rsquo;API:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestControllerAdvice</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>GlobalExceptionHandler</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Indicates that the application is on maintenance
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@ResponseStatus</span><span class=o>(</span><span class=n>HttpStatus</span><span class=o>.</span><span class=na>I_AM_A_TEAPOT</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nd>@ExceptionHandler</span><span class=o>(</span><span class=n>MaintenanceException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>APIError</span> <span class=nf>maintenance</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>APIError</span><span class=o>(</span><span class=n>HttpStatus</span><span class=o>.</span><span class=na>I_AM_A_TEAPOT</span><span class=o>.</span><span class=na>value</span><span class=o>(),</span><span class=s>&#34;Service currently in maintenance&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Any other exception
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@ResponseStatus</span><span class=o>(</span><span class=n>HttpStatus</span><span class=o>.</span><span class=na>INTERNAL_SERVER_ERROR</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nd>@ExceptionHandler</span><span class=o>({</span><span class=n>RuntimeException</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>Exception</span><span class=o>.</span><span class=na>class</span><span class=o>})</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>APIError</span> <span class=nf>anyException</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>APIError</span><span class=o>(</span><span class=n>HttpStatus</span><span class=o>.</span><span class=na>INTERNAL_SERVER_ERROR</span><span class=o>.</span><span class=na>value</span><span class=o>(),</span><span class=s>&#34;An unexpected server error occured&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=conclusion>Conclusion</h2><p>On a pu voir comment intéragir simplement avec les APIS SPRING pour gérer le statut de l&rsquo;application pour répondre à cette question :Est-elle disponible ou non?<br>Bien évidemment, selon le contexte, il conviendra d&rsquo;ajouter un peu de sécurité pour que cette API ne soit pas disponible à tout le monde 🙂</p><p>Le code exposé ici est disponible sur <a href=https://github.com/alexandre-touret/maintenance-mode/ target=_blank rel="noopener noreffer">Github</a>. Le <a href=https://github.com/alexandre-touret/maintenance-mode/blob/main/README.md target=_blank rel="noopener noreffer">Readme</a> est suffisamment détaillé pour que vous puissiez tester et réutiliser le code.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Mis à jour le 2023-03-02&nbsp;<a class=git-hash href=https://github.com/alexandre-touret/alexandre-touret.github.io/commit/375bd449aa0d25e75c30b33fdae2da7a4b75de66 target=_blank title="commit by Alexandre Touret(alexandre-touret@users.noreply.github.com) 375bd449aa0d25e75c30b33fdae2da7a4b75de66: twitter card images">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>375bd44</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/2021/06/10/ajouter-un-mode-maintenance-a-votre-api-grace-a-spring-boot/index.md target=_blank>Lire Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Partager sur Twitter" data-sharer=twitter data-url=/2021/06/10/ajouter-un-mode-maintenance-a-votre-api-grace-a-spring-boot/ data-title="Ajouter un mode « maintenance » à votre API grâce à Spring boot" data-via=touret_alex data-hashtags=actuator,observability,planetlibre,spring,springboot><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Partager sur Linkedin" data-sharer=linkedin data-url=/2021/06/10/ajouter-un-mode-maintenance-a-votre-api-grace-a-spring-boot/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Partager sur Hacker News" data-sharer=hackernews data-url=/2021/06/10/ajouter-un-mode-maintenance-a-votre-api-grace-a-spring-boot/ data-title="Ajouter un mode « maintenance » à votre API grâce à Spring boot"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/actuator/>actuator</a>,&nbsp;<a href=/tags/observability/>observability</a>,&nbsp;<a href=/tags/planetlibre/>planetlibre</a>,&nbsp;<a href=/tags/spring/>spring</a>,&nbsp;<a href=/tags/springboot/>springboot</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Retour</a></span>&nbsp;|&nbsp;<span><a href=/>Accueil</a></span></section></div><div class=post-nav><a href=/2021/05/03/utiliser-gpg-dans-wsl2/ class=prev rel=prev title="Utiliser GPG dans WSL2"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Utiliser GPG dans WSL2</a>
<a href=/2021/07/26/observabilite-et-circuit-breaker-avec-spring/ class=next rel=next title="Observabilité et Circuit Breaker avec Spring">Observabilité et Circuit Breaker avec Spring<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=utterances class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><a rel=me href=https://piaille.fr/@alexandre></a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2018 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://blog.touret.info target=_blank>Alexandre Touret</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by/4.0/ target=_blank>CC BY 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Retour en Haut"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="Afficher les Commentaires"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.fr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copier dans le presse-papiers",maxShownLines:50},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"alexandre-touret/alexandre-touret.github.io"}},lightgallery:!0,search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"fr",maxResultLength:10,noResultsFound:"Aucun résultat trouvé",snippetLength:50,type:"lunr"},twemoji:!0}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F1EK89MHJD",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-F1EK89MHJD" async></script></body></html>