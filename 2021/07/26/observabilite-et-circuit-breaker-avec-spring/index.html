<!doctype html><html lang=fr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Observabilité et Circuit Breaker avec Spring - Alexandre Touret's Blog</title><meta name=Description content="Architecte logiciel, développeur, bidouilleur (dans le désordre)"><meta property="og:title" content="Observabilité et Circuit Breaker avec Spring"><meta property="og:description" content="Il y a quelques mois déjà, je discutais avec un collègue d&rsquo; observabilité, opentracing, … avec Quarkus. On est tombé sur un super exemple réalisé par Antonio Concalves. Ce projet démontre les capacités de Quarkus sur les sujets suivants:
Circuit Breaker Observabilité OpenTracing Tests … Et la on peut se demander quid de Spring? Je me doutais que ces fonctionnalités étaient soient disponibles par défaut soient facilement intégrables vu la richesse de l&rsquo;écosystème."><meta property="og:type" content="article"><meta property="og:url" content="http://blog.touret.info/2021/07/26/observabilite-et-circuit-breaker-avec-spring/"><meta property="og:image" content="http://blog.touret.info/assets/images/2021/07/rest-book-architecture.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-07-26T11:53:49+00:00"><meta property="article:modified_time" content="2023-03-02T18:52:03+01:00"><meta property="og:site_name" content="blog.touret.info"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://blog.touret.info/assets/images/2021/07/rest-book-architecture.png"><meta name=twitter:title content="Observabilité et Circuit Breaker avec Spring"><meta name=twitter:description content="Il y a quelques mois déjà, je discutais avec un collègue d&rsquo; observabilité, opentracing, … avec Quarkus. On est tombé sur un super exemple réalisé par Antonio Concalves. Ce projet démontre les capacités de Quarkus sur les sujets suivants:
Circuit Breaker Observabilité OpenTracing Tests … Et la on peut se demander quid de Spring? Je me doutais que ces fonctionnalités étaient soient disponibles par défaut soient facilement intégrables vu la richesse de l&rsquo;écosystème."><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><meta name=theme-color content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel=canonical href=http://blog.touret.info/2021/07/26/observabilite-et-circuit-breaker-avec-spring/><link rel=prev href=http://blog.touret.info/2021/06/10/ajouter-un-mode-maintenance-a-votre-api-grace-a-spring-boot/><link rel=next href=http://blog.touret.info/2021/12/06/migrer-un-blog-wordpress-vers-github-io/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><meta name=google-site-verification content="7UnqNmvO-mjfMkRqKaaWRPTBxSylEVJXvAn8iTfc7SI"><meta name=msvalidate.01 content="F9655A4C8648E42154ECB4B4D6CF60A2"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Observabilité et Circuit Breaker avec Spring","inLanguage":"fr","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/blog.touret.info\/2021\/07\/26\/observabilite-et-circuit-breaker-avec-spring\/"},"image":["http:\/\/blog.touret.info\/images\/alexandre-touret.webp"],"genre":"posts","keywords":"github, java, observability, planetlibre, spring","wordcount":794,"url":"http:\/\/blog.touret.info\/2021\/07\/26\/observabilite-et-circuit-breaker-avec-spring\/","datePublished":"2021-07-26T11:53:49+00:00","dateModified":"2023-03-02T18:52:03+01:00","license":"This work is licensed under a Creative Commons Attribution 4.0 International License.","publisher":{"@type":"Organization","name":"Alexandre Touret","logo":"http:\/\/blog.touret.info\/images\/alexandre-touret.webp"},"author":{"@type":"Person","name":"Alexandre Touret"},"description":""}</script><script src=//instant.page/5.2.0 defer type=module integrity=sha384-jnZyxPjiipYXnSU0ygqeac2q7CVYMbh84q0uHVRRxEtvFPiQYbXWUorga2aqZJ0z></script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"||"auto"==="black"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Alexandre Touret's Blog">blog.touret.info</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/ title=Articles>Articles </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/contact/>Contact </a><a class=menu-item href=/talks/ title=Talks>Conférences </a><a class=menu-item href=/about/ title="À propos">À propos </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item language" title="Choisir la langue">Français<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select title="Choisir la langue" id=language-select-desktop onchange="location=this.value"><option value=/2021/07/26/observabilite-et-circuit-breaker-avec-spring/ selected>Français</option></select>
</a><span class="menu-item search" id=search-desktop><input type=text placeholder="Rechercher des titres, des contenus..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Chercher><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Effacer><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Changer de thème"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Alexandre Touret's Blog">blog.touret.info</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Rechercher des titres, des contenus..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Chercher><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Effacer><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Annuler</a></div><a class=menu-item href=/posts/ title=Articles>Articles</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/contact/ title>Contact</a><a class=menu-item href=/talks/ title=Talks>Conférences</a><a class=menu-item href=/about/ title="À propos">À propos</a><a href=javascript:void(0); class="menu-item theme-switch" title="Changer de thème">
<i class="fas fa-adjust fa-fw"></i>
</a><a href=javascript:void(0); class=menu-item title="Choisir la langue">Français<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select title="Choisir la langue" onchange="location=this.value"><option value=/2021/07/26/observabilite-et-circuit-breaker-avec-spring/ selected>Français</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contenu</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#architecture-de-lapplication>Architecture de l&rsquo;application</a></li><li><a href=#circuit-breaker>Circuit Breaker</a></li><li><a href=#observabilité>Observabilité</a></li><li><a href=#opentracing>OpenTracing</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Observabilité et Circuit Breaker avec Spring</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class="author fas fa-user-circle fa-fw"></span><a href=https://blog.touret.info title=Author target=_blank rel="noopener noreferrer author" class=author>Alexandre Touret</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-07-26>2021-07-26</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2023-03-02>2023-03-02</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;794 mots&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;4 minutes&nbsp;</div></div><div class=featured-image><img loading=eager src=/assets/images/2021/07/rest-book-architecture.png srcset="/assets/images/2021/07/rest-book-architecture.png, /assets/images/2021/07/rest-book-architecture.png 1.5x, /assets/images/2021/07/rest-book-architecture.png 2x" sizes=auto alt=/assets/images/2021/07/rest-book-architecture.png title=/assets/images/2021/07/rest-book-architecture.png height=auto width=auto></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contenu</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#architecture-de-lapplication>Architecture de l&rsquo;application</a></li><li><a href=#circuit-breaker>Circuit Breaker</a></li><li><a href=#observabilité>Observabilité</a></li><li><a href=#opentracing>OpenTracing</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div><div class=content id=content><p>Il y a quelques mois déjà, je discutais avec <a href=https://jefrajames.fr/ target=_blank rel="noopener noreferrer">un collègue</a> d&rsquo; observabilité, <a href=https://github.com/opentracing-contrib/java-spring-cloud target=_blank rel="noopener noreferrer">opentracing</a>, … avec <a href=http://quarkus.io/ target=_blank rel="noopener noreferrer">Quarkus</a>. On est tombé sur <a href=https://github.com/agoncal/agoncal-fascicle-quarkus-pract target=_blank rel="noopener noreferrer">un super exemple réalisé par Antonio Concalves</a>. Ce projet démontre les capacités de Quarkus sur les sujets suivants:</p><ul><li>Circuit Breaker</li><li>Observabilité</li><li>OpenTracing</li><li>Tests</li><li>…</li></ul><p>Et la on peut se demander quid de <a href=http://spring.io/ target=_blank rel="noopener noreferrer">Spring</a>? Je me doutais que ces fonctionnalités étaient soient disponibles par défaut soient facilement intégrables vu la richesse de l&rsquo;écosystème.</p><p>J&rsquo;ai donc réalisé un clone de <a href=https://github.com/alexandre-touret/bookstore_spring target=_blank rel="noopener noreferrer">ce projet basé sur Spring Boot/Cloud</a>. Je ne vais pas détailler plus que ça les différentes fonctionnalités, vous pouvez vous référer au fichier <a href=https://github.com/alexandre-touret/bookstore_spring#readme target=_blank rel="noopener noreferrer">README</a>. Il est suffisamment détaillé pour que vous puissiez exécuter et les mettre en œuvre.</p><h2 id=architecture-de-lapplication class=headerLink><a href=#architecture-de-lapplication class=header-mark></a>Architecture de l&rsquo;application</h2><p>Vous trouverez ci-dessous un schéma d&rsquo;architecture de l&rsquo;application <a href=https://c4model.com/ target=_blank rel="noopener noreferrer">au format C4</a>.</p><h2 id=circuit-breaker class=headerLink><a href=#circuit-breaker class=header-mark></a>Circuit Breaker</h2><p>Lors des appels entre le <a href=https://github.com/alexandre-touret/bookstore_spring/blob/main/rest-book/src/main/java/info/touret/bookstore/spring/book/service/BookService.java target=_blank rel="noopener noreferrer">bookstore</a> et le <a href=https://github.com/alexandre-touret/bookstore_spring/blob/main/rest-number/src/main/java/info/touret/bookstore/spring/number/controller/BookNumbersController.java target=_blank rel="noopener noreferrer">booknumberservice</a>, il peut être intéressant d&rsquo; implémenter un <a href=https://martinfowler.com/bliki/CircuitBreaker.html target=_blank rel="noopener noreferrer">circuit breaker</a> pour pallier aux indisponibilités de ce dernier.<br>Avec Spring, on peut utiliser <a href=https://github.com/resilience4j/resilience4j target=_blank rel="noopener noreferrer">Resilience4J</a> au travers de <a href=https://spring.io/projects/spring-cloud target=_blank rel="noopener noreferrer">Spring Cloud</a>. Tout ceci se fait de manière programmatique</p><p>Il faut tout d&rsquo;abord <a href=https://github.com/alexandre-touret/bookstore_spring/blob/main/rest-book/src/main/java/info/touret/bookstore/spring/book/BookConfiguration.java target=_blank rel="noopener noreferrer">configurer les circuit breakers au travers d&rsquo;une classe Configuration</a>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Customizer</span><span class=o>&lt;</span><span class=n>Resilience4JCircuitBreakerFactory</span><span class=o>&gt;</span> <span class=nf>createDefaultCustomizer</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>factory</span> <span class=o>-&gt;</span> <span class=n>factory</span><span class=o>.</span><span class=na>configureDefault</span><span class=o>(</span><span class=n>id</span> <span class=o>-&gt;</span> <span class=k>new</span> <span class=n>Resilience4JConfigBuilder</span><span class=o>(</span><span class=n>id</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>timeLimiterConfig</span><span class=o>(</span><span class=n>TimeLimiterConfig</span><span class=o>.</span><span class=na>custom</span><span class=o>().</span><span class=na>timeoutDuration</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>ofSeconds</span><span class=o>(</span><span class=n>timeoutInSec</span><span class=o>)).</span><span class=na>build</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>circuitBreakerConfig</span><span class=o>(</span><span class=n>CircuitBreakerConfig</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>build</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Creates a circuit breaker customizer applying a timeout specified by the &lt;code&gt;booknumbers.api.timeout_sec&lt;/code&gt; property.
</span></span></span><span class=line><span class=cl><span class=cm>     * This customizer could be reached using this id: &lt;code&gt;slowNumbers&lt;/code&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * @return the circuit breaker customizer to apply when calling to numbers api
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Customizer</span><span class=o>&lt;</span><span class=n>Resilience4JCircuitBreakerFactory</span><span class=o>&gt;</span> <span class=nf>createSlowNumbersAPICallCustomizer</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>factory</span> <span class=o>-&gt;</span> <span class=n>factory</span><span class=o>.</span><span class=na>configure</span><span class=o>(</span><span class=n>builder</span> <span class=o>-&gt;</span> <span class=n>builder</span><span class=o>.</span><span class=na>circuitBreakerConfig</span><span class=o>(</span><span class=n>CircuitBreakerConfig</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>timeLimiterConfig</span><span class=o>(</span><span class=n>TimeLimiterConfig</span><span class=o>.</span><span class=na>custom</span><span class=o>().</span><span class=na>timeoutDuration</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>ofSeconds</span><span class=o>(</span><span class=n>timeoutInSec</span><span class=o>)).</span><span class=na>build</span><span class=o>()),</span> <span class=s>&#34;slowNumbers&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Grâce à ces instanciations, on référence les différents <a href=https://martinfowler.com/bliki/CircuitBreaker.html target=_blank rel="noopener noreferrer">circuit breakers</a>.</p><p>Maintenant, on peut les utiliser dans le code de la manière suivante:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>Book</span> <span class=nf>registerBook</span><span class=o>(</span><span class=nd>@Valid</span> <span class=n>Book</span> <span class=n>book</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>circuitBreakerFactory</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=s>&#34;slowNumbers&#34;</span><span class=o>).</span><span class=na>run</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=o>()</span> <span class=o>-&gt;</span> <span class=n>persistBook</span><span class=o>(</span><span class=n>book</span><span class=o>),</span>
</span></span><span class=line><span class=cl>                <span class=n>throwable</span> <span class=o>-&gt;</span> <span class=n>fallbackPersistBook</span><span class=o>(</span><span class=n>book</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>bookRepository</span><span class=o>.</span><span class=na>save</span><span class=o>(</span><span class=n>book</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Maintenant, il ne reste plus qu&rsquo;à créer <a href=https://github.com/alexandre-touret/bookstore_spring/blob/main/rest-book/src/main/java/info/touret/bookstore/spring/book/service/BookService.java target=_blank rel="noopener noreferrer">une méthode de « fallback » utilisée si un service est indisponible</a>. Cette dernière nous permettra, par exemple, de mettre le payload dans un fichier pour futur traitement batch.</p><h2 id=observabilité class=headerLink><a href=#observabilit%c3%a9 class=header-mark></a>Observabilité</h2><p>L&rsquo;observabilité est sans contexte la pierre angulaire (oui, rien que ça…) de toute application cloud native. Sans ça, pas de scalabilité, de redémarrage automatique,etc.<br>Les architectures de ce type d&rsquo;applications sont <a href=https://en.wikipedia.org/wiki/Idempotence target=_blank rel="noopener noreferrer">idempotentes</a>. On a donc besoin d&rsquo;avoir toutes les informations à notre disposition. Heureusement, <a href=https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#actuator target=_blank rel="noopener noreferrer">Spring fournit par le biais d&rsquo; Actuator</a> toutes les informations nécessaires. Ces dernières pourront soit être utilisées par <a href=https://kubernetes.io/ target=_blank rel="noopener noreferrer">Kubernetes</a> (ex. le <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/ target=_blank rel="noopener noreferrer">livenessProbe</a>) ou agrégées dans une base de données <a href=https://prometheus.io/docs/prometheus/latest/storage/ target=_blank rel="noopener noreferrer">Prometheus</a>.</p><p>Pour activer certaines métriques d&rsquo;<a href=https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html target=_blank rel="noopener noreferrer">actuator</a>, il suffit de :</p><p>Ajouter la/les dépendance(s)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>dependencies</span> <span class=o>{</span>
</span></span><span class=line><span class=cl><span class=o>[...]</span>
</span></span><span class=line><span class=cl>        <span class=n>implementation</span> <span class=s1>&#39;org.springframework.boot:spring-boot-starter-actuator&#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>implementation</span> <span class=s1>&#39;io.micrometer:micrometer-registry-prometheus&#39;</span>
</span></span><span class=line><span class=cl>     <span class=o>[...]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Spécifier la configuration adéquate:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nl>management:</span>
</span></span><span class=line><span class=cl>  <span class=n>endpoints</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>enabled</span><span class=o>-</span><span class=n>by</span><span class=o>-</span><span class=k>default</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=n>web</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>exposure</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>include</span><span class=o>:</span> <span class=sc>&#39;*&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>jmx</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>exposure</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>include</span><span class=o>:</span> <span class=sc>&#39;*&#39;</span>
</span></span><span class=line><span class=cl>  <span class=n>endpoint</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>health</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>show</span><span class=o>-</span><span class=n>details</span><span class=o>:</span> <span class=n>always</span>
</span></span><span class=line><span class=cl>      <span class=n>enabled</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>      <span class=n>probes</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>enabled</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=n>shutdown</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>enabled</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=n>prometheus</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>enabled</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>enabled</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=n>health</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>livenessstate</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>enabled</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=n>readinessstate</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>enabled</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=n>datasource</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>enabled</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=n>metrics</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>web</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>client</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>request</span><span class=o>:</span>
</span></span><span class=line><span class=cl>          <span class=n>autotime</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=n>enabled</span><span class=o>:</span> <span class=kc>true</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=opentracing class=headerLink><a href=#opentracing class=header-mark></a>OpenTracing</h2><p>Sur les applications distribuées, il peut s&rsquo;avérer compliqué de concentrer les logs et de les corréler. Certes, avec un ID de corrélation, on peut avoir certaines informations. Cependant, il faut que les logs soient bien positionnées dans le code. On peut également passer à travers de certaines informations (ex. connexion aux bases de données, temps d&rsquo;exécution des APIS,…). Je ne vous parle pas des soucis de volumétrie engendrées par des index Elasticsearch/Splunk sur des applications à forte volumétrie.</p><p>Depuis quelques temps, le <a href=https://www.cncf.io/ target=_blank rel="noopener noreferrer">CNCF</a> propose un projet (encore en incubation) : <a href=https://opentracing.io/ target=_blank rel="noopener noreferrer">OpenTracing</a>. Ce dernier fait désormais partie d&rsquo;<a href=https://opentelemetry.io/ target=_blank rel="noopener noreferrer">OpenTelemetry</a>.<br>Grâce à cet librairie, nous allons pouvoir tracer toutes les transactions de notre application microservices et pouvoir réaliser une corrélation « out of the box » grâce à l&rsquo;intégration avec <a href=https://www.jaegertracing.io/ target=_blank rel="noopener noreferrer">Jaeger</a>.</p><p>Pour activer la fonctionnalité il suffit d&rsquo;ajouter la dépendance au classpath:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>implementation</span> <span class=s1>&#39;io.opentracing.contrib:opentracing-spring-jaeger-cloud-starter:3.3.1&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>et de configurer l&rsquo;URL de Jaeger dans l&rsquo;application</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># Default values</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>opentracing</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jaeger</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>udp-sender</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>6831</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Une fois l&rsquo;application reconstruite et redémarrée, vous pourrez visualiser les transactions dans JAEGER:</p><p><figure><a class=lightgallery href=/assets/images/2021/07/screenshot-2021-07-26-at-11-38-31-jaeger-ui.png title=jaeger1 data-thumbnail=/assets/images/2021/07/screenshot-2021-07-26-at-11-38-31-jaeger-ui.png><img loading=lazy src=/assets/images/2021/07/screenshot-2021-07-26-at-11-38-31-jaeger-ui.png srcset="/assets/images/2021/07/screenshot-2021-07-26-at-11-38-31-jaeger-ui.png, /assets/images/2021/07/screenshot-2021-07-26-at-11-38-31-jaeger-ui.png 1.5x, /assets/images/2021/07/screenshot-2021-07-26-at-11-38-31-jaeger-ui.png 2x" sizes=auto alt=jaeger1></a></figure><figure><a class=lightgallery href=/assets/images/2021/07/screenshot-2021-07-26-at-11-38-15-jaeger-ui.png title=jaeger2 data-thumbnail=/assets/images/2021/07/screenshot-2021-07-26-at-11-38-15-jaeger-ui.png><img loading=lazy src=/assets/images/2021/07/screenshot-2021-07-26-at-11-38-15-jaeger-ui.png srcset="/assets/images/2021/07/screenshot-2021-07-26-at-11-38-15-jaeger-ui.png, /assets/images/2021/07/screenshot-2021-07-26-at-11-38-15-jaeger-ui.png 1.5x, /assets/images/2021/07/screenshot-2021-07-26-at-11-38-15-jaeger-ui.png 2x" sizes=auto alt=jaeger2></a></figure></p><h2 id=conclusion class=headerLink><a href=#conclusion class=header-mark></a>Conclusion</h2><p>Je ne vais pas exposer l&rsquo;implémentation des tests unitaires et d&rsquo;intégration. Si vous voulez voir comment j&rsquo;ai réussi à mocker simplement les appels REST à une API distante, vous pouvez regarder <a href=https://github.com/alexandre-touret/bookstore_spring/blob/main/rest-book/src/test/java/info/touret/bookstore/spring/book/controller/BookControllerIT.java target=_blank rel="noopener noreferrer">cette classe</a> pour voir une utilisation du <a href=https://www.baeldung.com/mockserver target=_blank rel="noopener noreferrer">MockServer</a>.<br>Aussi, n&rsquo;hésitez pas à cloner, tester ce projet et me donner votre retour. J&rsquo;essaierai de le mettre à jour au fur et à mesure de mes découvertes (par ex. OpenTelemetry).</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Mis à jour le 2023-03-02&nbsp;<a class=git-hash href=https://github.com/alexandre-touret/alexandre-touret.github.io/commit/375bd449aa0d25e75c30b33fdae2da7a4b75de66 target=_blank title="commit by Alexandre Touret(alexandre-touret@users.noreply.github.com) 375bd449aa0d25e75c30b33fdae2da7a4b75de66: twitter card images" rel="noopener noreferrer">
<i class="fas fa-hashtag fa-fw"></i>375bd44</a></span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-mardown href=/2021/07/26/observabilite-et-circuit-breaker-avec-spring/index.md target=_blank rel="noopener noreferrer">Lire en Markdown</a></span></div><div class=post-info-share><button title="Partager sur Twitter" data-sharer=twitter data-url=http://blog.touret.info/2021/07/26/observabilite-et-circuit-breaker-avec-spring/ data-title="Observabilité et Circuit Breaker avec Spring" data-via=touret_alex data-hashtags=github,java,observability,planetlibre,spring><span class="fab fa-twitter fa-fw"></span></button><button title="Partager sur Linkedin" data-sharer=linkedin data-url=http://blog.touret.info/2021/07/26/observabilite-et-circuit-breaker-avec-spring/><span class="fab fa-linkedin fa-fw"></span></button><button title="Partager sur Hacker News" data-sharer=hackernews data-url=http://blog.touret.info/2021/07/26/observabilite-et-circuit-breaker-avec-spring/ data-title="Observabilité et Circuit Breaker avec Spring"><span class="fab fa-hacker-news fa-fw"></span></button></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/github/>github</a>,&nbsp;<a href=/tags/java/>java</a>,&nbsp;<a href=/tags/observability/>observability</a>,&nbsp;<a href=/tags/planetlibre/>planetlibre</a>,&nbsp;<a href=/tags/spring/>spring</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Retour</a></span>&nbsp;|&nbsp;<span><a href=/>Accueil</a></span></section></div><div class=post-nav><a href=/2021/06/10/ajouter-un-mode-maintenance-a-votre-api-grace-a-spring-boot/ class=prev rel=prev title="Ajouter un mode « maintenance » à votre API grâce à Spring boot"><i class="fas fa-angle-left fa-fw"></i>Ajouter un mode « maintenance » à votre API grâce à Spring boot</a>
<a href=/2021/12/06/migrer-un-blog-wordpress-vers-github-io/ class=next rel=next title="Migrer son blog Wordpress vers GitHub">Migrer son blog Wordpress vers GitHub<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><a rel=me href=https://piaille.fr/@alexandre></a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://blog.touret.info target=_blank rel="noopener noreferrer">Alexandre Touret</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by/4.0/ target=_blank>CC BY 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div><script>"serviceWorker"in navigator&&(navigator.serviceWorker.register("/sw.min.js",{scope:"/"}).then(function(){}),navigator.serviceWorker.ready.then(function(){}))</script></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title="Retour en haut"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="Afficher les commentaires"><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery.js@1.4.0/dist/css/lightgallery.min.css><script type=text/javascript>window.config={code:{copyTitle:"Copier dans le presse-papiers",maxShownLines:50},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"comment",lightTheme:"github-light",repo:"alexandre-touret/alexandre-touret.github.io"}},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},search:{distance:null,findAllMatches:null,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:null,ignoreLocation:null,isCaseSensitive:null,location:null,maxResultLength:10,minMatchCharLength:null,noResultsFound:"Aucun résultat trouvé",snippetLength:50,threshold:null,type:"fuse",useExtendedSearch:null},sharerjs:!0,twemoji:!0}</script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/twemoji@13.1.0/dist/twemoji.min.js defer></script><script type=text/javascript src=/js/twemoji.min.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery.js@1.4.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-zoom.js@1.3.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.2/sharer.min.js></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=/js/utterances.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F1EK89MHJD",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-F1EK89MHJD" async></script></div></body></html>