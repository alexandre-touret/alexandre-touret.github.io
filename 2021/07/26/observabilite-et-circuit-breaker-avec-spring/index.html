<!doctype html><html lang=fr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Observabilité et Circuit Breaker avec Spring - Alexandre Touret's Blog</title><meta name=Description content="Architecte logiciel, développeur, bidouilleur (dans le désordre)"><meta property="og:title" content="Observabilité et Circuit Breaker avec Spring"><meta property="og:description" content="Il y a quelques mois déjà, je discutais avec un collègue d&rsquo; observabilité, opentracing, … avec Quarkus. On est tombé sur un super exemple réalisé par Antonio Concalves. Ce projet démontre les capacités de Quarkus sur les sujets suivants:
Circuit Breaker Observabilité OpenTracing Tests … Et la on peut se demander quid de Spring? Je me doutais que ces fonctionnalités étaient soient disponibles par défaut soient facilement intégrables vu la richesse de l&rsquo;écosystème."><meta property="og:type" content="article"><meta property="og:url" content="/2021/07/26/observabilite-et-circuit-breaker-avec-spring/"><meta property="og:image" content="/assets/images/2021/07/rest-book-architecture.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-07-26T11:53:49+00:00"><meta property="article:modified_time" content="2023-03-02T18:52:03+01:00"><meta property="og:site_name" content="blog.touret.info"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/assets/images/2021/07/rest-book-architecture.png"><meta name=twitter:title content="Observabilité et Circuit Breaker avec Spring"><meta name=twitter:description content="Il y a quelques mois déjà, je discutais avec un collègue d&rsquo; observabilité, opentracing, … avec Quarkus. On est tombé sur un super exemple réalisé par Antonio Concalves. Ce projet démontre les capacités de Quarkus sur les sujets suivants:
Circuit Breaker Observabilité OpenTracing Tests … Et la on peut se demander quid de Spring? Je me doutais que ces fonctionnalités étaient soient disponibles par défaut soient facilement intégrables vu la richesse de l&rsquo;écosystème."><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=canonical href=/2021/07/26/observabilite-et-circuit-breaker-avec-spring/><link rel=prev href=/2021/06/10/ajouter-un-mode-maintenance-a-votre-api-grace-a-spring-boot/><link rel=next href=/2021/12/06/migrer-un-blog-wordpress-vers-github-io/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><meta name=google-site-verification content="7UnqNmvO-mjfMkRqKaaWRPTBxSylEVJXvAn8iTfc7SI"><meta name=msvalidate.01 content="F9655A4C8648E42154ECB4B4D6CF60A2"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Observabilité et Circuit Breaker avec Spring","inLanguage":"fr","mainEntityOfPage":{"@type":"WebPage","@id":"\/2021\/07\/26\/observabilite-et-circuit-breaker-avec-spring\/"},"image":["\/images\/alexandre-touret.webp"],"genre":"posts","keywords":"github, java, observability, planetlibre, spring","wordcount":799,"url":"\/2021\/07\/26\/observabilite-et-circuit-breaker-avec-spring\/","datePublished":"2021-07-26T11:53:49+00:00","dateModified":"2023-03-02T18:52:03+01:00","license":"This work is licensed under a Creative Commons Attribution 4.0 International License.","publisher":{"@type":"Organization","name":"Alexandre Touret","logo":"\/images\/alexandre-touret.webp"},"author":{"@type":"Person","name":"Alexandre Touret"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Alexandre Touret's Blog">blog.touret.info</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/ title=Articles>Articles </a><a class=menu-item href=/contact/>Contact </a><a class=menu-item href=/talks/ title=Talks>Conférences </a><a class=menu-item href=/a-propos/ title="À propos">À propos </a><a class=menu-item href=/https:/blog.touret.info/index.xml><i class='fa fa-rss-square fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Rechercher des titres, des contenus..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Chercher><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clair><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Changer de Thème"><i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="menu-item language" title="Choisir la langue"><i class="fa fa-globe" aria-hidden=true></i>
<select class=language-select id=language-select-desktop onchange="location=this.value"><option value=/2021/07/26/observabilite-et-circuit-breaker-avec-spring/ selected>Français</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Alexandre Touret's Blog">blog.touret.info</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Rechercher des titres, des contenus..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Chercher><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clair><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Annuler</a></div><a class=menu-item href=/posts/ title=Articles>Articles</a><a class=menu-item href=/contact/ title>Contact</a><a class=menu-item href=/talks/ title=Talks>Conférences</a><a class=menu-item href=/a-propos/ title="À propos">À propos</a><a class=menu-item href=/https:/blog.touret.info/index.xml title><i class='fa fa-rss-square fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Changer de Thème">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class=menu-item title="Choisir la langue"><i class="fa fa-globe fa-fw" aria-hidden=true></i>
<select class=language-select onchange="location=this.value"><option value=/2021/07/26/observabilite-et-circuit-breaker-avec-spring/ selected>Français</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contenu</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Observabilité et Circuit Breaker avec Spring</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://blog.touret.info title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Alexandre Touret</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2021-07-26>2021-07-26</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;799 mots&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;4 minutes&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/assets/images/2021/07/rest-book-architecture.png data-srcset="/assets/images/2021/07/rest-book-architecture.png, /assets/images/2021/07/rest-book-architecture.png 1.5x, /assets/images/2021/07/rest-book-architecture.png 2x" data-sizes=auto alt=/assets/images/2021/07/rest-book-architecture.png title=/assets/images/2021/07/rest-book-architecture.png></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contenu</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#architecture-de-lapplication>Architecture de l&rsquo;application</a></li><li><a href=#circuit-breaker>Circuit Breaker</a></li><li><a href=#observabilité>Observabilité</a></li><li><a href=#opentracing>OpenTracing</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div><div class=content id=content><p>Il y a quelques mois déjà, je discutais avec <a href=https://jefrajames.fr/ target=_blank rel="noopener noreffer">un collègue</a> d&rsquo; observabilité, <a href=https://github.com/opentracing-contrib/java-spring-cloud target=_blank rel="noopener noreffer">opentracing</a>, … avec <a href=http://quarkus.io/ target=_blank rel="noopener noreffer">Quarkus</a>. On est tombé sur <a href=https://github.com/agoncal/agoncal-fascicle-quarkus-pract target=_blank rel="noopener noreffer">un super exemple réalisé par Antonio Concalves</a>. Ce projet démontre les capacités de Quarkus sur les sujets suivants:</p><ul><li>Circuit Breaker</li><li>Observabilité</li><li>OpenTracing</li><li>Tests</li><li>…</li></ul><p>Et la on peut se demander quid de <a href=http://spring.io/ target=_blank rel="noopener noreffer">Spring</a>? Je me doutais que ces fonctionnalités étaient soient disponibles par défaut soient facilement intégrables vu la richesse de l&rsquo;écosystème.</p><p>J&rsquo;ai donc réalisé un clone de <a href=https://github.com/alexandre-touret/bookstore_spring target=_blank rel="noopener noreffer">ce projet basé sur Spring Boot/Cloud</a>. Je ne vais pas détailler plus que ça les différentes fonctionnalités, vous pouvez vous référer au fichier <a href=https://github.com/alexandre-touret/bookstore_spring#readme target=_blank rel="noopener noreffer">README</a>. Il est suffisamment détaillé pour que vous puissiez exécuter et les mettre en œuvre.</p><h2 id=architecture-de-lapplication>Architecture de l&rsquo;application</h2><p>Vous trouverez ci-dessous un schéma d&rsquo;architecture de l&rsquo;application <a href=https://c4model.com/ target=_blank rel="noopener noreffer">au format C4</a>.</p><h2 id=circuit-breaker>Circuit Breaker</h2><p>Lors des appels entre le <a href=https://github.com/alexandre-touret/bookstore_spring/blob/main/rest-book/src/main/java/info/touret/bookstore/spring/book/service/BookService.java target=_blank rel="noopener noreffer">bookstore</a> et le <a href=https://github.com/alexandre-touret/bookstore_spring/blob/main/rest-number/src/main/java/info/touret/bookstore/spring/number/controller/BookNumbersController.java target=_blank rel="noopener noreffer">booknumberservice</a>, il peut être intéressant d&rsquo; implémenter un <a href=https://martinfowler.com/bliki/CircuitBreaker.html target=_blank rel="noopener noreffer">circuit breaker</a> pour pallier aux indisponibilités de ce dernier.<br>Avec Spring, on peut utiliser <a href=https://github.com/resilience4j/resilience4j target=_blank rel="noopener noreffer">Resilience4J</a> au travers de <a href=https://spring.io/projects/spring-cloud target=_blank rel="noopener noreffer">Spring Cloud</a>. Tout ceci se fait de manière programmatique</p><p>Il faut tout d&rsquo;abord <a href=https://github.com/alexandre-touret/bookstore_spring/blob/main/rest-book/src/main/java/info/touret/bookstore/spring/book/BookConfiguration.java target=_blank rel="noopener noreffer">configurer les circuit breakers au travers d&rsquo;une classe Configuration</a>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Customizer</span><span class=o>&lt;</span><span class=n>Resilience4JCircuitBreakerFactory</span><span class=o>&gt;</span> <span class=nf>createDefaultCustomizer</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>factory</span> <span class=o>-&gt;</span> <span class=n>factory</span><span class=o>.</span><span class=na>configureDefault</span><span class=o>(</span><span class=n>id</span> <span class=o>-&gt;</span> <span class=k>new</span> <span class=n>Resilience4JConfigBuilder</span><span class=o>(</span><span class=n>id</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>timeLimiterConfig</span><span class=o>(</span><span class=n>TimeLimiterConfig</span><span class=o>.</span><span class=na>custom</span><span class=o>().</span><span class=na>timeoutDuration</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>ofSeconds</span><span class=o>(</span><span class=n>timeoutInSec</span><span class=o>)).</span><span class=na>build</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>circuitBreakerConfig</span><span class=o>(</span><span class=n>CircuitBreakerConfig</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>build</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Creates a circuit breaker customizer applying a timeout specified by the &lt;code&gt;booknumbers.api.timeout_sec&lt;/code&gt; property.
</span></span></span><span class=line><span class=cl><span class=cm>     * This customizer could be reached using this id: &lt;code&gt;slowNumbers&lt;/code&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * @return the circuit breaker customizer to apply when calling to numbers api
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Customizer</span><span class=o>&lt;</span><span class=n>Resilience4JCircuitBreakerFactory</span><span class=o>&gt;</span> <span class=nf>createSlowNumbersAPICallCustomizer</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>factory</span> <span class=o>-&gt;</span> <span class=n>factory</span><span class=o>.</span><span class=na>configure</span><span class=o>(</span><span class=n>builder</span> <span class=o>-&gt;</span> <span class=n>builder</span><span class=o>.</span><span class=na>circuitBreakerConfig</span><span class=o>(</span><span class=n>CircuitBreakerConfig</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>timeLimiterConfig</span><span class=o>(</span><span class=n>TimeLimiterConfig</span><span class=o>.</span><span class=na>custom</span><span class=o>().</span><span class=na>timeoutDuration</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>ofSeconds</span><span class=o>(</span><span class=n>timeoutInSec</span><span class=o>)).</span><span class=na>build</span><span class=o>()),</span> <span class=s>&#34;slowNumbers&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Grâce à ces instanciations, on référence les différents <a href=https://martinfowler.com/bliki/CircuitBreaker.html target=_blank rel="noopener noreffer">circuit breakers</a>.</p><p>Maintenant, on peut les utiliser dans le code de la manière suivante:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>Book</span> <span class=nf>registerBook</span><span class=o>(</span><span class=nd>@Valid</span> <span class=n>Book</span> <span class=n>book</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>circuitBreakerFactory</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=s>&#34;slowNumbers&#34;</span><span class=o>).</span><span class=na>run</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=o>()</span> <span class=o>-&gt;</span> <span class=n>persistBook</span><span class=o>(</span><span class=n>book</span><span class=o>),</span>
</span></span><span class=line><span class=cl>                <span class=n>throwable</span> <span class=o>-&gt;</span> <span class=n>fallbackPersistBook</span><span class=o>(</span><span class=n>book</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>bookRepository</span><span class=o>.</span><span class=na>save</span><span class=o>(</span><span class=n>book</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Maintenant, il ne reste plus qu&rsquo;à créer <a href=https://github.com/alexandre-touret/bookstore_spring/blob/main/rest-book/src/main/java/info/touret/bookstore/spring/book/service/BookService.java target=_blank rel="noopener noreffer">une méthode de « fallback » utilisée si un service est indisponible</a>. Cette dernière nous permettra, par exemple, de mettre le payload dans un fichier pour futur traitement batch.</p><h2 id=observabilité>Observabilité</h2><p>L&rsquo;observabilité est sans contexte la pierre angulaire (oui, rien que ça…) de toute application cloud native. Sans ça, pas de scalabilité, de redémarrage automatique,etc.<br>Les architectures de ce type d&rsquo;applications sont <a href=https://en.wikipedia.org/wiki/Idempotence target=_blank rel="noopener noreffer">idempotentes</a>. On a donc besoin d&rsquo;avoir toutes les informations à notre disposition. Heureusement, <a href=https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#actuator target=_blank rel="noopener noreffer">Spring fournit par le biais d&rsquo; Actuator</a> toutes les informations nécessaires. Ces dernières pourront soit être utilisées par <a href=https://kubernetes.io/ target=_blank rel="noopener noreffer">Kubernetes</a> (ex. le <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/ target=_blank rel="noopener noreffer">livenessProbe</a>) ou agrégées dans une base de données <a href=https://prometheus.io/docs/prometheus/latest/storage/ target=_blank rel="noopener noreffer">Prometheus</a>.</p><p>Pour activer certaines métriques d&rsquo;<a href=https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html target=_blank rel="noopener noreffer">actuator</a>, il suffit de :</p><p>Ajouter la/les dépendance(s)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>dependencies</span> <span class=o>{</span>
</span></span><span class=line><span class=cl><span class=o>[...]</span>
</span></span><span class=line><span class=cl>        <span class=n>implementation</span> <span class=s1>&#39;org.springframework.boot:spring-boot-starter-actuator&#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>implementation</span> <span class=s1>&#39;io.micrometer:micrometer-registry-prometheus&#39;</span>
</span></span><span class=line><span class=cl>     <span class=o>[...]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Spécifier la configuration adéquate:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nl>management:</span>
</span></span><span class=line><span class=cl>  <span class=n>endpoints</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>enabled</span><span class=o>-</span><span class=n>by</span><span class=o>-</span><span class=k>default</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=n>web</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>exposure</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>include</span><span class=o>:</span> <span class=sc>&#39;*&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>jmx</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>exposure</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>include</span><span class=o>:</span> <span class=sc>&#39;*&#39;</span>
</span></span><span class=line><span class=cl>  <span class=n>endpoint</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>health</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>show</span><span class=o>-</span><span class=n>details</span><span class=o>:</span> <span class=n>always</span>
</span></span><span class=line><span class=cl>      <span class=n>enabled</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>      <span class=n>probes</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>enabled</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=n>shutdown</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>enabled</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=n>prometheus</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>enabled</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>enabled</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=n>health</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>livenessstate</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>enabled</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=n>readinessstate</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>enabled</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=n>datasource</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>enabled</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=n>metrics</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>web</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>client</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>request</span><span class=o>:</span>
</span></span><span class=line><span class=cl>          <span class=n>autotime</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=n>enabled</span><span class=o>:</span> <span class=kc>true</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=opentracing>OpenTracing</h2><p>Sur les applications distribuées, il peut s&rsquo;avérer compliqué de concentrer les logs et de les corréler. Certes, avec un ID de corrélation, on peut avoir certaines informations. Cependant, il faut que les logs soient bien positionnées dans le code. On peut également passer à travers de certaines informations (ex. connexion aux bases de données, temps d&rsquo;exécution des APIS,…). Je ne vous parle pas des soucis de volumétrie engendrées par des index Elasticsearch/Splunk sur des applications à forte volumétrie.</p><p>Depuis quelques temps, le <a href=https://www.cncf.io/ target=_blank rel="noopener noreffer">CNCF</a> propose un projet (encore en incubation) : <a href=https://opentracing.io/ target=_blank rel="noopener noreffer">OpenTracing</a>. Ce dernier fait désormais partie d&rsquo;<a href=https://opentelemetry.io/ target=_blank rel="noopener noreffer">OpenTelemetry</a>.<br>Grâce à cet librairie, nous allons pouvoir tracer toutes les transactions de notre application microservices et pouvoir réaliser une corrélation « out of the box » grâce à l&rsquo;intégration avec <a href=https://www.jaegertracing.io/ target=_blank rel="noopener noreffer">Jaeger</a>.</p><p>Pour activer la fonctionnalité il suffit d&rsquo;ajouter la dépendance au classpath:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>implementation</span> <span class=s1>&#39;io.opentracing.contrib:opentracing-spring-jaeger-cloud-starter:3.3.1&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>et de configurer l&rsquo;URL de Jaeger dans l&rsquo;application</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># Default values</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>opentracing</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jaeger</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>udp-sender</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>6831</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Une fois l&rsquo;application reconstruite et redémarrée, vous pourrez visualiser les transactions dans JAEGER:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/assets/images/2021/07/screenshot-2021-07-26-at-11-38-31-jaeger-ui.png data-srcset="/assets/images/2021/07/screenshot-2021-07-26-at-11-38-31-jaeger-ui.png, /assets/images/2021/07/screenshot-2021-07-26-at-11-38-31-jaeger-ui.png 1.5x, /assets/images/2021/07/screenshot-2021-07-26-at-11-38-31-jaeger-ui.png 2x" data-sizes=auto alt=/assets/images/2021/07/screenshot-2021-07-26-at-11-38-31-jaeger-ui.png title=jaeger1>
<img class=lazyload src=/svg/loading.min.svg data-src=/assets/images/2021/07/screenshot-2021-07-26-at-11-38-15-jaeger-ui.png data-srcset="/assets/images/2021/07/screenshot-2021-07-26-at-11-38-15-jaeger-ui.png, /assets/images/2021/07/screenshot-2021-07-26-at-11-38-15-jaeger-ui.png 1.5x, /assets/images/2021/07/screenshot-2021-07-26-at-11-38-15-jaeger-ui.png 2x" data-sizes=auto alt=/assets/images/2021/07/screenshot-2021-07-26-at-11-38-15-jaeger-ui.png title=jaeger2></p><h2 id=conclusion>Conclusion</h2><p>Je ne vais pas exposer l&rsquo;implémentation des tests unitaires et d&rsquo;intégration. Si vous voulez voir comment j&rsquo;ai réussi à mocker simplement les appels REST à une API distante, vous pouvez regarder <a href=https://github.com/alexandre-touret/bookstore_spring/blob/main/rest-book/src/test/java/info/touret/bookstore/spring/book/controller/BookControllerIT.java target=_blank rel="noopener noreffer">cette classe</a> pour voir une utilisation du <a href=https://www.baeldung.com/mockserver target=_blank rel="noopener noreffer">MockServer</a>.<br>Aussi, n&rsquo;hésitez pas à cloner, tester ce projet et me donner votre retour. J&rsquo;essaierai de le mettre à jour au fur et à mesure de mes découvertes (par ex. OpenTelemetry).</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Mis à jour le 2023-03-02&nbsp;<a class=git-hash href=https://github.com/alexandre-touret/alexandre-touret.github.io/commit/375bd449aa0d25e75c30b33fdae2da7a4b75de66 target=_blank title="commit by Alexandre Touret(alexandre-touret@users.noreply.github.com) 375bd449aa0d25e75c30b33fdae2da7a4b75de66: twitter card images">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>375bd44</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/2021/07/26/observabilite-et-circuit-breaker-avec-spring/index.md target=_blank>Lire Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Partager sur Twitter" data-sharer=twitter data-url=/2021/07/26/observabilite-et-circuit-breaker-avec-spring/ data-title="Observabilité et Circuit Breaker avec Spring" data-via=touret_alex data-hashtags=github,java,observability,planetlibre,spring><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Partager sur Linkedin" data-sharer=linkedin data-url=/2021/07/26/observabilite-et-circuit-breaker-avec-spring/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Partager sur Hacker News" data-sharer=hackernews data-url=/2021/07/26/observabilite-et-circuit-breaker-avec-spring/ data-title="Observabilité et Circuit Breaker avec Spring"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/github/>github</a>,&nbsp;<a href=/tags/java/>java</a>,&nbsp;<a href=/tags/observability/>observability</a>,&nbsp;<a href=/tags/planetlibre/>planetlibre</a>,&nbsp;<a href=/tags/spring/>spring</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Retour</a></span>&nbsp;|&nbsp;<span><a href=/>Accueil</a></span></section></div><div class=post-nav><a href=/2021/06/10/ajouter-un-mode-maintenance-a-votre-api-grace-a-spring-boot/ class=prev rel=prev title="Ajouter un mode « maintenance » à votre API grâce à Spring boot"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Ajouter un mode « maintenance » à votre API grâce à Spring boot</a>
<a href=/2021/12/06/migrer-un-blog-wordpress-vers-github-io/ class=next rel=next title="Migrer son blog Wordpress vers GitHub">Migrer son blog Wordpress vers GitHub<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=utterances class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><a rel=me href=https://piaille.fr/@alexandre></a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2018 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://blog.touret.info target=_blank>Alexandre Touret</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by/4.0/ target=_blank>CC BY 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Retour en Haut"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="Afficher les Commentaires"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.fr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copier dans le presse-papiers",maxShownLines:50},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"alexandre-touret/alexandre-touret.github.io"}},lightgallery:!0,search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"fr",maxResultLength:10,noResultsFound:"Aucun résultat trouvé",snippetLength:50,type:"lunr"},twemoji:!0}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F1EK89MHJD",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-F1EK89MHJD" async></script></body></html>