<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Faire des batchs "Cloud Native" dans Kubernetes - Alexandre Touret's Blog</title><meta name=Description content="Alexandre Touret's Blog"><meta property="og:url" content="https://blog.touret.info/2022/05/17/cloud-native-batchs/">
<meta property="og:site_name" content="Alexandre Touret's Blog"><meta property="og:title" content='Faire des batchs "Cloud Native" dans Kubernetes'><meta property="og:description" content="Quand on parle du Cloud et de Kubernetes, généralement on pense aux APIs. Mais qu’en est-il des batchs?
Oui, depuis plusieurs années, on pensait les éradiquer, mais ils sont encore là et on en a encore besoin pour quelques années encore. Ils ont même eu une deuxième jeunesse avec le Big Data et l’explosion des volumétries dans l’IT.
Je vais essayer de faire un tour d’horizon dans cet article des batchs dans un environnement Cloud et plus particulièrement dans Kubernetes."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-17T08:00:00+00:00"><meta property="article:modified_time" content="2023-03-02T18:52:03+01:00"><meta property="article:tag" content="Cloud"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Batch"><meta property="og:image" content="https://blog.touret.info/assets/images/2022/05/pat-whelen-xSsWBa4rb6E-unsplash.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.touret.info/assets/images/2022/05/pat-whelen-xSsWBa4rb6E-unsplash.webp"><meta name=twitter:title content='Faire des batchs "Cloud Native" dans Kubernetes'><meta name=twitter:description content="Quand on parle du Cloud et de Kubernetes, généralement on pense aux APIs. Mais qu’en est-il des batchs?
Oui, depuis plusieurs années, on pensait les éradiquer, mais ils sont encore là et on en a encore besoin pour quelques années encore. Ils ont même eu une deuxième jeunesse avec le Big Data et l’explosion des volumétries dans l’IT.
Je vais essayer de faire un tour d’horizon dans cet article des batchs dans un environnement Cloud et plus particulièrement dans Kubernetes."><meta name=twitter:site content="@touret_alex"><meta name=application-name content="Alexandre Touret's Blog"><meta name=apple-mobile-web-app-title content="Alexandre Touret's Blog"><meta name=theme-color content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><meta name=twitter:creator content="@touret_alex"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://blog.touret.info/2022/05/17/cloud-native-batchs/><link rel=prev href=https://blog.touret.info/2022/02/09/analyser-les-risques-pour-mieux-definir-une-architecture/><link rel=next href=https://blog.touret.info/2022/06/10/camping-speakers-2022/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><meta name=google-site-verification content="7UnqNmvO-mjfMkRqKaaWRPTBxSylEVJXvAn8iTfc7SI"><meta name=msvalidate.01 content="F9655A4C8648E42154ECB4B4D6CF60A2"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Faire des batchs \"Cloud Native\" dans Kubernetes","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.touret.info/2022/05/17/cloud-native-batchs/"},"image":["https://blog.touret.info/images/alexandre.touret.webp"],"genre":"posts","keywords":"cloud, kubernetes, batch","wordcount":1867,"url":"https://blog.touret.info/2022/05/17/cloud-native-batchs/","datePublished":"2022-05-17T08:00:00+00:00","dateModified":"2023-03-02T18:52:03+01:00","license":"This work is licensed under a Creative Commons Attribution 4.0 International License.","publisher":{"@type":"Organization","name":"Alexandre Touret","logo":"https://blog.touret.info/images/alexandre.touret.webp"},"author":{"@type":"Person","name":"Alexandre Touret"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"||"auto"==="black"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Alexandre Touret's Blog"><span id=desktop-header-typeit class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/contact/>Contact </a><a class=menu-item href=/talks/>Talks </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i>
</span></span><a href=javascript:void(0); class="menu-item theme-select" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-desktop title="Switch Theme"><option value=light>Light</option><option value=dark>Dark</option><option value=black>Black</option><option value=auto>Auto</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Alexandre Touret's Blog"><span id=mobile-header-typeit class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/contact/ title>Contact</a><a class=menu-item href=/talks/ title>Talks</a><a class=menu-item href=/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-select" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-mobile title="Switch Theme"><option value=light>Light</option><option value=dark>Dark</option><option value=black>Black</option><option value=auto>Auto</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#pourquoi-des-batchs-dans-le-cloud>Pourquoi des batchs dans le Cloud?</a><ul><li><a href=#pourquoi-se-poser-cette-question>Pourquoi se poser cette question?</a></li></ul></li><li><a href=#difficultés-par-rapport-aux-apis>Difficulté(s) par rapport aux APIs</a><ul><li><a href=#quelques-technologies>Quelques technologies</a></li></ul></li><li><a href=#modes-de-déclenchement>Modes de déclenchement</a></li><li><a href=#contraintes>Contraintes</a><ul><li><a href=#gestion-des-erreurs-et-indisponibilités>Gestion des erreurs et indisponibilités</a></li><li><a href=#données-et-idempotence-des-traitements>Données et idempotence des traitements</a></li><li><a href=#gestion-des-ressources>Gestion des ressources</a></li></ul></li><li><a href=#traitement-sur-réception-de-fichiers>Traitement sur réception de fichiers</a></li><li><a href=#traitement-déclenché-à-distance-par-ex-par-un-orchestrateur-de-traitements>Traitement déclenché à distance (par ex. par un orchestrateur de traitements)</a><ul><li><a href=#avec-une-api>Avec une API</a></li><li><a href=#avec-des-jobs>Avec des jobs</a></li></ul></li><li><a href=#traitement-déclenché-par-cron>Traitement déclenché par CRON</a></li><li><a href=#panorama-des-solutions-logicielles-possibles>Panorama des solutions logicielles possibles</a></li><li><a href=#le-diable-se-cache-dans-les-détails>Le diable se cache dans les détails</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Faire des batchs "Cloud Native" dans Kubernetes</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class="author fas fa-user-circle fa-fw"></span><a href=https://blog.touret.info title=Author target=_blank rel="noopener noreferrer author" class=author>Alexandre Touret</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-05-17>2022-05-17</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2023-03-02>2023-03-02</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1867 words&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;9 minutes&nbsp;</div></div><div class=featured-image><img loading=eager src=/assets/images/2022/05/pat-whelen-xSsWBa4rb6E-unsplash.webp srcset="/assets/images/2022/05/pat-whelen-xSsWBa4rb6E-unsplash.webp, /assets/images/2022/05/pat-whelen-xSsWBa4rb6E-unsplash.webp 1.5x, /assets/images/2022/05/pat-whelen-xSsWBa4rb6E-unsplash.webp 2x" title=/assets/images/2022/05/pat-whelen-xSsWBa4rb6E-unsplash.webp></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#pourquoi-des-batchs-dans-le-cloud>Pourquoi des batchs dans le Cloud?</a><ul><li><a href=#pourquoi-se-poser-cette-question>Pourquoi se poser cette question?</a></li></ul></li><li><a href=#difficultés-par-rapport-aux-apis>Difficulté(s) par rapport aux APIs</a><ul><li><a href=#quelques-technologies>Quelques technologies</a></li></ul></li><li><a href=#modes-de-déclenchement>Modes de déclenchement</a></li><li><a href=#contraintes>Contraintes</a><ul><li><a href=#gestion-des-erreurs-et-indisponibilités>Gestion des erreurs et indisponibilités</a></li><li><a href=#données-et-idempotence-des-traitements>Données et idempotence des traitements</a></li><li><a href=#gestion-des-ressources>Gestion des ressources</a></li></ul></li><li><a href=#traitement-sur-réception-de-fichiers>Traitement sur réception de fichiers</a></li><li><a href=#traitement-déclenché-à-distance-par-ex-par-un-orchestrateur-de-traitements>Traitement déclenché à distance (par ex. par un orchestrateur de traitements)</a><ul><li><a href=#avec-une-api>Avec une API</a></li><li><a href=#avec-des-jobs>Avec des jobs</a></li></ul></li><li><a href=#traitement-déclenché-par-cron>Traitement déclenché par CRON</a></li><li><a href=#panorama-des-solutions-logicielles-possibles>Panorama des solutions logicielles possibles</a></li><li><a href=#le-diable-se-cache-dans-les-détails>Le diable se cache dans les détails</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div><div class=content id=content><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fwnote"></i>Note<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>This article was last updated on <span class=timeago datetime=2023-03-02T18:52:03 title="March 2, 2023">2023-03-02</span>, the content may be out of date.</div></div></div><p>Quand on parle du Cloud et de Kubernetes, généralement on pense aux APIs.
Mais qu&rsquo;en est-il des batchs?</p><p>Oui, depuis plusieurs années, on pensait les éradiquer, mais ils sont encore là et on en a encore besoin pour quelques années encore.
Ils ont même eu une deuxième jeunesse avec le Big Data et l&rsquo;explosion des volumétries dans l&rsquo;IT.</p><p>Je vais essayer de faire un tour d&rsquo;horizon dans cet article des batchs dans un environnement Cloud et plus particulièrement dans Kubernetes.</p><p>Les exemples présentés dans cet article seront (sans doute) approfondis dans un second article et d&rsquo;ores et déjà disponibles dans <a href=https://github.com/alexandre-touret/k8s-batch target=_blank rel="noopener noreferrer">mon GitHub</a>.</p><h2 id=pourquoi-des-batchs-dans-le-cloud class=headerLink><a href=#pourquoi-des-batchs-dans-le-cloud class=header-mark></a>1 Pourquoi des batchs dans le Cloud?</h2><p>A ce titre un peu provocateur, j&rsquo;ajouterais aussi <em>&ldquo;Pourquoi des batchs dans Kubernetes ?&rdquo;</em>.</p><p>Oui, aujourd&rsquo;hui encore,comme j&rsquo;ai pu l&rsquo;indiquer précédemment, on doit créer des traitements batchs. A coté des APIs qui représentent le cas d&rsquo;utilisation &ldquo;standard&rdquo; du Cloud, on peut également avoir à traiter des fichiers volumineux allant de plusieurs centaines de Mo à quelques Go.</p><p>Parmi les cas d&rsquo;utilisation qui nécessitent ce genre de traitement, on pourra avoir:</p><ul><li>Les reprises de données (suite à des erreurs ou lors d&rsquo;une initialisation)</li><li>Traitement suite à une réception de fichiers (par ex. traitement de fichiers OPENDATA)</li></ul><p>Si vous êtes déjà passé sur le Cloud pour vos applications transactionnelles, vous vous poserez cette question: <em>Puis-je également déployer des batchs?</em></p><h3 id=pourquoi-se-poser-cette-question class=headerLink><a href=#pourquoi-se-poser-cette-question class=header-mark></a>1.1 Pourquoi se poser cette question?</h3><p>Les réponses sont multiples.
Elles sont tout d&rsquo;abord liées à une rationalisation des environnements.
Vous avez votre application dans le cloud, votre base de données y est également gérée pour éviter la latence réseau.
Vous devez donc déployer des traitements tiers au plus proche de celle-ci pour vous soustraire des mêmes soucis.</p><p>De plus, l&rsquo;écosystème lié au cloud offre des technologies et pratiques qui rendent la vie plus simple (si, si, je vous assure) aux développeurs et ops.
Le déploiement via <a href=https://en.wikipedia.org/wiki/Infrastructure_as_code target=_blank rel="noopener noreferrer">l&rsquo;Infra As Code</a> est un bon exemple : Avoir toute l&rsquo;infrastructure liée aux traitements batchs et transactionnels versionnées et instantiables à la demande est quelque chose dont on a du mal à se passer!</p><h2 id=difficultés-par-rapport-aux-apis class=headerLink><a href=#difficult%c3%a9s-par-rapport-aux-apis class=header-mark></a>2 Difficulté(s) par rapport aux APIs</h2><p>Quand on déploie une API dans le cloud, généralement tout va bien.
On peut voir rapidement que cet environnement convient bien à ce genre de traitements.</p><p>Pour les batchs, c&rsquo;est une autre affaire!
Selon les sociétés, il peut y avoir un fort historique et beaucoup plus d&rsquo;exigences que pour les APIs.
Ces dernières pourront être liées aux performances, à la qualité de service ou plus simplement à l&rsquo;utilisation.</p><p>Il faut donc, à l&rsquo;instar de toute architecture, déterminer quel sera l&rsquo;environnement technique de ce type de traitement.
Cette fois, on aura à concilier performances, fichiers volumineux et reprises sur erreur.</p><h3 id=quelques-technologies class=headerLink><a href=#quelques-technologies class=header-mark></a>2.1 Quelques technologies</h3><p>On pourra retrouver dans notre future architecture les briques suivantes:</p><ul><li>Une passerelle de fichiers (File Gateway) pour permettre l&rsquo;envoi des fichiers de manière sécurisée</li><li>Un stockage objet pour la distribution de fichiers ou l&rsquo;archivage.</li><li>Les éléments nécessaires à l&rsquo;API : bases de données, <a href=https://en.wikipedia.org/wiki/Hardware_security_module target=_blank rel="noopener noreferrer">HSMs</a>, Cluster Kubernetes,&mldr;</li></ul><h2 id=modes-de-déclenchement class=headerLink><a href=#modes-de-d%c3%a9clenchement class=header-mark></a>3 Modes de déclenchement</h2><p>Si on regarde de plus près les exigences techniques liées aux cas d&rsquo;utilisation, on pourrait résumer les différents modes de déclenchement de la manière suivante:</p><ul><li>Traitement sur réception de fichiers</li><li>Traitement déclenché par un ordonnanceur/orchestrateur centralisé (ex. <a href=https://dkron.io/ target=_blank rel="noopener noreferrer">https://dkron.io/</a>) de manière régulière ou non.</li><li>Traitement déclenché par <a href=https://en.wikipedia.org/wiki/Cron target=_blank rel="noopener noreferrer">CRON</a> (qui est un ordonnanceur, mais un peu plus roots)</li></ul><p>J&rsquo;ai volontairement exclu les traitements sur présence de messages (ex. Kafka). Je les considère plus liés au monde transactionnel.</p><p>Dans les paragraphes suivants, je vais décrire des solutions d&rsquo;architecture qui permettent de déployer ces traitements dans Kubernetes. J&rsquo;aborderai sans doute un exemple dans un autre article</p><h2 id=contraintes class=headerLink><a href=#contraintes class=header-mark></a>4 Contraintes</h2><p>Dès qu&rsquo;on s&rsquo;aventure dans ce type de conception, nous aurons, au-delà des <a href=https://12factor.net/ target=_blank rel="noopener noreferrer">12 factors</a>, les contraintes suivantes à traiter:</p><h3 id=gestion-des-erreurs-et-indisponibilités class=headerLink><a href=#gestion-des-erreurs-et-indisponibilit%c3%a9s class=header-mark></a>4.1 Gestion des erreurs et indisponibilités</h3><p>Dans un cluster Kubernetes, le crash d&rsquo;un POD n&rsquo;est pas rédhibitoire.
Le cluster permet de redémarrer immédiatement une autre instance.</p><p>Pour les APIs, ce n&rsquo;est pas un problème.
Pour les batchs, c&rsquo;est une autre paire de manches.
Quid du crash en plein milieu du traitement d&rsquo;un fichier?</p><p>Il faut donc penser à ce cas (et à d&rsquo;autres) et archiver les fichiers pour un éventuel rejeu.</p><h3 id=données-et-idempotence-des-traitements class=headerLink><a href=#donn%c3%a9es-et-idempotence-des-traitements class=header-mark></a>4.2 Données et idempotence des traitements</h3><p>Idéalement, les fichiers doivent avoir des lignes indépendantes qui peuvent être insérées individuellement et dans n&rsquo;importe quel ordre.
Aussi, chaque modification et traitement de données doivent être idempotentes.</p><p>Pourquoi? Pas seulement par ce que c&rsquo;est sympa et l&rsquo;état de l&rsquo;art, mais dans ce nouvel environnement, vous ne pourrez pas forcément garantir l&rsquo;ordre des traitements.
L&rsquo;une des solutions potentielles de traitement est de découpler la lecture et l&rsquo;insertion par du queueing (Artemis, Kafka <em>- oui ce n&rsquo;est pas du queuing, mais vous avez compris&mldr;</em>).
Dans ce cas, si votre traitement n&rsquo;est pas idempotent, vous devrez lutter avec des doublons en base.</p><h3 id=gestion-des-ressources class=headerLink><a href=#gestion-des-ressources class=header-mark></a>4.3 Gestion des ressources</h3><p>Imaginez, vous recevez un fichier de 1Go.
Vos ressources systèmes sont des PODs avec un 1 Go de RAM.</p><p>Vous voyez le soucis?</p><p>Cet exemple, qui n&rsquo;est pas trop éloigné de la réalité, mets en évidence l&rsquo;une des contraintes techniques que vous devrez prendre dès le début de votre conception.</p><p>L&rsquo;une des solutions serait, par exemple, le traitement quasi systématique du streaming de fichiers et l&rsquo;obligation d&rsquo;avoir des fichiers avec des lignes de données indépendantes (c.-à-d. sans avoir à faire de liens inter lignes pendant le traitement).</p><h2 id=traitement-sur-réception-de-fichiers class=headerLink><a href=#traitement-sur-r%c3%a9ception-de-fichiers class=header-mark></a>5 Traitement sur réception de fichiers</h2><p>Dans ce cas, nous avons un processus qui est déclenché lors de la réception d&rsquo;un fichier. Nous pourrons par exemple avec ce genre d&rsquo;architecture un fichier qui est envoyé dans espace de stockage objet. Ce dernier est ensuite traité par un programme.
J&rsquo;ai fait le choix ici de mettre en oeuvre un couplage lâche (on ne se refait pas) entre l&rsquo;espace de réception de fichiers et le traitement.</p><p>Je traite ici le risque de crash d&rsquo;un POD en gardant systématiquement les fichiers dans un stockage objet. De cette manière, si le traitement a échoué, un autre POD pourra le télécharger et rejouer le processus batch.</p><p>Ce découplage permet de gérer facilement la scalabilité et les arrêts/relances de PODs.</p><figure><img src=/assets/images/2022/05/batch_evenement-Batch_sur_presence_fichier.svg><figcaption><h4>Batch démarré sur présence de fichier</h4></figcaption></figure><p>Dans ce cas, le batch pourra être déployé sous la forme d&rsquo;un <a href=https://kubernetes.io/docs/concepts/workloads/controllers/deployment/ target=_blank rel="noopener noreferrer">déploiement Kubernetes</a>.</p><h2 id=traitement-déclenché-à-distance-par-ex-par-un-orchestrateur-de-traitements class=headerLink><a href=#traitement-d%c3%a9clench%c3%a9-%c3%a0-distance-par-ex-par-un-orchestrateur-de-traitements class=header-mark></a>6 Traitement déclenché à distance (par ex. par un orchestrateur de traitements)</h2><p>Maintenant, on va aborder les traitements qui sont lancés par un ordonnanceur tiers ou tout simplement lancé à distance.
Généralement, dans le monde de l&rsquo;entreprise, la planification des traitements est centralisée au lieu de laisser de le faire sur chaque machine avec des <a href=https://en.wikipedia.org/wiki/Cron target=_blank rel="noopener noreferrer">CRON Jobs</a>.</p><p>Dans ce cas, on a deux manières de procéder:</p><ul><li>Avoir un traitement qui fournit une API permettant de démarrer des traitements et d&rsquo;avoir leurs statuts.</li><li>Lancer des jobs.</li></ul><h3 id=avec-une-api class=headerLink><a href=#avec-une-api class=header-mark></a>6.1 Avec une API</h3><p>Ici, on conçoit les batchs comme des WEBAPPS qui fournissent des traitements batchs sur demande via des APIs. La contrainte est qu&rsquo;à l&rsquo;instar de la solution précédente, le programme tourne toujours et n&rsquo;est vraiment utile que lorsqu&rsquo;il est appelé via un endpoint REST.</p><p>Ce modèle de conception peut être utilisé à mon avis si la fréquence est forte et si l&rsquo;intégration d&rsquo;un Job Kubernetes est problématique pour vous (voir ci-dessous).</p><p>L&rsquo;un des avantages que l&rsquo;on pourra trouver est que le <a href=https://kubernetes.io/docs/concepts/workloads/controllers/deployment/ target=_blank rel="noopener noreferrer">mode de déploiement est assez simple et similaire aux APIs</a>.</p><figure><img src=/assets/images/2022/05/traitement_api.svg><figcaption><h4>Batch démarré par une API</h4></figcaption></figure><h3 id=avec-des-jobs class=headerLink><a href=#avec-des-jobs class=header-mark></a>6.2 Avec des jobs</h3><p>Si votre ordonnanceur peut exécuter le client kubectl, vous pourrez considérer les <a href=https://kubernetes.io/docs/concepts/workloads/controllers/job/ target=_blank rel="noopener noreferrer">jobs kubernetes</a>.</p><p>En résumé, ils permettent de créer un POD et exécute une action en gérant les erreurs potentielles jusqu&rsquo;à complétion du traitement.</p><p>Par exemple, voici un job permettant de faire un &ldquo;Hello World!&rdquo;:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>hello-world</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;echo&#34;</span><span class=p>,</span><span class=w>  </span><span class=s2>&#34;Hello World!&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>backoffLimit</span><span class=p>:</span><span class=w> </span><span class=m>4</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Une fois déployé avec Helm, vous pouvez les voir avec la commande <code>kubectl get jobs</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>minikube kubectl -- get <span class=nb>jobs</span>
</span></span><span class=line><span class=cl>NAME          COMPLETIONS   DURATION   AGE
</span></span><span class=line><span class=cl>hello-world   0/1           25s        25s
</span></span></code></pre></td></tr></table></div></div><p>Pour les logs et voir le résultat de la commande lancé, cela se passe d&rsquo;une manière assez habituelle:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>minikube kubectl -- logs hello-world-zx4wh
</span></span><span class=line><span class=cl>Hello World!
</span></span></code></pre></td></tr></table></div></div><h2 id=traitement-déclenché-par-cron class=headerLink><a href=#traitement-d%c3%a9clench%c3%a9-par-cron class=header-mark></a>7 Traitement déclenché par CRON</h2><p>Maintenant, on va laisser le soin au Cluster Kubernetes de lancer les différents traitements via une CRON.
Bien que je ne suis pas trop fan de ne pas centraliser l&rsquo;ordonnancement, cela peut être très utile si votre plateforme est centrée sur Kubernetes.</p><p>Si vous êtes dans ce cas-là, vous pouvez utiliser l&rsquo;objet <a href=https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/ target=_blank rel="noopener noreferrer">CronJob</a> qui n&rsquo;est ni plus ni moins qu&rsquo;un <a href=https://kubernetes.io/docs/concepts/workloads/controllers/job/ target=_blank rel="noopener noreferrer">Job</a> exécuté de manière périodique.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CronJob</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>hello</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>schedule</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;* * * * *&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jobTemplate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>helloworld-cron</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;echo&#34;</span><span class=p>,</span><span class=w>  </span><span class=s2>&#34;Hello World!&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>OnFailure</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=panorama-des-solutions-logicielles-possibles class=headerLink><a href=#panorama-des-solutions-logicielles-possibles class=header-mark></a>8 Panorama des solutions logicielles possibles</h2><p>Une fois qu&rsquo;on s&rsquo;est posé toutes (en tout cas certaines) les questions possibles sur nos exigences techniques et la conception, on peut voir quelles sont les technologies possibles pour implémenter des batchs &ldquo;cloud natifs&rdquo;.</p><p>Ça ne sera pas une surprise, je vais m&rsquo;attarder à la plateforme Java. Il est bien évidemment possible d&rsquo;utiliser d&rsquo;autres langages et frameworks tels que Go.</p><p>En Java, vous avez le choix entre différents frameworks :</p><ul><li>[Spring avec spring batch]([Spring avec spring batch et/ou integration
) et/ou <a href=https://spring.io/projects/spring-integration target=_blank rel="noopener noreferrer">integration</a></li><li><a href=https://camel.apache.org/ target=_blank rel="noopener noreferrer">Camel</a> qui peut être utilisé avec <a href=https://camel.apache.org/manual/spring.html target=_blank rel="noopener noreferrer">Spring</a> ou <a href=https://quarkus.io/ target=_blank rel="noopener noreferrer">Quarkus</a></li><li><a href=https://quarkus.io/ target=_blank rel="noopener noreferrer">Quarkus</a> avec la <a href=https://github.com/quarkiverse/quarkus-jberet target=_blank rel="noopener noreferrer">JSR 352</a></li></ul><p>Si vous allez du côté du BigData, vous pouvez aussi envisager d&rsquo;utiliser des technologies telles qu&rsquo;<a href=https://spark.apache.org/ target=_blank rel="noopener noreferrer">Apache Spark</a>.
Ces dernières vous permettront de <a href=https://spark.apache.org/docs/latest/running-on-kubernetes.html target=_blank rel="noopener noreferrer">découper &ldquo;plus facilement&rdquo; vos traitements</a>.</p><h2 id=le-diable-se-cache-dans-les-détails class=headerLink><a href=#le-diable-se-cache-dans-les-d%c3%a9tails class=header-mark></a>9 Le diable se cache dans les détails</h2><p>Déployer un batch dans Kubernetes peut se faire assez facilement (en développement) une fois qu&rsquo;on a compris quelques principes.
Cependant, les soucis peuvent survenir une fois arrivé en production.</p><p>La gestion des erreurs est beaucoup plus complexe que les APIs. Il vous faudra donc définir avec les différentes parties prenantes quel est le meilleur fonctionnement (rejeu) en production.
Il vous faudra ainsi bien <a href=https://blog.touret.info/2022/02/09/analyser-les-risques-pour-mieux-definir-une-architecture/ target=_blank rel="noopener noreferrer">identifier et évaluer les risques liés à votre application</a> et voir quelles sont les actions à mener.</p><p>Aussi, si vous devez manipuler des fichiers volumineux, il faudra faire attention au système de fichiers utilisé et ses performances. Habituellement, avec ce type d&rsquo;architecture, on utilise généralement du SAN. En fonction de vos exigences, un <a href=https://www.redhat.com/fr/topics/data-storage/file-block-object-storage target=_blank rel="noopener noreferrer">stockage block</a> pourra être plus adapté.</p><h2 id=conclusion class=headerLink><a href=#conclusion class=header-mark></a>10 Conclusion</h2><p>Pour conclure cet article, vous aurez compris que le sujet des batchs dans Kubernetes peut s&rsquo;avérer assez complexe à gérer.
Au-delà des technologies qui peuvent faire le job (<em>désolé du mauvais jeu de mots</em>), il vous faudra faire très attention à tout l&rsquo;environnement dans lequel votre programme devra interagir. Les bases, le réseau, les performances de votre matériel seront des prérequis indispensables.</p><p>Aussi, il vous faudra faire attention à la manière dont sont transmises les données et dont vous les traitez.
Bref, il faut étudier la solution dans son ensemble du développement à l&rsquo;exploitation pour s&rsquo;assurer de ne rien oublier.</p><p>Enfin, cet article n&rsquo;est bien évidemment pas exhaustif que cela soit sur les solutions ou les contraintes à adresser.
J&rsquo;ai néanmoins essayé d&rsquo;apporter quelques cas concrets et retours d&rsquo;expérience.</p><p>J&rsquo;essaierai de détailler un cas concret dans un prochain article.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-03-02&nbsp;<a class=git-hash href=https://github.com/alexandre-touret/alexandre-touret.github.io/commit/3ca23e90dd13f01a99e313e69e6880790fa40161 target=_blank title="commit by Alexandre Touret(alexandre-touret@users.noreply.github.com) 3ca23e90dd13f01a99e313e69e6880790fa40161: twitter card images" rel="noopener noreferrer">
<i class="fas fa-hashtag fa-fw"></i>3ca23e90</a></span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-mardown href=/2022/05/17/cloud-native-batchs/index.md target=_blank rel="noopener noreferrer">Read markdown</a>
</span><span>|&nbsp;<a class=link-to-source href=https://github.com/alexandre-touret/alexandre-touret.github.io/blob/main/exampleSite/content/posts/cloud-native-batchs.md target=_blank rel="noopener noreferrer">View source</a>
</span><span>|&nbsp;<a class=link-to-report href="https://github.com/alexandre-touret/alexandre-touret.github.io/issues/new?title=[bug]%20Faire+des+batchs+%22Cloud+Native%22+dans+Kubernetes&body=|Field|Value|%0A|-|-|%0A|Title|Faire+des+batchs+%22Cloud+Native%22+dans+Kubernetes|%0A|Url|https://blog.touret.info/2022/05/17/cloud-native-batchs/|%0A|Filename|https://github.com/HEIGE-PCloud/DoIt/blob/main/exampleSite/content/posts/cloud-native-batchs.md|" target=_blank rel="noopener noreferrer">Report issue</a></span></div><div class=post-info-share></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/cloud/>Cloud</a>,&nbsp;<a href=/tags/kubernetes/>Kubernetes</a>,&nbsp;<a href=/tags/batch/>Batch</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/2022/02/09/analyser-les-risques-pour-mieux-definir-une-architecture/ class=prev rel=prev title="Mieux analyser les risques pour simplifier les architectures (ou pas)"><i class="fas fa-angle-left fa-fw"></i>Mieux analyser les risques pour simplifier les architectures (ou pas)</a>
<a href=/2022/06/10/camping-speakers-2022/ class=next rel=next title="Mon Camping des Speakers">Mon Camping des Speakers<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.134.1">Hugo</a>&nbsp;|&nbsp;Theme - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.4.0"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://blog.touret.info target=_blank rel="noopener noreferrer">Alexandre Touret</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by/4.0/ target=_blank>CC BY 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"alexandre-touret/alexandre-touret.github.io"}},data:{"desktop-header-typeit":"blog.touret.info","mobile-header-typeit":"blog.touret.info"},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!0,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"No results found",snippetLength:300,threshold:.1,type:"fuse",useExtendedSearch:!1},table:{sort:!0},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},duration:-1,speed:100}}</script><script type=text/javascript src=/lib/tablesort/tablesort.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/typeit/typeit.min.js></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=/js/utterances.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F1EK89MHJD",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-F1EK89MHJD" async></script></div></body></html>