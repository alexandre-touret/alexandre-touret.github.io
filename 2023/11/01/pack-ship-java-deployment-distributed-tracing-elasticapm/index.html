<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Streamline Java Application Deployment: Pack, Ship, and Unlock Distributed Tracing with Elastic APM on Kubernetes - Alexandre Touret's Blog</title><meta name=Description content="Alexandre Touret's Blog"><meta property="og:url" content="https://blog.touret.info/2023/11/01/pack-ship-java-deployment-distributed-tracing-elasticapm/">
<meta property="og:site_name" content="Alexandre Touret's Blog"><meta property="og:title" content="Streamline Java Application Deployment: Pack, Ship, and Unlock Distributed Tracing with Elastic APM on Kubernetes"><meta property="og:description" content="In my last article, I dug into Distributed Tracing and exposed how to enable it in Java applications. We didn’t see yet how to deploy an application on Kubernetes and get distributed tracing insights. Several strategies can be considered, but the main point is how to minimize the impact of deploying APM agents on the whole delivery process.
In this article, I will expose how to ship APM agents for instrumenting Java applications deployed on top of Kubernetes through Docker containers."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-11-01T08:00:00+02:00"><meta property="article:modified_time" content="2023-11-01T19:01:19+01:00"><meta property="article:tag" content="Distributed_Tracing"><meta property="article:tag" content="Java"><meta property="article:tag" content="APM"><meta property="article:tag" content="Docker"><meta property="article:tag" content="Elastic"><meta property="og:image" content="https://blog.touret.info/assets/images/2023/10/claudio-schwarz-q8kR_ie6WnI-unsplash.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.touret.info/assets/images/2023/10/claudio-schwarz-q8kR_ie6WnI-unsplash.webp"><meta name=twitter:title content="Streamline Java Application Deployment: Pack, Ship, and Unlock Distributed Tracing with Elastic APM on Kubernetes"><meta name=twitter:description content="In my last article, I dug into Distributed Tracing and exposed how to enable it in Java applications. We didn’t see yet how to deploy an application on Kubernetes and get distributed tracing insights. Several strategies can be considered, but the main point is how to minimize the impact of deploying APM agents on the whole delivery process.
In this article, I will expose how to ship APM agents for instrumenting Java applications deployed on top of Kubernetes through Docker containers."><meta name=twitter:site content="@touret_alex"><meta name=application-name content="Alexandre Touret's Blog"><meta name=apple-mobile-web-app-title content="Alexandre Touret's Blog"><meta name=theme-color content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><meta name=twitter:creator content="@touret_alex"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://blog.touret.info/2023/11/01/pack-ship-java-deployment-distributed-tracing-elasticapm/><link rel=prev href=https://blog.touret.info/2023/09/05/distributed-tracing-opentelemetry-camel-artemis/><link rel=next href=https://blog.touret.info/2023/11/09/rancher_desktop_wsl2/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><meta name=google-site-verification content="7UnqNmvO-mjfMkRqKaaWRPTBxSylEVJXvAn8iTfc7SI"><meta name=msvalidate.01 content="F9655A4C8648E42154ECB4B4D6CF60A2"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Streamline Java Application Deployment: Pack, Ship, and Unlock Distributed Tracing with Elastic APM on Kubernetes","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.touret.info/2023/11/01/pack-ship-java-deployment-distributed-tracing-elasticapm/"},"image":["https://blog.touret.info/images/alexandre.touret.webp"],"genre":"posts","keywords":"Distributed_Tracing, Java, APM, Docker, Elastic","wordcount":870,"url":"https://blog.touret.info/2023/11/01/pack-ship-java-deployment-distributed-tracing-elasticapm/","datePublished":"2023-11-01T08:00:00+02:00","dateModified":"2023-11-01T19:01:19+01:00","license":"This work is licensed under a Creative Commons Attribution 4.0 International License.","publisher":{"@type":"Organization","name":"Alexandre Touret","logo":"https://blog.touret.info/images/alexandre.touret.webp"},"author":{"@type":"Person","name":"Alexandre Touret"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"||"auto"==="black"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Alexandre Touret's Blog"><span id=desktop-header-typeit class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/contact/>Contact </a><a class=menu-item href=/talks/>Talks </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i>
</span></span><a href=javascript:void(0); class="menu-item theme-select" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-desktop title="Switch Theme"><option value=light>Light</option><option value=dark>Dark</option><option value=black>Black</option><option value=auto>Auto</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Alexandre Touret's Blog"><span id=mobile-header-typeit class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/contact/ title>Contact</a><a class=menu-item href=/talks/ title>Talks</a><a class=menu-item href=/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-select" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-mobile title="Switch Theme"><option value=light>Light</option><option value=dark>Dark</option><option value=black>Black</option><option value=auto>Auto</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#why-not-bringing-apm-agents-in-our-docker-images>Why not bringing APM agents in our Docker images?</a></li><li><a href=#deploy-an-apm-agent-through-initcontainers>Deploy an APM agent through initContainers</a><ul><li><a href=#impacts-in-the-_wonderful-java-application_-docker-image>Impacts in the &ldquo;<em>Wonderful Java Application</em> Docker image</a></li><li><a href=#initcontainer-docker-image-creation>InitContainer Docker Image creation</a></li><li><a href=#kubernetes-configuration>Kubernetes configuration</a></li></ul></li><li><a href=#start-the-java-application-with-the-agent>Start the Java Application with the agent</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Streamline Java Application Deployment: Pack, Ship, and Unlock Distributed Tracing with Elastic APM on Kubernetes</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class="author fas fa-user-circle fa-fw"></span><a href=https://blog.touret.info title=Author target=_blank rel="noopener noreferrer author" class=author>Alexandre Touret</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2023-11-01>2023-11-01</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2023-11-01>2023-11-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;870 words&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;5 minutes&nbsp;</div></div><div class=featured-image><img loading=eager src=/assets/images/2023/10/claudio-schwarz-q8kR_ie6WnI-unsplash.webp srcset="/assets/images/2023/10/claudio-schwarz-q8kR_ie6WnI-unsplash.webp, /assets/images/2023/10/claudio-schwarz-q8kR_ie6WnI-unsplash.webp 1.5x, /assets/images/2023/10/claudio-schwarz-q8kR_ie6WnI-unsplash.webp 2x" title=/assets/images/2023/10/claudio-schwarz-q8kR_ie6WnI-unsplash.webp></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#why-not-bringing-apm-agents-in-our-docker-images>Why not bringing APM agents in our Docker images?</a></li><li><a href=#deploy-an-apm-agent-through-initcontainers>Deploy an APM agent through initContainers</a><ul><li><a href=#impacts-in-the-_wonderful-java-application_-docker-image>Impacts in the &ldquo;<em>Wonderful Java Application</em> Docker image</a></li><li><a href=#initcontainer-docker-image-creation>InitContainer Docker Image creation</a></li><li><a href=#kubernetes-configuration>Kubernetes configuration</a></li></ul></li><li><a href=#start-the-java-application-with-the-agent>Start the Java Application with the agent</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div><div class=content id=content><p>In <a href=https://blog.touret.info/2023/09/05/distributed-tracing-opentelemetry-camel-artemis/ target=_blank rel="noopener noreferrer">my last article</a>, I dug into <a href=https://www.w3.org/TR/trace-context/ target=_blank rel="noopener noreferrer">Distributed Tracing</a> and exposed how to enable it in Java applications.
We didn&rsquo;t see yet how to deploy an application on Kubernetes and get distributed tracing insights.
Several strategies can be considered, but the main point is how to minimize the impact of deploying APM agents on the whole delivery process.</p><p>In this article, I will expose how to ship APM agents for instrumenting Java applications deployed on top of <a href=https://kubernetes.io/ target=_blank rel="noopener noreferrer">Kubernetes</a> through <a href=https://www.docker.com/resources/what-container/ target=_blank rel="noopener noreferrer">Docker containers</a>.</p><p>To make it clearer, I will illustrate this setup by the following use case:</p><ul><li>We have an API <em>&ldquo;My wonderful API&rdquo;</em> which is instrumented through an <a href=https://www.elastic.co/guide/en/apm/agent/index.html target=_blank rel="noopener noreferrer">Elastic APM agent</a>.</li><li>The data is then sent to the <a href=https://www.elastic.co/guide/en/apm target=_blank rel="noopener noreferrer">Elastic APM</a>.</li></ul><div id=id-1><figure><img loading=lazy src=/assets/images/2023/10/architecture_system.svg srcset="/assets/images/2023/10/architecture_system.svg, /assets/images/2023/10/architecture_system.svg 1.5x, /assets/images/2023/10/architecture_system.svg 2x" title="c4 context diagram"></figure></div><p>Now, if we dive into the <em>&ldquo;Wonderful System&rdquo;</em>, we can see the <em>Wonderful Java application</em> and the agent:</p><div id=id-2><figure><img loading=lazy src=/assets/images/2023/10/architecture_container.svg srcset="/assets/images/2023/10/architecture_container.svg, /assets/images/2023/10/architecture_container.svg 1.5x, /assets/images/2023/10/architecture_container.svg 2x" title="c4 context diagram"></figure></div><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw"></i>Elastic APM vs Grafana/OpenTelemetry<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content><p>In this article I delve into how to package an <a href=https://www.elastic.co/guide/en/apm/agent/java/current/configuration.html target=_blank rel="noopener noreferrer">Elastic APM agent</a> and enable Distributed Tracing with the <a href=https://www.elastic.co/guide/en/apm/index.html target=_blank rel="noopener noreferrer">Elastic APM suite</a>.</p><p>You can do that in the same way with an <a href=https://github.com/open-telemetry/opentelemetry-java-instrumentation target=_blank rel="noopener noreferrer">OpenTelemetry Agent</a>.
Furthermore, <a href=https://www.elastic.co/fr/blog/native-opentelemetry-support-in-elastic-observability target=_blank rel="noopener noreferrer">Elastic APM is compatible with OpenTelemetry</a>.</p></div></div></div><p>We can basically implement this architecture in two different ways:</p><ol><li>Deploying the agent in all of our Docker images</li><li>Deploying the agent asides from the Docker images and using initContainers to bring the agent at the startup of our applications</li></ol><p>We will then see how to lose couple application docker images to the apm agent one.</p><h2 id=why-not-bringing-apm-agents-in-our-docker-images class=headerLink><a href=#why-not-bringing-apm-agents-in-our-docker-images class=header-mark></a>1 Why not bringing APM agents in our Docker images?</h2><p>It could be really tempting to put the APM agents in the application&rsquo;s Docker image.</p><p>Why?
Because you just have to add the following lines of code in our Docker images definition:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>RUN</span> mkdir /opt/agent<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> ./javaagent.jar /opt/agent/javaagent.jar<span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>Nonetheless, if you want to upgrade your agent, you will have to repackage it and redeploy all your Docker images.</p><p>For regular upgrades, it will not bother you, but, if you encounter a bug or a vulnerability, it will be tricky and annoying to do that.</p><p>What is why I prefer loose coupling the <em>&ldquo;business&rdquo;</em> applications Docker images to technical tools such as APM agents.</p><h2 id=deploy-an-apm-agent-through-initcontainers class=headerLink><a href=#deploy-an-apm-agent-through-initcontainers class=header-mark></a>2 Deploy an APM agent through initContainers</h2><p>While looking around how to achieve this, I came across to the <a href=https://kubernetes.io/docs/concepts/workloads/pods/init-containers/ target=_blank rel="noopener noreferrer">Kubernetes initContainers</a>.</p><p>This kind of container is run only once during the startup of every pod.
A bunch of commands is ran then on top of it.
For our current use case, it will copy the javaagent into a volume such as an <a href=https://kubernetes.io/docs/concepts/storage/volumes/#emptydir target=_blank rel="noopener noreferrer">empty directory volume</a>.</p><h3 id=impacts-in-the-_wonderful-java-application_-docker-image class=headerLink><a href=#impacts-in-the-_wonderful-java-application_-docker-image class=header-mark></a>2.1 Impacts in the &ldquo;<em>Wonderful Java Application</em> Docker image</h3><p>The main impact is to declare a volume in your Docker image:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>VOLUME</span><span class=s> /opt/agent</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>It will be used by both the Docker container and the initContainer.
We can consider it as a &ldquo;bridge&rdquo; between these two ones.</p><p>We also have to declare one environment variable: <code>JAVA_OPTS</code>.</p><p>For instance:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>ENV</span> <span class=nv>JAVA_OPTS</span><span class=o>=</span><span class=nv>$JAVA_OPTS</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=o>[</span>...<span class=o>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;sh&#34;</span><span class=p>,</span> <span class=s2>&#34;-c&#34;</span><span class=p>,</span> <span class=s2>&#34;java ${JAVA_OPTS} org.springframework.boot.loader.JarLauncher&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>Il will be used during the deployment to set up our <em>Wonderful Java Application</em>.</p><p>Now, let&rsquo;s build our initContainer&rsquo;s Docker image.</p><h3 id=initcontainer-docker-image-creation class=headerLink><a href=#initcontainer-docker-image-creation class=header-mark></a>2.2 InitContainer Docker Image creation</h3><p>It is really straightforward.
We can use for example, the following configuration:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> alpine:latest</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> mkdir -p /opt/agent_setup<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> mkdir /opt/agent<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> ./javaagent.jar /opt/agent_setup/javaagent.jar<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>VOLUME</span><span class=s> /opt/agent</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=kubernetes-configuration class=headerLink><a href=#kubernetes-configuration class=header-mark></a>2.3 Kubernetes configuration</h3><p>We can now set up our Kubernetes Deployment to start the corresponding container and copy the Java agent.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>java-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>repo/my-wonderful-java-app:v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/opt/agent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>apm-agent-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initContainers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>cp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>/opt/agent_setup/javaagent.jar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>/opt/agent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>apm-agent-init</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>repo/apm-agent:v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/opt/agent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>appd-agent-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>appd-agent-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw"></i>Why not just copying the Java agent directly in the initContainer Docker image execution?<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>The copy must be run with a command specified in the initContainer declaration and cannot be done during the initContainer execution (i.e., specified in its Dockerfile).
Why?
The volume is mounted just after the initContainer execution and drops the JAR file copied earlier.</div></div></div><h2 id=start-the-java-application-with-the-agent class=headerLink><a href=#start-the-java-application-with-the-agent class=header-mark></a>3 Start the Java Application with the agent</h2><p>Last but not least, we can now configure the <a href=https://kubernetes.io/docs/concepts/workloads/pods/ target=_blank rel="noopener noreferrer">pods</a> where we run our Java applications.</p><p>We will use the <code>JAVA_OPTS</code> environment variable to configure the location of the Java agent, and <a href=https://www.elastic.co/guide/en/apm/agent/java/current/configuration.html target=_blank rel="noopener noreferrer">the Elastic APM Java system properties</a>.</p><p>For instance:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>JAVA_OPTS=-javaagent:/opt/agent/javaagent.jar -Delastic.apm.service_name=my-wonderful-application -Delastic.apm.application_packages=org.mywonderfulapp -Delastic.apm.server_url=http://apm:8200
</span></span></code></pre></td></tr></table></div></div><p>You can then configure your Kubernetes deployment as:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>java-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>JAVA_OPTS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span>-<span class=l>javaagent:/opt/agent/javaagent.jar -Delastic.apm.service_name=my-wonderful-application -Delastic.apm.application_packages=org.mywonderfulapp -Delastic.apm.server_url=http://apm:8200</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><em>Et voila!</em></p><h2 id=conclusion class=headerLink><a href=#conclusion class=header-mark></a>4 Conclusion</h2><p>We have seen how to pack and deploy Distributed Tracing java agents and Java Applications built on top of Docker images.
Obviously, my technical choice of using an InitContainer can be challenged regarding your technical context and how you are confortable with your delivery practices.
You probably noticed I use an emptyDir to deploy the Java agent.
<em>Normally</em> it will not be a big deal, but I advise you to check this usage with your Kubernetes SRE/Ops/Administrator first.</p><p>Anyway, I think it is worth it and the tradeoffs are more than acceptable because this approach are, in my opinion, more flexible than the first one.</p><p>Hope this helps!</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-11-01&nbsp;<a class=git-hash href=https://github.com/alexandre-touret/alexandre-touret.github.io/commit/2f128b581b2ca6cb906883f7f24e3b52ec9ac1b3 target=_blank title="commit by Alexandre Touret(alexandre-touret@users.noreply.github.com) 2f128b581b2ca6cb906883f7f24e3b52ec9ac1b3: chore: Change release date" rel="noopener noreferrer">
<i class="fas fa-hashtag fa-fw"></i>2f128b58</a></span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-mardown href=/2023/11/01/pack-ship-java-deployment-distributed-tracing-elasticapm/index.md target=_blank rel="noopener noreferrer">Read markdown</a>
</span><span>|&nbsp;<a class=link-to-source href=https://github.com/alexandre-touret/alexandre-touret.github.io/blob/main/exampleSite/content/posts/pack-ship-java-deployment-distributed-tracing-elasticapm.en.md target=_blank rel="noopener noreferrer">View source</a>
</span><span>|&nbsp;<a class=link-to-report href="https://github.com/alexandre-touret/alexandre-touret.github.io/issues/new?title=[bug]%20Streamline+Java+Application+Deployment%3A+Pack%2C+Ship%2C+and+Unlock+Distributed+Tracing+with+Elastic+APM+on+Kubernetes&body=|Field|Value|%0A|-|-|%0A|Title|Streamline+Java+Application+Deployment%3A+Pack%2C+Ship%2C+and+Unlock+Distributed+Tracing+with+Elastic+APM+on+Kubernetes|%0A|Url|https://blog.touret.info/2023/11/01/pack-ship-java-deployment-distributed-tracing-elasticapm/|%0A|Filename|https://github.com/HEIGE-PCloud/DoIt/blob/main/exampleSite/content/posts/pack-ship-java-deployment-distributed-tracing-elasticapm.en.md|" target=_blank rel="noopener noreferrer">Report issue</a></span></div><div class=post-info-share></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/distributed_tracing/>Distributed_Tracing</a>,&nbsp;<a href=/tags/java/>Java</a>,&nbsp;<a href=/tags/apm/>APM</a>,&nbsp;<a href=/tags/docker/>Docker</a>,&nbsp;<a href=/tags/elastic/>Elastic</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/2023/09/05/distributed-tracing-opentelemetry-camel-artemis/ class=prev rel=prev title="Enhancing Asynchronous Transaction Monitoring: Implementing Distributed Tracing in Apache Camel Applications with OpenTelemetry"><i class="fas fa-angle-left fa-fw"></i>Enhancing Asynchronous Transaction Monitoring: Implementing Distributed Tracing in Apache Camel Applications with OpenTelemetry</a>
<a href=/2023/11/09/rancher_desktop_wsl2/ class=next rel=next title="Configuring WSL2 for Seamless Compatibility with Rancher Desktop">Configuring WSL2 for Seamless Compatibility with Rancher Desktop<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.134.1">Hugo</a>&nbsp;|&nbsp;Theme - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.4.0"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://blog.touret.info target=_blank rel="noopener noreferrer">Alexandre Touret</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by/4.0/ target=_blank>CC BY 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"alexandre-touret/alexandre-touret.github.io"}},data:{"desktop-header-typeit":"blog.touret.info","mobile-header-typeit":"blog.touret.info"},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!0,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"No results found",snippetLength:300,threshold:.1,type:"fuse",useExtendedSearch:!1},table:{sort:!0},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},duration:-1,speed:100}}</script><script type=text/javascript src=/lib/tablesort/tablesort.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/typeit/typeit.min.js></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=/js/utterances.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F1EK89MHJD",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-F1EK89MHJD" async></script></div></body></html>