<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Mastering Observability: Empowering Developers from Zero to Hero with Spring & the Grafana stack - Alexandre Touret's Blog</title><meta name=Description content="Alexandre Touret's Blog"><meta property="og:title" content="Mastering Observability: Empowering Developers from Zero to Hero with Spring & the Grafana stack">
<meta property="og:description" content="1 The sad realityPicture this: it&rsquo;s Friday afternoon, and you&rsquo;re eagerly looking forward to unwinding for the weekend. Suddenly, an Ops engineer alerts you about a critical issue—a stubborn HTTP 500 error that&rsquo;s causing a major roadblock.
Despite the dedicated efforts of the Ops engineers, the root cause remains elusive due to a lack of contextual information.
Hours pass by, but you take it upon yourself to delve into the problem."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.touret.info/2024/01/16/observability-from-zero-to-hero/"><meta property="og:image" content="https://blog.touret.info/assets/images/2024/01/felipe-correia-ScQngs6oO1E-unsplash.webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-16T19:00:43+01:00"><meta property="article:modified_time" content="2024-01-17T09:18:18+01:00"><meta property="og:site_name" content="Alexandre Touret's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.touret.info/assets/images/2024/01/felipe-correia-ScQngs6oO1E-unsplash.webp"><meta name=twitter:title content="Mastering Observability: Empowering Developers from Zero to Hero with Spring & the Grafana stack"><meta name=twitter:description content="1 The sad realityPicture this: it&rsquo;s Friday afternoon, and you&rsquo;re eagerly looking forward to unwinding for the weekend. Suddenly, an Ops engineer alerts you about a critical issue—a stubborn HTTP 500 error that&rsquo;s causing a major roadblock.
Despite the dedicated efforts of the Ops engineers, the root cause remains elusive due to a lack of contextual information.
Hours pass by, but you take it upon yourself to delve into the problem."><meta name=twitter:site content="@touret_alex"><meta name=application-name content="Alexandre Touret's Blog"><meta name=apple-mobile-web-app-title content="Alexandre Touret's Blog"><meta name=theme-color content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><meta name=twitter:creator content="@touret_alex"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://blog.touret.info/2024/01/16/observability-from-zero-to-hero/><link rel=prev href=https://blog.touret.info/2023/12/20/2023-wrap-up/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><meta name=google-site-verification content="7UnqNmvO-mjfMkRqKaaWRPTBxSylEVJXvAn8iTfc7SI"><meta name=msvalidate.01 content="F9655A4C8648E42154ECB4B4D6CF60A2"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Mastering Observability: Empowering Developers from Zero to Hero with Spring \u0026 the Grafana stack","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.touret.info/2024/01/16/observability-from-zero-to-hero/"},"image":["https://blog.touret.info/images/alexandre.touret.webp"],"genre":"posts","keywords":"Observability, Spring, Java, Grafana","wordcount":2363,"url":"https://blog.touret.info/2024/01/16/observability-from-zero-to-hero/","datePublished":"2024-01-16T19:00:43+01:00","dateModified":"2024-01-17T09:18:18+01:00","license":"This work is licensed under a Creative Commons Attribution 4.0 International License.","publisher":{"@type":"Organization","name":"Alexandre Touret","logo":"https://blog.touret.info/images/alexandre.touret.webp"},"author":{"@type":"Person","name":"Alexandre Touret"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"||"auto"==="black"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Alexandre Touret's Blog"><span id=desktop-header-typeit class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/contact/>Contact </a><a class=menu-item href=/talks/>Talks </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i>
</span></span><a href=javascript:void(0); class="menu-item theme-select" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-desktop title="Switch Theme"><option value=light>Light</option><option value=dark>Dark</option><option value=black>Black</option><option value=auto>Auto</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Alexandre Touret's Blog"><span id=mobile-header-typeit class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/contact/ title>Contact</a><a class=menu-item href=/talks/ title>Talks</a><a class=menu-item href=/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-select" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-mobile title="Switch Theme"><option value=light>Light</option><option value=dark>Dark</option><option value=black>Black</option><option value=auto>Auto</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#the-sad-reality>The sad reality</a></li><li><a href=#a-definition-of-observability>A definition of Observability</a></li><li><a href=#a-short-presentation-of-the-grafana-stack>A short presentation of the Grafana stack</a></li><li><a href=#logs-traces--monitoring>Logs, Traces & Monitoring</a></li><li><a href=#logs>Logs</a><ul><li><a href=#key-principles>Key principles</a></li></ul></li><li><a href=#what-about-grafana-loki>What about Grafana Loki</a></li><li><a href=#traces>Traces</a><ul><li><a href=#the-setup>The setup</a></li><li><a href=#head-or-tail-sampling>Head or Tail sampling?</a></li></ul></li><li><a href=#correlating-logs--traces>Correlating Logs & Traces</a></li><li><a href=#metrics>Metrics</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Mastering Observability: Empowering Developers from Zero to Hero with Spring & the Grafana stack</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class="author fas fa-user-circle fa-fw"></span><a href=https://blog.touret.info title=Author target=_blank rel="noopener noreferrer author" class=author>Alexandre Touret</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2024-01-16>2024-01-16</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2024-01-17>2024-01-17</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;2363 words&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;12 minutes&nbsp;</div></div><div class=featured-image><img loading=eager src=/assets/images/2024/01/felipe-correia-ScQngs6oO1E-unsplash.webp srcset="/assets/images/2024/01/felipe-correia-ScQngs6oO1E-unsplash.webp, /assets/images/2024/01/felipe-correia-ScQngs6oO1E-unsplash.webp 1.5x, /assets/images/2024/01/felipe-correia-ScQngs6oO1E-unsplash.webp 2x" sizes=auto alt=/assets/images/2024/01/felipe-correia-ScQngs6oO1E-unsplash.webp title=/assets/images/2024/01/felipe-correia-ScQngs6oO1E-unsplash.webp height=auto width=auto></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#the-sad-reality>The sad reality</a></li><li><a href=#a-definition-of-observability>A definition of Observability</a></li><li><a href=#a-short-presentation-of-the-grafana-stack>A short presentation of the Grafana stack</a></li><li><a href=#logs-traces--monitoring>Logs, Traces & Monitoring</a></li><li><a href=#logs>Logs</a><ul><li><a href=#key-principles>Key principles</a></li></ul></li><li><a href=#what-about-grafana-loki>What about Grafana Loki</a></li><li><a href=#traces>Traces</a><ul><li><a href=#the-setup>The setup</a></li><li><a href=#head-or-tail-sampling>Head or Tail sampling?</a></li></ul></li><li><a href=#correlating-logs--traces>Correlating Logs & Traces</a></li><li><a href=#metrics>Metrics</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div><div class=content id=content><h2 id=the-sad-reality class=headerLink><a href=#the-sad-reality class=header-mark></a>1 The sad reality</h2><p>Picture this: it&rsquo;s Friday afternoon, and you&rsquo;re eagerly looking forward to unwinding for the weekend.
Suddenly, an Ops engineer alerts you about a critical issue—a stubborn HTTP 500 error that&rsquo;s causing a major roadblock.</p><p>Despite the dedicated efforts of the Ops engineers, the root cause remains elusive due to a lack of contextual information.</p><p>Hours pass by, but you take it upon yourself to delve into the problem.
Eventually, after reproducing and debugging the issue on your computer, you uncover the issue.</p><p>Does this sound like science fiction? If you&rsquo;ve experienced a similar scenario, you&rsquo;re likely familiar with the challenges posed by unidentified end users and their unique usage patterns—enter Ops and observability!</p><p>I&rsquo;ve previously delved into the topic of observability.
Here are a bunch of articles I wrote on this blog or on the <a href=https://blog.worldline.tech target=_blank rel="noopener noreferrer">Worldline Tech Blog</a>:</p><ul><li><a href=https://blog.touret.info/2023/09/05/distributed-tracing-opentelemetry-camel-artemis/ target=_blank rel="noopener noreferrer">Enhancing Asynchronous Transaction Monitoring: Implementing Distributed Tracing in Apache Camel Applications with OpenTelemetry</a></li><li><a href=https://blog.touret.info/2021/07/26/observabilite-et-circuit-breaker-avec-spring/ target=_blank rel="noopener noreferrer">Observabilité et Circuit Breaker avec Spring</a></li><li><a href=https://blog.worldline.tech/2021/09/22/enabling_distributed_tracing_in_spring_apps.html target=_blank rel="noopener noreferrer">Enabling distributed tracing on your microservices Spring app using Jaeger and OpenTracing</a></li></ul><p>In this article, I aim to highlight the importance of putting in place observability during the earliest stages of a project.
I will then outline how to merge logs and traces from a good old <a href=https://spring.io/projects/spring-boot/ target=_blank rel="noopener noreferrer">Spring Boot application</a> on the <a href=https://grafana.com/ target=_blank rel="noopener noreferrer">Grafana Stack</a> to gain clearer insights into your platform&rsquo;s workings.
By doing so, you can transform your relationship with Ops teams, making them your best friends.</p><div class="details admonition question open"><div class="details-summary admonition-title"><i class="icon fas fa-question-circle fa-fw"></i>What about the code?<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>The examples provided in this article come from <a href=https://github.com/alexandre-touret/observability-from-zero-to-hero target=_blank rel="noopener noreferrer">this project hosted on Github</a>.</div></div></div><h2 id=a-definition-of-observability class=headerLink><a href=#a-definition-of-observability class=header-mark></a>2 A definition of Observability</h2><p>We can shortly define it as this:</p><blockquote><p>Observability is the ability <strong>to understand the internal state of a complex system</strong>.
When a system is observable, a user can <strong>identify the root cause</strong> of a performance problem by examining the data it produces, without additional testing or coding.</p><p>This is one of the ways in which <strong>quality of service</strong> issues can be addressed.</p></blockquote><h2 id=a-short-presentation-of-the-grafana-stack class=headerLink><a href=#a-short-presentation-of-the-grafana-stack class=header-mark></a>3 A short presentation of the Grafana stack</h2><p><a href=https://grafana.com/oss/ target=_blank rel="noopener noreferrer">The Grafana stack</a> aims at a tool which allows you to query, visualise, alert and explore all of your metrics.
You can aggregate them through a <a href=https://grafana.com/docs/grafana/latest/datasources/ target=_blank rel="noopener noreferrer">wide range of data sources</a>.
With regard to the topic of this article,it will provide us all you need to collect logs, metrics and traces (and beyond) to monitor and understand the behaviour of your platforms.</p><p>I will therefore particularly focus on:</p><ul><li><a href=https://grafana.com/oss/grafana/ target=_blank rel="noopener noreferrer">Grafana</a>: The dashboard engine</li><li><a href=https://grafana.com/oss/loki/ target=_blank rel="noopener noreferrer">Loki</a>: The log storage engine</li><li><a href=https://grafana.com/oss/tempo/ target=_blank rel="noopener noreferrer">Tempo</a>: The trace storage engine</li></ul><p>By the way, I also configured in this project a <a href=https://prometheus.io/docs/introduction/overview/ target=_blank rel="noopener noreferrer">Prometheus TSDB to store metrics</a>.</p><p>To get it started easily, I just created a <a href=https://github.com/alexandre-touret/observability-from-zero-to-hero/tree/main/docker target=_blank rel="noopener noreferrer">Docker Compose stack to run it on your desktop</a>.</p><p>You can run it with these commands:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> docker
</span></span><span class=line><span class=cl>docker compose up
</span></span></code></pre></td></tr></table></div></div><h2 id=logs-traces--monitoring class=headerLink><a href=#logs-traces--monitoring class=header-mark></a>4 Logs, Traces & Monitoring</h2><p>Let&rsquo;s go back to the basics: To make a system fully observable, the following abilities must be implemented:</p><ul><li>Logs</li><li>Traces</li><li>Metrics</li></ul><p>They can be defined as follows:</p><p><figure><img loading=lazy src=/assets/images/2024/01/image-2023-8-1_9-44-11.webp srcset="/assets/images/2024/01/image-2023-8-1_9-44-11.webp, /assets/images/2024/01/image-2023-8-1_9-44-11.webp 1.5x, /assets/images/2024/01/image-2023-8-1_9-44-11.webp 2x" sizes=auto alt=monitoring title=monitoring></figure></p><h2 id=logs class=headerLink><a href=#logs class=header-mark></a>5 Logs</h2><p>When a program fails, OPS usually tries to identify the underlying error analyzing log files.
It could be either reading the application log files or using a log aggregator such as Elastic Kibana or Splunk.</p><p>In my opinion, most of the time developers don&rsquo;t really care about this matter.
It is mainly due to they did not experience such a trouble.</p><p>For two years, I had to administrate a proprietary customer relationship management solution.
The only way to analyse errors was navigating through the logs, using the most appropriate error levels to get the root cause.
We didn&rsquo;t have access to the source code (Long live to open source programs).
Hopefully the log management system was really efficient.
It helped us get into this product and administrate it efficiently.</p><p>Furthermore, I strongly think we should systematise such experiences for developers.
It could help them (us) know what is behind the curtain and make more observable and better programs.</p><h3 id=key-principles class=headerLink><a href=#key-principles class=header-mark></a>5.1 Key principles</h3><p>You must first dissociate the logs you make while you code (e.g., for debugging) from the production logs.
The first should normally remove the first.
For the latter, you should apply some of these principles:</p><ul><li>Identify and use the most appropriate level (<code>DEBUG</code>, <code>INFO</code>, <code>WARN</code>, <code>ERROR</code>,&mldr;)</li><li>Provide a clear and useful message for OPS (yes you make this log for him/her)</li><li>Provide business context (e.g., the creation of the contract <code>123456</code> failed)</li><li>Logs must be read by an external tool (e.g., using a log aggregator)</li><li>Logs must not expose sensitive data: You must think about GDPR, PCI DSS standards</li></ul><p>If you want to dig into log levels and the importance to indicate contextual information into your logs, I suggest you reading <a href=https://blog.worldline.tech/2020/01/22/back-to-basics-logging.html target=_blank rel="noopener noreferrer">this article from my colleague Nicolas Carlier</a>.</p><h2 id=what-about-grafana-loki class=headerLink><a href=#what-about-grafana-loki class=header-mark></a>6 What about Grafana Loki</h2><p>For this test, I chose to use <a href=https://github.com/loki4j/loki-logback-appender target=_blank rel="noopener noreferrer">loki-logback-appender</a> to send the logs to Loki.</p><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw"></i>About this appender<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>I chose to use this appender for testing purpose.
If you deploy your application on top of Kubernetes, you would probably opt for a more suitable solution such as <a href=https://www.fluentd.org/ target=_blank rel="noopener noreferrer">FluentD</a>.</div></div></div><p>The configuration for a Spring Boot application is pretty straightforward:</p><p>You must add first the appender to your classpath:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>implementation</span> <span class=s1>&#39;com.github.loki4j:loki-logback-appender:1.4.2&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>and create a <a href=https://github.com/alexandre-touret/observability-from-zero-to-hero-/blob/main/src/main/resources/logback-spring.xml target=_blank rel="noopener noreferrer"><code>logback-spring.xml</code></a> to configure it:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl> <span class=nt>&lt;appender</span> <span class=na>name=</span><span class=s>&#34;LOKI&#34;</span> <span class=na>class=</span><span class=s>&#34;com.github.loki4j.logback.Loki4jAppender&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;http&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;url&gt;</span>http://localhost:3100/loki/api/v1/push<span class=nt>&lt;/url&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/http&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;format&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;label&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;pattern&gt;</span>app=${name},host=${HOSTNAME},level=%level<span class=nt>&lt;/pattern&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;readMarkers&gt;</span>true<span class=nt>&lt;/readMarkers&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/label&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;message&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;pattern&gt;</span>
</span></span><span class=line><span class=cl>                    {&#34;level&#34;:&#34;%level&#34;,&#34;class&#34;:&#34;%logger{36}&#34;,&#34;thread&#34;:&#34;%thread&#34;,&#34;message&#34;: &#34;%message&#34;,&#34;requestId&#34;: &#34;%X{X-Request-ID}&#34;}
</span></span><span class=line><span class=cl>                <span class=nt>&lt;/pattern&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/message&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/format&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/appender&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p><em>Et voilà!</em></p><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw"></i>About the format<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>It is just my 2 cents: more and more I tend to produce structured logs using JSON for instance.
It is usually easier to manipulate them all along the log ingestion tools chain (e.g, with <a href=https://www.elastic.co/fr/logstash/ target=_blank rel="noopener noreferrer">LogStash</a>.</div></div></div><p>After restarting your application:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gradle bootRun
</span></span></code></pre></td></tr></table></div></div><p>After running some API calls with the following command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>http :8080/api/events
</span></span></code></pre></td></tr></table></div></div><p>You can now get logs browsing Grafana</p><p><figure><img loading=lazy src=/assets/images/2024/01/Loki-Grafana.webp srcset="/assets/images/2024/01/Loki-Grafana.webp, /assets/images/2024/01/Loki-Grafana.webp 1.5x, /assets/images/2024/01/Loki-Grafana.webp 2x" sizes=auto alt=Loki title=Loki></figure></p><h2 id=traces class=headerLink><a href=#traces class=header-mark></a>7 Traces</h2><p>Upon initial inspection, one might consider the existing setup sufficient. However, I highly recommend delving into the realm of <a href=https://research.google/pubs/pub36356/ target=_blank rel="noopener noreferrer">Distributed Tracing</a>, a technology I have previously introduced (refer to the aforementioned discussion).
Not only it will be first really useful when you deploy distributed architectures but also for the other kind of platforms.</p><p>The true value of distributed tracing becomes evident not only in the deployment of distributed architectures but across various platforms. In the complex landscape of production issues, identifying the root cause or understanding why a specific SQL query failed or took an extended duration can be challenging. Traditionally, attempts to replicate such issues in alternative environments often fall short due to the inherent complexities of data, server configurations, and benchmarking.</p><p>This technology empowers you to gain valuable insights that were previously elusive. When grappling with production issues, you no longer need to rely solely on replication efforts; distributed tracing provides a clear and comprehensive perspective on what might be amiss.</p><p>To sum up: <em>Try it, you&rsquo;ll like it!</em></p><h3 id=the-setup class=headerLink><a href=#the-setup class=header-mark></a>7.1 The setup</h3><p>There is several ways to set it up.
Nowadays, OpenTelemetry is the <em>de facto</em> standard.
Most of the solutions are compatible with it.</p><p>Nevertheless, after challenging some APMs, I found some missing features which are really useful in real life projects.
For instance, you can not easily ignore URLs, for instance the actuator endpoints, from the traces you will manage.
You can do that in just <a href=https://www.elastic.co/guide/en/apm/agent/java/1.x/config-http.html#config-transaction-ignore-urls target=_blank rel="noopener noreferrer">one property with the Elastic APM agent</a>.
There is <a href=https://github.com/open-telemetry/opentelemetry-java-instrumentation/issues/1060#issuecomment-1816716602 target=_blank rel="noopener noreferrer">an issue about this feature</a>.</p><p>I suggest using the agents.
It is less intrusive than other solutions.</p><p>For instance if you use the spring boot gradle plugin you can configure it as following:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>plugins</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>id</span> <span class=s1>&#39;java&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>id</span> <span class=s1>&#39;org.springframework.boot&#39;</span> <span class=n>version</span> <span class=s1>&#39;3.2.1&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>id</span> <span class=s1>&#39;io.spring.dependency-management&#39;</span> <span class=n>version</span> <span class=s1>&#39;1.1.4&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ext</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>opentelemetryAgentVersion</span> <span class=o>=</span> <span class=s1>&#39;1.32.0&#39;</span> <span class=c1>// Mettez la version appropriée
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>group</span> <span class=o>=</span> <span class=s1>&#39;info.touret.observability&#39;</span>
</span></span><span class=line><span class=cl><span class=n>version</span> <span class=o>=</span> <span class=s1>&#39;0.0.1-SNAPSHOT&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>java</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>sourceCompatibility</span> <span class=o>=</span> <span class=s1>&#39;21&#39;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>repositories</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>mavenCentral</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dependencies</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>implementation</span> <span class=s1>&#39;org.springframework.boot:spring-boot-starter-actuator&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>implementation</span> <span class=s1>&#39;org.springframework.boot:spring-boot-starter-web&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>implementation</span> <span class=s1>&#39;io.micrometer:micrometer-registry-prometheus&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>testImplementation</span> <span class=s1>&#39;org.springframework.boot:spring-boot-starter-test&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>implementation</span> <span class=s1>&#39;com.github.loki4j:loki-logback-appender:1.4.2&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>implementation</span> <span class=s2>&#34;io.opentelemetry.javaagent:opentelemetry-javaagent:${opentelemetryAgentVersion}&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>task</span> <span class=nf>copyJavaAgent</span><span class=o>(</span><span class=nl>type:</span> <span class=n>Copy</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>from</span> <span class=n>configurations</span><span class=o>.</span><span class=na>detachedConfiguration</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>dependencies</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=s2>&#34;io.opentelemetry.javaagent:opentelemetry-javaagent:${opentelemetryAgentVersion}&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>into</span> <span class=s2>&#34;${project.getLayout().getBuildDirectory()}/javaagents&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>rename</span> <span class=o>{</span> <span class=s1>&#39;javaagent.jar&#39;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>processResources</span><span class=o>.</span><span class=na>dependsOn</span> <span class=n>copyJavaAgent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>bootRun</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>doFirst</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>jvmArgs</span> <span class=o>=</span> <span class=o>[</span><span class=s2>&#34;-javaagent:${project.getLayout().getBuildDirectory()}/javaagents/javaagent.jar&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// systemProperties = [
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//     &#39;otel.traces.sampler&#39;: &#39;parentbased_traceidratio&#39;,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//     &#39;otel.traces.sampler.arg&#39;: &#39;0.2&#39;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// ]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=n>tasks</span><span class=o>.</span><span class=na>named</span><span class=o>(</span><span class=s1>&#39;test&#39;</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>useJUnitPlatform</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>After restarting your application, you can reach the API with this command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>http :8080/api/events
</span></span></code></pre></td></tr></table></div></div><p>This API is really simple.
To illustrate how to handle errors using both the Spring stack and the Grafana stack, an error is always thrown using <a href=https://docs.spring.io/spring-framework/reference/web/webmvc/mvc-ann-rest-exceptions.html target=_blank rel="noopener noreferrer">the Problem Detail RFC 7807</a> while reaching it.</p><p>Here the <a href=https://github.com/alexandre-touret/observability-from-zero-to-hero/blob/main/src/main/java/info/touret/observability/observabilityfromzerotohero/ObservabilityService.java target=_blank rel="noopener noreferrer">service</a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ObservabilityService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>breakMethod</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&#34;Breaking method issue&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>And the <a href=https://github.com/alexandre-touret/observability-from-zero-to-hero/blob/main/src/main/java/info/touret/observability/observabilityfromzerotohero/ObservabilityAPIController.java target=_blank rel="noopener noreferrer">controller</a> which returns the error:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/api/event&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>ResponseEntity</span><span class=o>&lt;</span><span class=n>ObservabilityEventDto</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getEvent</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ErrorResponseException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>observabilityService</span><span class=p>.</span><span class=na>breakMethod</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>var</span><span class=w> </span><span class=n>observabilityEventDto</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObservabilityEventDto</span><span class=p>(</span><span class=n>UUID</span><span class=p>.</span><span class=na>randomUUID</span><span class=p>().</span><span class=na>toString</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;OK&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>ResponseEntity</span><span class=p>.</span><span class=na>ok</span><span class=p>(</span><span class=n>observabilityEventDto</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>var</span><span class=w> </span><span class=n>observabilityEventDto</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObservabilityEventDto</span><span class=p>(</span><span class=n>UUID</span><span class=p>.</span><span class=na>randomUUID</span><span class=p>().</span><span class=na>toString</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;Error&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ErrorResponseException</span><span class=p>(</span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>INTERNAL_SERVER_ERROR</span><span class=p>,</span><span class=w> </span><span class=n>ProblemDetail</span><span class=p>.</span><span class=na>forStatus</span><span class=p>(</span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>INTERNAL_SERVER_ERROR</span><span class=p>),</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Using Problem Detail responses, you will get such a response when an error occurs:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl> http :8080/api/events
</span></span><span class=line><span class=cl>HTTP/1.1 <span class=m>500</span>
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Content-Type: application/problem+json
</span></span><span class=line><span class=cl>Date: Wed, <span class=m>17</span> Jan <span class=m>2024</span> 08:09:20 GMT
</span></span><span class=line><span class=cl>Transfer-Encoding: chunked
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;instance&#34;</span>: <span class=s2>&#34;/api/events&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;status&#34;</span>: 500,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;title&#34;</span>: <span class=s2>&#34;Internal Server Error&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;about:blank&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>After testing this service a few times, you can now see the traces on your Grafana dashboard.</p><p><figure><img loading=lazy src=/assets/images/2024/01/Tempo-Grafana.webp srcset="/assets/images/2024/01/Tempo-Grafana.webp, /assets/images/2024/01/Tempo-Grafana.webp 1.5x, /assets/images/2024/01/Tempo-Grafana.webp 2x" sizes=auto alt=Tempo title=Tempo></figure></p><h3 id=head-or-tail-sampling class=headerLink><a href=#head-or-tail-sampling class=header-mark></a>7.2 Head or Tail sampling?</h3><p>One significant drawback of implementing this technology lies in the potential performance overhead it introduces to the instrumented application. In cases where high-pressure APIs generate or broadcast SPANs for every transaction, there&rsquo;s a substantial risk of significantly impacting the <a href=https://sre.google/sre-book/service-level-objectives/ target=_blank rel="noopener noreferrer">Service Level Objectives (SLOs)</a> of your platform.</p><p>A viable solution to mitigate this challenge involves sampling the traces, such as retaining only 20% of the transactions. There are two primary approaches:</p><ol><li><p><strong>Head Sampling</strong>: In this method, SPANs are sampled and filtered directly from the producer (e.g., a backend). This is essential for heavily utilized platforms and proves to be the most efficient, as it produces only the necessary spans, thereby avoiding the dissemination of unnecessary SPANs. However, it comes with the trade-off of potentially losing critical traces involving failures. The sampling rate is purely statistical (e.g., 10 or 20% of SPANs sampled and broadcast).</p></li><li><p><strong>Tail Sampling</strong>: Alternatively, SPANs are sampled retrospectively, often through tools like the <a href=https://opentelemetry.io/docs/collector/ target=_blank rel="noopener noreferrer">Open Telemetry Collector</a>. While this method allows for filtering SPANs based on various criteria, such as the transaction status, it does not address the overhead issue. All SPANs are initially broadcast and then filtered, making it less suitable for heavily used scenarios.</p></li></ol><p>Both approaches have their pros and cons, and the choice depends on the specific requirements of the platform. For an in-depth exploration of this issue, you can refer to <a href=https://uptrace.dev/opentelemetry/sampling.html#what-is-sampling target=_blank rel="noopener noreferrer">this article</a>.</p><h2 id=correlating-logs--traces class=headerLink><a href=#correlating-logs--traces class=header-mark></a>8 Correlating Logs & Traces</h2><p>Now, you have on one side the logs of your applications, and on the other the traces.
To dig into errors and see what is behind the curtain of any error logged, it is really import to correlate both.</p><p>For that, you must specify in your logs the traceID and spanID of the corresponding trace.
Hopefully, logback and the Loki appender can help you on this!
We therefore will modify the pattern of the logs in the <a href=https://github.com/alexandre-touret/observability-from-zero-to-hero-/blob/main/src/main/resources/logback-spring.xml target=_blank rel="noopener noreferrer"><code>logback-spring.xml</code></a> file:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;pattern&gt;</span>
</span></span><span class=line><span class=cl>    {&#34;level&#34;:&#34;%level&#34;,&#34;TraceID&#34;:&#34;%mdc{trace_id:-none}&#34;,&#34;spanId&#34;:&#34;%mdc{span_id:-none}&#34;,&#34;class&#34;:&#34;%logger{36}&#34;,&#34;thread&#34;:&#34;%thread&#34;,&#34;message&#34;: &#34;%message&#34;,&#34;requestId&#34;: &#34;%X{X-Request-ID}&#34;}
</span></span><span class=line><span class=cl><span class=nt>&lt;/pattern&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>As a developer point of view, the job is done :)
Now, it is time for the OPS/SRE to configure Grafana to link Loki and Tempo through the TraceID field.</p><p>For that, you can create a derived field directly in the datasource configuration:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>datasources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Loki</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>loki</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>access</span><span class=p>:</span><span class=w> </span><span class=l>proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>loki</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>http://loki:3100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>jsonData</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>maxLines</span><span class=p>:</span><span class=w> </span><span class=m>1000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>derivedFields</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>datasourceUid</span><span class=p>:</span><span class=w> </span><span class=l>tempo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>matcherRegex</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;\&#34;TraceID\&#34;: \&#34;(\w+).*\&#34;&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>TraceID</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c># url will be interpreted as query for the datasource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;$${__value.raw}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c># optional for URL Label to set a custom display label for the link.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>urlDisplayLabel</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;View Trace&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Tempo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>tempo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>access</span><span class=p>:</span><span class=w> </span><span class=l>proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>tempo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>http://tempo:3200</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>jsonData</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodeGraph</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>serviceMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>datasourceUid</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;mimir&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tracesToLogs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>datasourceUid</span><span class=p>:</span><span class=w> </span><span class=l>loki</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>filterByTraceID</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>filterBySpanID</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>mapTagNamesEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Now you will be able to browse directly to the corresponding trace from your log event and the other way around.</p><h2 id=metrics class=headerLink><a href=#metrics class=header-mark></a>9 Metrics</h2><p>Now, let us deep dive into the metrics of our application!
We can do that through <a href=https://prometheus.io/ target=_blank rel="noopener noreferrer">Prometheus</a>.</p><p>We can configure now Prometheus to grab the metrics exposed by our application.</p><p>To do that, we need first to activate the Prometheus endpoint:</p><p>We need to add this dependency first:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>implementation</span> <span class=s1>&#39;io.micrometer:micrometer-registry-prometheus&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>And enable the corresponding endpoint:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>management.endpoints.web.exposure.include</span><span class=o>=</span><span class=s>health,info,prometheus</span>
</span></span></code></pre></td></tr></table></div></div><p>After enabling it, as a developer point of view, it is done :-)</p><p>The prometheus statistics can be scrapped by Prometheus itself using <a href=https://github.com/alexandre-touret/observability-from-zero-to-hero/blob/main/docker/prometheus/prometheus.yml target=_blank rel="noopener noreferrer">this configuration</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>scrape_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>honor_timestamps</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scrape_timeout</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metrics_path</span><span class=p>:</span><span class=w> </span><span class=l>/actuator/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>targets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>host.docker.internal:8080</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Finally, you can directly browse it through Grafana to integrate all of these metrics into your dashboards 🎉.</p><h2 id=conclusion class=headerLink><a href=#conclusion class=header-mark></a>10 Conclusion</h2><p>I endeavored to provide you with a comprehensive overview of what an OPS professional could anticipate while investigating an issue and the corresponding topics that require attention.
As you probably figured out, we only applied just a bunch of configuration sets.<br>One of the key merits of these tools lies in their non-intrusiveness within the code itself.
To cut long story short: it is not a big deal!</p><p>Integrating these configurations can be a significant stride forward, providing invaluable assistance to the entire IT team, from development to operations, as they navigate and troubleshoot issues—whether in production or elsewhere.</p><p>I will finish this article by my opinion on such topics: regardless of the targeted tools, this set of configuration <strong>must be considered as the first feature to implement for every cloud native application</strong>.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2024-01-17&nbsp;<a class=git-hash href=https://github.com/alexandre-touret/alexandre-touret.github.io/commit/19050cdadc48e016360e71ed575cd6d43e29fda6 target=_blank title="commit by Alexandre Touret(alexandre-touret@users.noreply.github.com) 19050cdadc48e016360e71ed575cd6d43e29fda6: fix: fix text" rel="noopener noreferrer">
<i class="fas fa-hashtag fa-fw"></i>19050cd</a></span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-mardown href=/2024/01/16/observability-from-zero-to-hero/index.md target=_blank rel="noopener noreferrer">Read markdown</a>
</span><span>|&nbsp;<a class=link-to-source href=https://github.com/alexandre-touret/alexandre-touret.github.io/blob/main/exampleSite/content/posts/observability-from-zero-to-hero.md target=_blank rel="noopener noreferrer">View source</a>
</span><span>|&nbsp;<a class=link-to-report href="https://github.com/alexandre-touret/alexandre-touret.github.io/issues/new?title=[bug]%20Mastering+Observability%3A+Empowering+Developers+from+Zero+to+Hero+with+Spring+%26+the+Grafana+stack&body=|Field|Value|%0A|-|-|%0A|Title|Mastering+Observability%3A+Empowering+Developers+from+Zero+to+Hero+with+Spring+%26+the+Grafana+stack|%0A|Url|https://blog.touret.info/2024/01/16/observability-from-zero-to-hero/|%0A|Filename|https://github.com/HEIGE-PCloud/DoIt/blob/main/exampleSite/content/posts/observability-from-zero-to-hero.md|" target=_blank rel="noopener noreferrer">Report issue</a></span></div><div class=post-info-share></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/observability/>observability</a>,&nbsp;<a href=/tags/spring/>spring</a>,&nbsp;<a href=/tags/java/>java</a>,&nbsp;<a href=/tags/grafana/>Grafana</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/2023/12/20/2023-wrap-up/ class=prev rel=prev title="Reflecting on 2023"><i class="fas fa-angle-left fa-fw"></i>Reflecting on 2023</a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.121.2">Hugo</a>&nbsp;|&nbsp;Theme - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.4.0"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://blog.touret.info target=_blank rel="noopener noreferrer">Alexandre Touret</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by/4.0/ target=_blank>CC BY 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"alexandre-touret/alexandre-touret.github.io"}},data:{"desktop-header-typeit":"blog.touret.info","mobile-header-typeit":"blog.touret.info"},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!0,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"No results found",snippetLength:300,threshold:.1,type:"fuse",useExtendedSearch:!1},table:{sort:!0},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},duration:-1,speed:100}}</script><script type=text/javascript src=/lib/tablesort/tablesort.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/typeit/typeit.min.js></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=/js/utterances.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F1EK89MHJD",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-F1EK89MHJD" async></script></div></body></html>