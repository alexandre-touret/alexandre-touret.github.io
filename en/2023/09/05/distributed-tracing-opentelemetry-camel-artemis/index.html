<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Enhancing Asynchronous Transaction Monitoring: Implementing Distributed Tracing in Apache Camel Applications with OpenTelemetry - Alexandre Touret's Blog</title><meta name=Description content="Architecte logiciel, développeur, bidouilleur (dans le désordre)"><meta property="og:title" content="Enhancing Asynchronous Transaction Monitoring: Implementing Distributed Tracing in Apache Camel Applications with OpenTelemetry"><meta property="og:description" content="Picture Credit: Nick FEWINGS IntroductionIn today&rsquo;s dynamic landscape, Distributed Tracing has emerged as an indispensable practice. It helps to understand what is under the hood of distributed transactions, providing answers to pivotal questions: What comprises these diverse requests? What contextual information accompanies them? How extensive is their duration?
Since the introduction of Google&rsquo;s Dapper, a plethora of tracing solutions has flooded the scene. Among them, OpenTelemetry has risen as the frontrunner."><meta property="og:type" content="article"><meta property="og:url" content="http://blog.touret.info/en/2023/09/05/distributed-tracing-opentelemetry-camel-artemis/"><meta property="og:image" content="http://blog.touret.info/assets/images/2023/09/nick-fewings-4dI5OP2Ee64-unsplash.webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-05T08:00:00+00:00"><meta property="article:modified_time" content="2023-09-05T15:02:56+02:00"><meta property="og:site_name" content="blog.touret.info"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://blog.touret.info/assets/images/2023/09/nick-fewings-4dI5OP2Ee64-unsplash.webp"><meta name=twitter:title content="Enhancing Asynchronous Transaction Monitoring: Implementing Distributed Tracing in Apache Camel Applications with OpenTelemetry"><meta name=twitter:description content="Picture Credit: Nick FEWINGS IntroductionIn today&rsquo;s dynamic landscape, Distributed Tracing has emerged as an indispensable practice. It helps to understand what is under the hood of distributed transactions, providing answers to pivotal questions: What comprises these diverse requests? What contextual information accompanies them? How extensive is their duration?
Since the introduction of Google&rsquo;s Dapper, a plethora of tracing solutions has flooded the scene. Among them, OpenTelemetry has risen as the frontrunner."><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><meta name=theme-color content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel=canonical href=http://blog.touret.info/en/2023/09/05/distributed-tracing-opentelemetry-camel-artemis/><link rel=prev href=http://blog.touret.info/en/2023/07/21/fish-shell/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><meta name=google-site-verification content="7UnqNmvO-mjfMkRqKaaWRPTBxSylEVJXvAn8iTfc7SI"><meta name=msvalidate.01 content="F9655A4C8648E42154ECB4B4D6CF60A2"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Enhancing Asynchronous Transaction Monitoring: Implementing Distributed Tracing in Apache Camel Applications with OpenTelemetry","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/blog.touret.info\/en\/2023\/09\/05\/distributed-tracing-opentelemetry-camel-artemis\/"},"image":["http:\/\/blog.touret.info\/images\/alexandre-touret.webp"],"genre":"posts","keywords":"OpenTelemetry, Java, Camel, Artemis, Grafana, Tempo","wordcount":1923,"url":"http:\/\/blog.touret.info\/en\/2023\/09\/05\/distributed-tracing-opentelemetry-camel-artemis\/","datePublished":"2023-09-05T08:00:00+00:00","dateModified":"2023-09-05T15:02:56+02:00","license":"This work is licensed under a Creative Commons Attribution 4.0 International License.","publisher":{"@type":"Organization","name":"Alexandre Touret","logo":"http:\/\/blog.touret.info\/images\/alexandre-touret.webp"},"author":{"@type":"Person","name":"Alexandre Touret"},"description":""}</script><script src=//instant.page/5.2.0 defer type=module integrity=sha384-jnZyxPjiipYXnSU0ygqeac2q7CVYMbh84q0uHVRRxEtvFPiQYbXWUorga2aqZJ0z></script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"||"auto"==="black"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/en/ title="Alexandre Touret's Blog">blog.touret.info</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/en/posts/>Posts </a><a class=menu-item href=/en/tags/>Tags </a><a class=menu-item href=/en/contact/>Contact </a><a class=menu-item href=/en/talks/>Talks </a><a class=menu-item href=/en/about/>About </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item language" title="Select Language">English<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select title="Select Language" id=language-select-desktop onchange="location=this.value"><option value=/en/2023/09/05/distributed-tracing-opentelemetry-camel-artemis/ selected>English</option></select>
</a><span class="menu-item search" id=search-desktop><input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/en/ title="Alexandre Touret's Blog">blog.touret.info</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/en/posts/ title>Posts</a><a class=menu-item href=/en/tags/ title>Tags</a><a class=menu-item href=/en/contact/ title>Contact</a><a class=menu-item href=/en/talks/ title>Talks</a><a class=menu-item href=/en/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i>
</a><a href=javascript:void(0); class=menu-item title="Select Language">English<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select title="Select Language" onchange="location=this.value"><option value=/en/2023/09/05/distributed-tracing-opentelemetry-camel-artemis/ selected>English</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#jaeger>Jaeger</a><ul><li><a href=#architecture>Architecture</a></li><li><a href=#opentelemetry-collector>OpenTelemetry Collector</a></li><li><a href=#what-about-the-code>What about the code?</a><ul><li><a href=#libraries-to-add>Libraries to add</a></li><li><a href=#what-about-the-code-1>What about the code?</a></li><li><a href=#the-java-agent>The Java Agent</a></li><li><a href=#how-is-made-the-glue-between-the-two-applications>How is made the glue between the two applications?</a></li></ul></li><li><a href=#dashboard>Dashboard</a></li></ul></li><li><a href=#tempo--grafana>Tempo & Grafana</a><ul><li><a href=#architecture-1>Architecture</a></li><li><a href=#collector-configuration>Collector configuration</a></li><li><a href=#tempo-configuration>Tempo configuration</a></li><li><a href=#grafana-configuration>Grafana configuration</a></li><li><a href=#dashboard-1>Dashboard</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Enhancing Asynchronous Transaction Monitoring: Implementing Distributed Tracing in Apache Camel Applications with OpenTelemetry</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class="author fas fa-user-circle fa-fw"></span><a href=https://blog.touret.info title=Author target=_blank rel="noopener noreferrer author" class=author>Alexandre Touret</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2023-09-05>2023-09-05</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2023-09-05>2023-09-05</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1923 words&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;10 minutes&nbsp;</div></div><div class=featured-image><img loading=eager src=/assets/images/2023/09/nick-fewings-4dI5OP2Ee64-unsplash.webp srcset="/assets/images/2023/09/nick-fewings-4dI5OP2Ee64-unsplash.webp, /assets/images/2023/09/nick-fewings-4dI5OP2Ee64-unsplash.webp 1.5x, /assets/images/2023/09/nick-fewings-4dI5OP2Ee64-unsplash.webp 2x" sizes=auto alt=/assets/images/2023/09/nick-fewings-4dI5OP2Ee64-unsplash.webp title=/assets/images/2023/09/nick-fewings-4dI5OP2Ee64-unsplash.webp height=auto width=auto></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#jaeger>Jaeger</a><ul><li><a href=#architecture>Architecture</a></li><li><a href=#opentelemetry-collector>OpenTelemetry Collector</a></li><li><a href=#what-about-the-code>What about the code?</a><ul><li><a href=#libraries-to-add>Libraries to add</a></li><li><a href=#what-about-the-code-1>What about the code?</a></li><li><a href=#the-java-agent>The Java Agent</a></li><li><a href=#how-is-made-the-glue-between-the-two-applications>How is made the glue between the two applications?</a></li></ul></li><li><a href=#dashboard>Dashboard</a></li></ul></li><li><a href=#tempo--grafana>Tempo & Grafana</a><ul><li><a href=#architecture-1>Architecture</a></li><li><a href=#collector-configuration>Collector configuration</a></li><li><a href=#tempo-configuration>Tempo configuration</a></li><li><a href=#grafana-configuration>Grafana configuration</a></li><li><a href=#dashboard-1>Dashboard</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div><div class=content id=content><div id=id-1><em>Picture Credit: <a href=https://unsplash.com/@jannerboy62 target=_blank rel="noopener noreferrer">Nick FEWINGS</a></em></div><h2 id=introduction class=headerLink><a href=#introduction class=header-mark></a>Introduction</h2><p>In today&rsquo;s dynamic landscape, Distributed Tracing has emerged as an indispensable practice.
It helps to understand what is under the hood of distributed transactions, providing answers to pivotal questions: What comprises these diverse requests? What contextual information accompanies them? How extensive is their duration?</p><p>Since the introduction of <a href=https://research.google/pubs/pub36356/ target=_blank rel="noopener noreferrer">Google&rsquo;s Dapper</a>, a plethora of tracing solutions has flooded the scene.
Among them, <a href=https://opentelemetry.io/ target=_blank rel="noopener noreferrer">OpenTelemetry</a> has risen as the frontrunner.
Other alternatives such as <a href=https://www.elastic.co/observability/application-performance-monitoring target=_blank rel="noopener noreferrer">Elastic APM</a> and <a href=https://www.dynatrace.com/support/help/observe-and-explore/purepath-distributed-traces/distributed-traces-overview target=_blank rel="noopener noreferrer">DynaTrace</a> are also available.</p><p>This toolkit seamlessly aligns with APIs and synchronous transactions, catering to a broad spectrum of scenarios.</p><p>However, what about asynchronous transactions?
The necessity for clarity becomes even more pronounced in such cases.
Particularly in architectures built upon messaging or event streaming brokers, attaining a holistic view of the entire transaction becomes arduous.</p><p>Why does this challenge arise?
It&rsquo;s a consequence of functional transactions fragmenting into two loosely coupled subprocesses:</p><div id=id-2><figure><a class=lightgallery href=/assets/images/2023/09/loose-coupling-sequence.svg title="OpenTelemetry Collector Architecture" data-thumbnail=/assets/images/2023/09/loose-coupling-sequence.svg><img loading=lazy src=/assets/images/2023/09/loose-coupling-sequence.svg srcset="/assets/images/2023/09/loose-coupling-sequence.svg, /assets/images/2023/09/loose-coupling-sequence.svg 1.5x, /assets/images/2023/09/loose-coupling-sequence.svg 2x" sizes=auto alt="OpenTelemetry Collector Architecture"></a></figure></div><p>Hopefully you can rope OpenTelemetry in it to shed light.</p><div class="details admonition info open"><div class="details-summary admonition-title"><i class="icon fas fa-info-circle fa-fw"></i>What about the main concepts of Distributed Tracing?<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>I will not dig into the concepts of Distributed tracing in this article.
<a href=https://blog.worldline.tech/2021/09/22/enabling_distributed_tracing_in_spring_apps.html target=_blank rel="noopener noreferrer">If you are interested in it, you can read my article on the Worldline Tech Blog</a>.</div></div></div><p>I will explain in this article how to set up and plug OpenTelementry to gather asynchronous transaction traces using <a href=https://camel.apache.org/ target=_blank rel="noopener noreferrer">Apache Camel</a> and <a href=https://activemq.apache.org/components/artemis/ target=_blank rel="noopener noreferrer">Artemis</a>.
The first part will use Jaeger and the second one, <a href=https://grafana.com/oss/tempo/ target=_blank rel="noopener noreferrer">Tempo</a> and <a href=https://grafana.com/ target=_blank rel="noopener noreferrer">Grafana</a> to be more <em>production ready</em>.</p><p>All the code snippets are part of <a href=https://GitHub.com/alexandre-touret/camel-artemis-opentelemetry target=_blank rel="noopener noreferrer">this project on GitHub</a>.
(Normally) you can use and run it locally on your desktop.</p><h2 id=jaeger class=headerLink><a href=#jaeger class=header-mark></a>Jaeger</h2><h3 id=architecture class=headerLink><a href=#architecture class=header-mark></a>Architecture</h3><p>The <a href=https://www.logicmonitor.com/blog/what-are-spans-in-distributed-tracing target=_blank rel="noopener noreferrer">SPANs</a> are broadcast and gathered through <a href=https://opentelemetry.io/docs/collector target=_blank rel="noopener noreferrer">OpenTelemetry Collector</a>.
It finally sends them to <a href=https://www.jaegertracing.io/ target=_blank rel="noopener noreferrer">Jaeger</a>.</p><p>Here is the architecture of such a platform:</p><div id=id-3><figure><a class=lightgallery href=/assets/images/2023/09/architecture.svg title="OpenTelemetry Collector Architecture" data-thumbnail=/assets/images/2023/09/architecture.svg><img loading=lazy src=/assets/images/2023/09/architecture.svg srcset="/assets/images/2023/09/architecture.svg, /assets/images/2023/09/architecture.svg 1.5x, /assets/images/2023/09/architecture.svg 2x" sizes=auto alt="OpenTelemetry Collector Architecture"></a></figure></div><h3 id=opentelemetry-collector class=headerLink><a href=#opentelemetry-collector class=header-mark></a>OpenTelemetry Collector</h3><p>The cornerstone of this architecture is the <a href=https://opentelemetry.io/docs/collector/ target=_blank rel="noopener noreferrer">collector</a>.
It can be compared to <a href=https://www.elastic.co/fr/logstash/ target=_blank rel="noopener noreferrer">Elastic LogStash</a> or an <a href=https://en.wikipedia.org/wiki/Extract,_transform,_load target=_blank rel="noopener noreferrer">ETL</a>.
It will help us get, transform and export telemetry data.</p><div id=id-4><p><figure><a class=lightgallery href=/assets/images/2023/09/otel-diagram.svg title="OpenTelemetry Collector Functionalities" data-thumbnail=/assets/images/2023/09/otel-diagram.svg data-sub-html="<h2>Source: https://opentelemetry.io/docs/collector/</h2><p>OpenTelemetry Collector Functionalities</p>"><img loading=lazy src=/assets/images/2023/09/otel-diagram.svg srcset="/assets/images/2023/09/otel-diagram.svg, /assets/images/2023/09/otel-diagram.svg 1.5x, /assets/images/2023/09/otel-diagram.svg 2x" sizes=auto alt="OpenTelemetry Collector Functionalities"></a><figcaption class=image-caption>Source: https://opentelemetry.io/docs/collector/</figcaption></figure></p></div><p>For our use case, the configuration is quite simple.</p><p>First, here is the <a href=https://opentelemetry.io/docs/collector/ target=_blank rel="noopener noreferrer">Docker Compose configuration</a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>otel-collector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>otel/opentelemetry-collector:0.75.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>otel-collector</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=s2>&#34;--config=/etc/otel-collector-config.yaml&#34;</span><span class=w> </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./docker/otel-collector-config.yaml:/etc/otel-collector-config.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;1888:1888&#34;</span><span class=w>   </span><span class=c># pprof extension</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;8888:8888&#34;</span><span class=w>   </span><span class=c># Prometheus metrics exposed by the collector</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;8889:8889&#34;</span><span class=w>   </span><span class=c># Prometheus exporter metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;13133:13133&#34;</span><span class=w> </span><span class=c># health_check extension</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;4317:4317&#34;</span><span class=w>   </span><span class=c># OTLP gRPC receiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;55670:55679&#34;</span><span class=w> </span><span class=c># zpages extension</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>and the <a href=https://github.com/alexandre-touret/camel-artemis-opentelemetry/blob/main/containers/docker/otel-collector-config.yaml target=_blank rel="noopener noreferrer"><code>otel-collector-config.yaml</code></a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># (1)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>otlp</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocols</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>grpc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0.0.0.0:4317&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0.0.0.0:4318&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>scrape_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;test&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>metrics_path</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;/actuator/prometheus&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>5s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;host.docker.internal:8080&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># (2)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#  prometheus:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#    endpoint: &#34;0.0.0.0:8889&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#    const_labels:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#      label1: value1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>logging</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jaeger</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=l>jaeger:14250</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>insecure</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#  zipkin:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#    endpoint: http://zipkin:9411/api/v2/spans</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#    tls:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#      insecure: true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># (3)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>batch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>health_check</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pprof</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=p>:</span><span class=m>1888</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>zpages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=p>:</span><span class=m>55679</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># (4)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>pprof, zpages, health_check]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>logging, jaeger]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>logging]</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>Short explanation</strong></p><p>If you want further information about this configuration, you <a href=https://opentelemetry.io/docs/collector/configuration/ target=_blank rel="noopener noreferrer">can browse the documentation</a>.</p><p>For those who are impatient, here are a short explanation of this configuration file:</p><ol><li>Where to pull data?</li><li>Where to store data?</li><li>What to do with it?</li><li>What are the workloads to activate?</li></ol><h3 id=what-about-the-code class=headerLink><a href=#what-about-the-code class=header-mark></a>What about the code?</h3><p>The configuration to apply is pretty simple and straightforward.
To cut long story short, you need to include libraries, add some configuration lines and run your application with an agent which will be responsible for broadcasting the SPANs.</p><h4 id=libraries-to-add class=headerLink><a href=#libraries-to-add class=header-mark></a>Libraries to add</h4><p>For an Apache Camel based Java application, you need to add this starter first:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;groupId&gt;</span>org.apache.camel.springboot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;artifactId&gt;</span>camel-opentelemetry-starter<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>In case you set up a <em>basic</em> <a href=https://spring.io/ target=_blank rel="noopener noreferrer">Spring Boot application</a>, you only have to configure the agent (<em>see below</em>).</p><h4 id=what-about-the-code-1 class=headerLink><a href=#what-about-the-code-1 class=header-mark></a>What about the code?</h4><p>This step is not mandatory.
However, if you are eager to get more details in your Jaeger dashboard, it is advised.</p><p>In the application class, you only have to put the <code>@CamelOpenTelemetry</code> annotation.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@CamelOpenTelemetry</span>
</span></span><span class=line><span class=cl><span class=nd>@SpringBootApplication</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DemoApplication</span> <span class=o>{</span>
</span></span><span class=line><span class=cl><span class=o>[...]</span>
</span></span></code></pre></td></tr></table></div></div><p>If you want more details, you can check <a href=https://camel.apache.org/components/3.20.x/others/opentelemetry.html target=_blank rel="noopener noreferrer">the official documentation</a>.</p><h4 id=the-java-agent class=headerLink><a href=#the-java-agent class=header-mark></a>The Java Agent</h4><p>The java agent is responsible for instrumenting Java 8+ code, capturing metrics and forwarding them to the collector.</p><p>In case you don&rsquo;t know what is a Java Agent, I recommend watching <a href="https://www.youtube.com/watch?v=oflzFGONG08" target=_blank rel="noopener noreferrer">this conference</a>.</p><p><a href=https://github.com/open-telemetry/opentelemetry-java-instrumentation target=_blank rel="noopener noreferrer">Its documentation is available on GitHub</a>.
The detailed list of configuration parameters <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/agent-config/ target=_blank rel="noopener noreferrer">is available here</a>.
You can configure it through environment, system variables or a <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/agent-config/#configuration-file target=_blank rel="noopener noreferrer">configuration file</a>.</p><p>For instance, by default, the OpenTelemetry Collector default endpoint value is <code>http://localhost:4317</code>.
You can alter it by setting the <code>OTEL_EXPORTER_OTLP_METRICS_ENDPOINT</code> environment variable or the <code>otel.exporter.otlp.metrics.endpoint</code> java system variable (e.g., using <code>-Dotel.exporter.otlp.metrics.endpoint</code> option ).</p><p>In my example, we use Maven configuration to download the agent JAR file and run our application with it as an agent.</p><p><strong>Example of configuration</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;profile&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;id&gt;</span>opentelemetry<span class=nt>&lt;/id&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;activation&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;property&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;name&gt;</span>apm<span class=nt>&lt;/name&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;value&gt;</span>otel<span class=nt>&lt;/value&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/property&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/activation&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;build&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;plugins&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;plugin&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;groupId&gt;</span>org.apache.maven.plugins<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;artifactId&gt;</span>maven-dependency-plugin<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;executions&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;execution&gt;</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&lt;id&gt;</span>copy-javaagent<span class=nt>&lt;/id&gt;</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&lt;phase&gt;</span>process-resources<span class=nt>&lt;/phase&gt;</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&lt;goals&gt;</span>
</span></span><span class=line><span class=cl>                            <span class=nt>&lt;goal&gt;</span>copy<span class=nt>&lt;/goal&gt;</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&lt;/goals&gt;</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&lt;configuration&gt;</span>
</span></span><span class=line><span class=cl>                            <span class=nt>&lt;artifactItems&gt;</span>
</span></span><span class=line><span class=cl>                                <span class=nt>&lt;artifactItem&gt;</span>
</span></span><span class=line><span class=cl>                                    <span class=nt>&lt;groupId&gt;</span>io.opentelemetry.javaagent<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>                                    <span class=nt>&lt;artifactId&gt;</span>opentelemetry-javaagent<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>                                    <span class=nt>&lt;version&gt;</span>${opentelemetry-agent.version}<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>                                    <span class=nt>&lt;overWrite&gt;</span>true<span class=nt>&lt;/overWrite&gt;</span>
</span></span><span class=line><span class=cl>                                    <span class=nt>&lt;outputDirectory&gt;</span>${project.build.directory}/javaagents<span class=nt>&lt;/outputDirectory&gt;</span>
</span></span><span class=line><span class=cl>                                    <span class=nt>&lt;destFileName&gt;</span>javaagent.jar<span class=nt>&lt;/destFileName&gt;</span>
</span></span><span class=line><span class=cl>                                <span class=nt>&lt;/artifactItem&gt;</span>
</span></span><span class=line><span class=cl>                            <span class=nt>&lt;/artifactItems&gt;</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&lt;/configuration&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;/execution&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;/executions&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/plugin&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;plugin&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;artifactId&gt;</span>spring-boot-maven-plugin<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;configuration&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;agents&gt;</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&lt;agent&gt;</span>${project.build.directory}/javaagents/javaagent.jar<span class=nt>&lt;/agent&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;/agents&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=c>&lt;!--                    &lt;systemPropertyVariables&gt;--&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=c>&lt;!--                        &lt;otel.traces.sampler&gt;parentbased_traceidratio&lt;/otel.traces.sampler&gt;--&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=c>&lt;!--                        &lt;otel.traces.sampler.arg&gt;0.2&lt;/otel.traces.sampler.arg&gt;--&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=c>&lt;!--                    &lt;/systemPropertyVariables&gt;--&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;/configuration&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/plugin&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/plugins&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/build&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/profile&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>The variables in comment (e.g., <code>otel.traces.sampler</code>) can be turned on if you want <a href=https://opentelemetry.io/docs/concepts/sampling/ target=_blank rel="noopener noreferrer">to sample your forwarded data based on a head rate limiting</a>.</p><p>Before running the whole application (<a href=https://github.com/alexandre-touret/camel-artemis-opentelemetry/tree/main/gateway target=_blank rel="noopener noreferrer">gateway</a>, <a href=https://github.com/alexandre-touret/camel-artemis-opentelemetry/tree/main/camel-producer target=_blank rel="noopener noreferrer">producer</a>,<a href=https://github.com/alexandre-touret/camel-artemis-opentelemetry/tree/main/camel-consumer target=_blank rel="noopener noreferrer">consumer</a>), you must ramp up the infrastructure with <a href=https://docs.docker.com/compose/ target=_blank rel="noopener noreferrer">Docker compose</a>.
The source is available <a href=https://github.com/alexandre-touret/camel-artemis-opentelemetry/blob/main/containers/docker-compose.yml target=_blank rel="noopener noreferrer">here</a>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cd containers
</span></span><span class=line><span class=cl>docker compose up
</span></span></code></pre></td></tr></table></div></div><p>You can now start both the producer and the consumer:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>mvn clean spring-boot:run -Popentelemetry -f camel-producer/pom.xml
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>mvn clean spring-boot:run -Popentelemetry -f camel-consumer/pom.xml
</span></span></code></pre></td></tr></table></div></div><p>The gateway can also be turned on and instrumented in the same way.
You can run it as:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>mvn clean spring-boot:run -Popentelemetry -f gateway/pom.xml
</span></span></code></pre></td></tr></table></div></div><h4 id=how-is-made-the-glue-between-the-two-applications class=headerLink><a href=#how-is-made-the-glue-between-the-two-applications class=header-mark></a>How is made the glue between the two applications?</h4><p>The correlation is simply done using headers.
For instance, in the consumer application, when we consume the messages as:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=n>from</span><span class=o>(</span><span class=s>&#34;activemq:queue:HELLO.WORLD?disableReplyTo=true&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>routeId</span><span class=o>(</span><span class=s>&#34;consume-message&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>routeDescription</span><span class=o>(</span><span class=s>&#34;Consumer example&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>log</span><span class=o>(</span><span class=n>LoggingLevel</span><span class=o>.</span><span class=na>INFO</span><span class=o>,</span> <span class=s>&#34;New message with trace=${header.traceparent}&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>log</span><span class=o>(</span><span class=s>&#34;----&gt; &#34;</span><span class=o>+</span><span class=n>bodyAs</span><span class=o>(</span><span class=n>String</span><span class=o>.</span><span class=na>class</span><span class=o>).</span><span class=na>toString</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>log</span><span class=o>(</span><span class=s>&#34;HEADERS ${in.headers}&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>end</span><span class=o>();</span>
</span></span></code></pre></td></tr></table></div></div><p>I logged on purpose the <code>traceparent</code> header.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl> New message with trace=00-1a4f6943b7ace96d7efae4c4404009d8-cfbdb98266a772d7-01
</span></span></code></pre></td></tr></table></div></div><p>It allows to Jaeger to correlate our two transactions.</p><p>For your information, here are all the headers available while consuming the message</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=err>__AMQ_CID=ID:XXXX-0:1,</span> 
</span></span><span class=line><span class=cl>  <span class=err>accept=*/*,</span> 
</span></span><span class=line><span class=cl>  <span class=err>accept-encoding=gzip,</span> 
</span></span><span class=line><span class=cl>  <span class=err>deflate,</span> 
</span></span><span class=line><span class=cl>  <span class=err>CamelHttpCharacterEncoding=UTF-8,</span> 
</span></span><span class=line><span class=cl>  <span class=err>CamelHttpMethod=GET,</span> 
</span></span><span class=line><span class=cl>  <span class=err>CamelHttpPath=,</span> 
</span></span><span class=line><span class=cl>  <span class=err>CamelHttpUri=/camel/test,</span> 
</span></span><span class=line><span class=cl>  <span class=err>CamelHttpUrl=http:</span><span class=c1>//127.0.0.1:8080/camel/test, 
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=err>CamelMessageTimestamp=1693567851901,</span>
</span></span><span class=line><span class=cl>  <span class=err>CamelServletContextPath=/test,</span>
</span></span><span class=line><span class=cl>  <span class=err>content-length=0,</span> 
</span></span><span class=line><span class=cl>  <span class=err>forwarded=proto=http;host=</span><span class=nt>&#34;localhost:9080&#34;</span><span class=err>;for=</span><span class=s2>&#34;127.0.0.1:39352&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>  <span class=err>host=127.0.0.1:8080,</span> 
</span></span><span class=line><span class=cl>  <span class=err>JMSCorrelationID=null,</span> 
</span></span><span class=line><span class=cl>  <span class=err>JMSCorrelationIDAsBytes=null,</span> 
</span></span><span class=line><span class=cl>  <span class=err>JMSDeliveryMode=2,</span> 
</span></span><span class=line><span class=cl>  <span class=err>JMSDestination=queue:</span><span class=c1>//HELLO.WORLD, 
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=err>JMSExpiration=0,</span> 
</span></span><span class=line><span class=cl>  <span class=err>JMSMessageID=ID:XXXX-1:1:1:1:75,</span> 
</span></span><span class=line><span class=cl>  <span class=err>JMSPriority=4,</span> 
</span></span><span class=line><span class=cl>  <span class=err>JMSRedelivered=false,</span> 
</span></span><span class=line><span class=cl>  <span class=err>JMSReplyTo=null,</span> 
</span></span><span class=line><span class=cl>  <span class=err>JMSTimestamp=1693567851901,</span> 
</span></span><span class=line><span class=cl>  <span class=err>JMSType=null,</span> 
</span></span><span class=line><span class=cl>  <span class=err>JMSXGroupID=null,</span> 
</span></span><span class=line><span class=cl>  <span class=err>JMSXUserID=null,</span> 
</span></span><span class=line><span class=cl>  <span class=err>traceparent=00-dea6abbd4357819b7416236bab19e557-8840b18dd799cfac-01,</span> 
</span></span><span class=line><span class=cl>  <span class=err>user-agent=HTTPie/1.0.3,</span> 
</span></span><span class=line><span class=cl>  <span class=err>x-forwarded-for=127.0.0.1,</span> 
</span></span><span class=line><span class=cl>  <span class=err>x-forwarded-host=localhost:9080,</span> 
</span></span><span class=line><span class=cl>  <span class=err>x-forwarded-port=9080,</span> 
</span></span><span class=line><span class=cl>  <span class=err>x-forwarded-proto=http</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=dashboard class=headerLink><a href=#dashboard class=header-mark></a>Dashboard</h3><p>To get traces, I ran this dumb command to inject traces into Jaeger:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>while true ; http :9080/camel/test; end
</span></span></code></pre></td></tr></table></div></div><p>Now, you can browse Jaeger (<a href=http://localhost:16686 target=_blank rel="noopener noreferrer">http://localhost:16686</a>) and query it to find trace insights:</p><div id=id-5><p><figure><a class=lightgallery href=/assets/images/2023/09/jaeger-1.webp title="Jaeger front page" data-thumbnail=/assets/images/2023/09/jaeger-1.webp data-sub-html="<h2>Number of different apps</h2><p>Jaeger front page</p>"><img loading=lazy src=/assets/images/2023/09/jaeger-1.webp srcset="/assets/images/2023/09/jaeger-1.webp, /assets/images/2023/09/jaeger-1.webp 1.5x, /assets/images/2023/09/jaeger-1.webp 2x" sizes=auto alt="Jaeger front page"></a><figcaption class=image-caption>Number of different apps</figcaption></figure></p></div><p>If you dig into one transaction, you will see the whole transaction:</p><div id=id-6><p><figure><a class=lightgallery href=/assets/images/2023/09/jaeger-2.webp title="Jaeger transaction page" data-thumbnail=/assets/images/2023/09/jaeger-2.webp data-sub-html="<h2>One transaction</h2><p>Jaeger transaction page</p>"><img loading=lazy src=/assets/images/2023/09/jaeger-2.webp srcset="/assets/images/2023/09/jaeger-2.webp, /assets/images/2023/09/jaeger-2.webp 1.5x, /assets/images/2023/09/jaeger-2.webp 2x" sizes=auto alt="Jaeger transaction page"></a><figcaption class=image-caption>One transaction</figcaption></figure></p></div><p>And now, you can correlate two sub transactions:</p><div id=id-7><p><figure><a class=lightgallery href=/assets/images/2023/09/jaeger-3.webp title="Jaeger two sub transactions" data-thumbnail=/assets/images/2023/09/jaeger-3.webp data-sub-html="<h2>Two sub transactions</h2><p>Jaeger two sub transactions</p>"><img loading=lazy src=/assets/images/2023/09/jaeger-3.webp srcset="/assets/images/2023/09/jaeger-3.webp, /assets/images/2023/09/jaeger-3.webp 1.5x, /assets/images/2023/09/jaeger-3.webp 2x" sizes=auto alt="Jaeger two sub transactions"></a><figcaption class=image-caption>Two sub transactions</figcaption></figure></p></div><h2 id=tempo--grafana class=headerLink><a href=#tempo--grafana class=header-mark></a>Tempo & Grafana</h2><p>This solution is pretty similar to the previous one.
Instead of pushing all the data to Jaeger, we will use Tempo to store data and Grafana to render them.
We don&rsquo;t need to modify the configuration made in the existing Java applications.</p><h3 id=architecture-1 class=headerLink><a href=#architecture-1 class=header-mark></a>Architecture</h3><p>As mentioned above, the architecture is quite the same.
Now, we have the collector which broadcast data to Tempo.
We will then configure Grafana to query to it to get traces.</p><div id=id-8><figure><a class=lightgallery href=/assets/images/2023/09/architecture_grafana.svg title="Architecture w/ Grafana &amp;amp; Tempo" data-thumbnail=/assets/images/2023/09/architecture_grafana.svg><img loading=lazy src=/assets/images/2023/09/architecture_grafana.svg srcset="/assets/images/2023/09/architecture_grafana.svg, /assets/images/2023/09/architecture_grafana.svg 1.5x, /assets/images/2023/09/architecture_grafana.svg 2x" sizes=auto alt="Architecture w/ Grafana &amp;amp; Tempo"></a></figure></div><h3 id=collector-configuration class=headerLink><a href=#collector-configuration class=header-mark></a>Collector configuration</h3><p>The modification of the Collector is easy (for this example).
We only have to specify the tempo URL.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>otlp</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocols</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>grpc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0.0.0.0:4317&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0.0.0.0:4318&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>scrape_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;test&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>metrics_path</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;/actuator/prometheus&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>5s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;host.docker.internal:8080&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>otlp</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=l>tempo:4317</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>insecure</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp]</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=tempo-configuration class=headerLink><a href=#tempo-configuration class=header-mark></a>Tempo configuration</h3><p>I used here <a href=https://github.com/grafana/tempo target=_blank rel="noopener noreferrer">the standard configuration provided in the documentation</a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>http_listen_port</span><span class=p>:</span><span class=w> </span><span class=m>3200</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>distributor</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>receivers</span><span class=p>:</span><span class=w>                           </span><span class=c># this configuration will listen on all ports and protocols that tempo is capable of.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>jaeger</span><span class=p>:</span><span class=w>                            </span><span class=c># the receives all come from the OpenTelemetry collector.  more configuration information can</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>protocols:                       # be found there</span><span class=p>:</span><span class=w> </span><span class=l>https://github.com/open-telemetry/opentelemetry-collector/tree/main/receiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>thrift_http</span><span class=p>:</span><span class=w>                   </span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>grpc</span><span class=p>:</span><span class=w>                          </span><span class=c># for a production deployment you should only enable the receivers you need!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>thrift_binary</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>thrift_compact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>zipkin</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>otlp</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>protocols</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>grpc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>opencensus</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ingester</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>max_block_duration</span><span class=p>:</span><span class=w> </span><span class=l>5m              </span><span class=w> </span><span class=c># cut the headblock when this much time passes. this is being set for demo purposes and should probably be left alone normally</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>compactor</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>compaction</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>block_retention</span><span class=p>:</span><span class=w> </span><span class=l>1h               </span><span class=w> </span><span class=c># overall Tempo trace retention. set for demo purposes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metrics_generator</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>registry</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>external_labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>source</span><span class=p>:</span><span class=w> </span><span class=l>tempo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cluster</span><span class=p>:</span><span class=w> </span><span class=l>docker-compose</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storage</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/tempo/generator/wal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>remote_write</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>http://prometheus:9090/api/v1/write</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>send_exemplars</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>storage</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>trace</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>backend</span><span class=p>:</span><span class=w> </span><span class=l>local                    </span><span class=w> </span><span class=c># backend configuration to use</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>wal</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/tempo/wal            </span><span class=w> </span><span class=c># where to store the wal locally</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>local</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/tempo/blocks</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>overrides</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metrics_generator_processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>service-graphs, span-metrics]</span><span class=w> </span><span class=c># enables metrics generator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>search_enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=grafana-configuration class=headerLink><a href=#grafana-configuration class=header-mark></a>Grafana configuration</h3><p>Now we must configure Grafana to enable querying into our tempo instance.
The configuration is made here using a configuration file provided during the startup</p><p>The datasource file:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>datasources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Prometheus backend where metrics are sent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>http://prometheus:9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>jsonData</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>httpMethod</span><span class=p>:</span><span class=w> </span><span class=l>GET</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Tempo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>tempo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>tempo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>http://tempo:3200</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>jsonData</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>httpMethod</span><span class=p>:</span><span class=w> </span><span class=l>GET</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>serviceMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>datasourceUid</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;prometheus&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=dashboard-1 class=headerLink><a href=#dashboard-1 class=header-mark></a>Dashboard</h3><p>As we have done before, we must start the infrastructure using Docker Compose:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cd containers
</span></span><span class=line><span class=cl>docker compose -f docker-compose-grafana.yml up
</span></span></code></pre></td></tr></table></div></div><p>Then, using the same rocket scientist maven commands, we can run the same commands and browse now Grafana (<code>http://localhost:3000</code>) to see our traces:</p><p><div id=id-9><p><figure><a class=lightgallery href=/assets/images/2023/09/grafana-1.webp title="Grafana transactions" data-thumbnail=/assets/images/2023/09/grafana-1.webp data-sub-html="<h2>Transactions</h2><p>Grafana transactions</p>"><img loading=lazy src=/assets/images/2023/09/grafana-1.webp srcset="/assets/images/2023/09/grafana-1.webp, /assets/images/2023/09/grafana-1.webp 1.5x, /assets/images/2023/09/grafana-1.webp 2x" sizes=auto alt="Grafana transactions"></a><figcaption class=image-caption>Transactions</figcaption></figure></p></div><div id=id-10><p><figure><a class=lightgallery href=/assets/images/2023/09/grafana-2.webp title="Grafana transactions" data-thumbnail=/assets/images/2023/09/grafana-2.webp data-sub-html="<h2>Deep dive into one transaction</h2><p>Grafana transactions</p>"><img loading=lazy src=/assets/images/2023/09/grafana-2.webp srcset="/assets/images/2023/09/grafana-2.webp, /assets/images/2023/09/grafana-2.webp 1.5x, /assets/images/2023/09/grafana-2.webp 2x" sizes=auto alt="Grafana transactions"></a><figcaption class=image-caption>Deep dive into one transaction</figcaption></figure></p></div></p><h2 id=conclusion class=headerLink><a href=#conclusion class=header-mark></a>Conclusion</h2><p>We saw how to highlight asynchronous transactions and correlate them through OpenTelemetry and Jaeger or using Tempo & Grafana.
It was voluntarily simple.</p><p>If you want to dig into <a href=https://github.com/open-telemetry/opentelemetry-collector/ target=_blank rel="noopener noreferrer">OpenTelemetry Collector</a> configuration, you can read <a href=https://signoz.io/blog/opentelemetry-collector-complete-guide/ target=_blank rel="noopener noreferrer">this article from Antik ANAND</a> (Thanks to <a href=https://blog.frankel.ch/ target=_blank rel="noopener noreferrer">Nicolas FRANKËL</a> for sharing it) and the <a href=https://github.com/open-telemetry/opentelemetry-collector/ target=_blank rel="noopener noreferrer">official documentation</a>.
A noteworthy aspect of <a href=https://github.com/open-telemetry/ target=_blank rel="noopener noreferrer">OpenTelemetry</a> lies in its evolution into an industry-standard over time.
For instance,<a href=https://www.elastic.co/observability/application-performance-monitoring target=_blank rel="noopener noreferrer">Elastic APM</a> <a href=https://www.elastic.co/guide/en/apm/guide/current/open-telemetry.html target=_blank rel="noopener noreferrer">is compatible with it</a>.</p><p>I then exposed how to enable this feature on Apache Camel applications.
It can be easily reproduced <a href=https://opentelemetry.io/docs/instrumentation/ target=_blank rel="noopener noreferrer">with several stacks</a>.</p><p>Last but not least, which solution is the best?</p><p>I have not made any benchmark of Distributed Tracing solutions.
However, for a <em>real life</em> production setup, I would dive into Grafana and Tempo and check their features.
I am particularly interested in mixing logs, traces to orchestrate efficient alerting mechanisms.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-09-05&nbsp;<a class=git-hash href=https://github.com/alexandre-touret/alexandre-touret.github.io/commit/9a490dce245dc7ce1bcaf407d4f7a33680abaad7 target=_blank title="commit by Alexandre Touret(alexandre-touret@users.noreply.github.com) 9a490dce245dc7ce1bcaf407d4f7a33680abaad7: change date" rel="noopener noreferrer">
<i class="fas fa-hashtag fa-fw"></i>9a490dc</a></span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-mardown href=/en/2023/09/05/distributed-tracing-opentelemetry-camel-artemis/index.md target=_blank rel="noopener noreferrer">Read markdown</a></span></div><div class=post-info-share><button title="Share on Twitter" data-sharer=twitter data-url=http://blog.touret.info/en/2023/09/05/distributed-tracing-opentelemetry-camel-artemis/ data-title="Enhancing Asynchronous Transaction Monitoring: Implementing Distributed Tracing in Apache Camel Applications with OpenTelemetry" data-via=touret_alex data-hashtags=OpenTelemetry,Java,Camel,Artemis,Grafana,Tempo><span class="fab fa-twitter fa-fw"></span></button><button title="Share on Linkedin" data-sharer=linkedin data-url=http://blog.touret.info/en/2023/09/05/distributed-tracing-opentelemetry-camel-artemis/><span class="fab fa-linkedin fa-fw"></span></button><button title="Share on Hacker News" data-sharer=hackernews data-url=http://blog.touret.info/en/2023/09/05/distributed-tracing-opentelemetry-camel-artemis/ data-title="Enhancing Asynchronous Transaction Monitoring: Implementing Distributed Tracing in Apache Camel Applications with OpenTelemetry"><span class="fab fa-hacker-news fa-fw"></span></button></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/en/tags/opentelemetry/>OpenTelemetry</a>,&nbsp;<a href=/en/tags/java/>Java</a>,&nbsp;<a href=/en/tags/camel/>Camel</a>,&nbsp;<a href=/en/tags/artemis/>Artemis</a>,&nbsp;<a href=/en/tags/grafana/>Grafana</a>,&nbsp;<a href=/en/tags/tempo/>Tempo</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/en/>Home</a></span></section></div><div class=post-nav><a href=/en/2023/07/21/fish-shell/ class=prev rel=prev title="Moving on to Fish shell (and beyond)"><i class="fas fa-angle-left fa-fw"></i>Moving on to Fish shell (and beyond)</a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><a rel=me href=https://piaille.fr/@alexandre></a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://blog.touret.info target=_blank rel="noopener noreferrer">Alexandre Touret</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by/4.0/ target=_blank>CC BY 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery.js@1.4.0/dist/css/lightgallery.min.css><link rel=stylesheet href=/css/fced1a.min.css><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"comment",lightTheme:"github-light",repo:"alexandre-touret/alexandre-touret.github.io"}},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},search:{distance:null,findAllMatches:null,fuseIndexURL:"/en/index.json",highlightTag:"em",ignoreFieldNorm:null,ignoreLocation:null,isCaseSensitive:null,location:null,maxResultLength:10,minMatchCharLength:null,noResultsFound:"No results found",snippetLength:50,threshold:null,type:"fuse",useExtendedSearch:null},sharerjs:!0,twemoji:!0}</script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/twemoji@13.1.0/dist/twemoji.min.js defer></script><script type=text/javascript src=/js/twemoji.min.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery.js@1.4.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-zoom.js@1.3.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.2/sharer.min.js></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=/js/utterances.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F1EK89MHJD",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-F1EK89MHJD" async></script></div></body></html>